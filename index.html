<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIMS — Dharavi Infrastructure Management System</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* ── RESET & BASE ── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#06090d;--bg-p:#0a0f14;--bg-c:#0e151c;--bg-h:#131d26;
  --b:#182330;--b2:#243548;
  --ac:#00c8ff;--ac2:#0077aa;--acg:rgba(0,200,255,.12);
  --gr:#00e676;--grd:rgba(0,230,118,.1);
  --am:#ffb300;--amd:rgba(255,179,0,.12);
  --rd:#ff3d3d;--rdd:rgba(255,61,61,.12);
  --tx:#ddeeff;--tx2:#6a90aa;--tx3:#2a4460;
  --mn:'JetBrains Mono',monospace;--dp:'Syne',sans-serif;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--tx);font-family:var(--mn);font-size:12px;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px;}

/* ── HEADER ── */
#hdr{
  height:48px;display:flex;align-items:center;justify-content:space-between;
  padding:0 18px;background:var(--bg-p);border-bottom:1px solid var(--b);
  flex-shrink:0;position:relative;z-index:100;
}
.hlg{display:flex;align-items:center;gap:12px;}
.hlm{width:28px;height:28px;display:grid;grid-template-columns:1fr 1fr;gap:2px;padding:3px;border:1.5px solid var(--ac);position:relative;}
.hlm::after{content:'';position:absolute;inset:-3px;border:1px solid var(--b2);}
.lc{background:var(--ac2)}.lc:nth-child(2){background:var(--ac)}.lc:nth-child(3){background:transparent;border:1px solid var(--ac2)}.lc:nth-child(4){background:var(--ac2)}
.hname{font-family:var(--dp);font-size:14px;font-weight:800;letter-spacing:.06em;}
.hsub{font-size:8px;color:var(--tx2);letter-spacing:.2em;text-transform:uppercase;}
.hctr{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;font-size:9px;color:var(--tx2);letter-spacing:.15em;}
.ldot{width:6px;height:6px;border-radius:50%;background:var(--gr);animation:lp 2s infinite;}
@keyframes lp{0%,100%{box-shadow:0 0 6px var(--gr);opacity:1;}50%{opacity:.4;box-shadow:none;}}
.hrgt{display:flex;align-items:center;gap:16px;}
.hst{text-align:right;font-size:9px;color:var(--tx2);}
.hst b{display:block;font-size:13px;font-weight:700;letter-spacing:.05em;font-variant-numeric:tabular-nums;}
#htime{font-size:13px;font-weight:500;letter-spacing:.1em;font-variant-numeric:tabular-nums;}

/* ── NAV TABS ── */
#nav{display:flex;align-items:center;background:var(--bg-p);border-bottom:1px solid var(--b);padding:0 18px;flex-shrink:0;}
.ntab{padding:9px 16px;font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;user-select:none;}
.ntab:hover{color:var(--tx2);}
.ntab.on{color:var(--ac);border-bottom-color:var(--ac);}
.nsep{width:1px;height:20px;background:var(--b);margin:0 8px;}
.sbtn{margin-left:auto;padding:6px 14px;background:transparent;border:1px solid var(--rd);color:var(--rd);font-family:var(--mn);font-size:9px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;transition:all .2s;}
.sbtn:hover{background:var(--rdd);}
.sbtn.run{border-color:var(--am);color:var(--am);animation:bp 1s infinite;}
@keyframes bp{0%,100%{opacity:1;}50%{opacity:.5;}}

/* ── APP SHELL ── */
#app{display:flex;flex-direction:column;height:calc(100vh - 96px);overflow:hidden;}
.scr{display:none;flex:1;overflow:hidden;}
.scr.on{display:flex;}

/* ════════════════
   SCREEN 1: CC
════════════════ */
#s1{flex-direction:column;}
.cctop{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--b);border-bottom:1px solid var(--b);flex-shrink:0;}
.ccst{background:var(--bg-p);padding:12px 16px;}
.ccst-lbl{font-size:8px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);margin-bottom:3px;}
.ccst-val{font-size:22px;font-weight:700;font-family:var(--dp);font-variant-numeric:tabular-nums;letter-spacing:-.02em;}
.ccst-sub{font-size:8px;color:var(--tx2);margin-top:2px;}
.c-ac{color:var(--ac)}.c-gr{color:var(--gr)}.c-am{color:var(--am)}.c-rd{color:var(--rd)}
.ccbody{display:flex;flex:1;overflow:hidden;}
.ccgrid-wrap{flex:1;overflow-y:auto;padding:14px;}
.ccgrid-title{font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.ccgrid-title::after{content:'';flex:1;height:1px;background:var(--b);}
#bgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(66px,1fr));gap:5px;}
.bc{background:var(--bg-c);border:1px solid var(--b);padding:7px 6px;cursor:pointer;transition:all .2s;position:relative;display:flex;flex-direction:column;gap:3px;}
.bc:hover{border-color:var(--b2);transform:translateY(-1px);}
.bc.warn{border-color:rgba(255,179,0,.35);background:rgba(255,179,0,.04);}
.bc.alert{border-color:rgba(255,61,61,.4);background:rgba(255,61,61,.05);animation:cp 1.5s infinite;}
@keyframes cp{0%,100%{box-shadow:0 0 0 0 rgba(255,61,61,.3);}50%{box-shadow:0 0 0 3px rgba(255,61,61,0);}}
.bc.sim{border-color:rgba(255,179,0,.6)!important;animation:cs .8s infinite!important;}
@keyframes cs{0%,100%{background:rgba(255,179,0,.05);}50%{background:rgba(255,179,0,.14);}}
.bdot{width:5px;height:5px;border-radius:50%;position:absolute;top:5px;right:5px;}
.bdot.ok{background:var(--gr)}.bdot.warn{background:var(--am)}.bdot.alert{background:var(--rd);animation:lp 1s infinite;}
.bid{font-size:9px;font-weight:700;color:var(--tx2);}
.bfl{font-size:8px;color:var(--tx3);}
.bbar{height:2px;border-radius:1px;margin-top:1px;}
.bbar.ok{background:var(--gr)}.bbar.warn{background:var(--am)}.bbar.alert{background:var(--rd);}
.cclog{width:270px;background:var(--bg-p);border-left:1px solid var(--b);display:flex;flex-direction:column;flex-shrink:0;}
.cclog-hd{padding:10px 14px;border-bottom:1px solid var(--b);font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);flex-shrink:0;}
#evlog{flex:1;overflow-y:auto;padding:8px;}
.ev{padding:7px 9px;margin-bottom:3px;border:1px solid var(--b);background:var(--bg-c);animation:si .3s ease both;}
@keyframes si{from{opacity:0;transform:translateX(8px);}to{opacity:1;transform:none;}}
.ev-top{display:flex;justify-content:space-between;margin-bottom:3px;}
.ev-type{font-size:8px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;}
.ev-type.ok{color:var(--gr)}.ev-type.warn{color:var(--am)}.ev-type.alert{color:var(--rd);}
.ev-time{font-size:8px;color:var(--tx3);}
.ev-msg{font-size:9px;color:var(--tx2);line-height:1.4;}
.ev-asset{font-size:8px;color:var(--tx3);margin-top:2px;}

/* ════════════════
   SCREEN 2: DETAIL
════════════════ */
#s2{flex-direction:row;}
.dnav{width:210px;background:var(--bg-p);border-right:1px solid var(--b);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.dpnl-hd{padding:10px 14px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.dpnl-t{font-family:var(--dp);font-size:10px;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--tx2);}
.atag{font-size:8px;color:var(--tx3);padding:2px 6px;border:1px solid var(--b);background:var(--bg-c);}
.dnav-body{padding:10px;flex:1;overflow-y:auto;}
.slbl{font-size:8px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);margin:10px 0 4px;}
.slbl:first-child{margin-top:0;}
select{width:100%;background:var(--bg-c);border:1px solid var(--b);color:var(--tx);font-family:var(--mn);font-size:10px;padding:7px 24px 7px 9px;cursor:pointer;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%236a90aa' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;transition:border-color .2s;}
select:hover{border-color:var(--b2);}select option{background:var(--bg-c);}
.lbtn{width:100%;margin-top:12px;padding:9px;background:transparent;border:1px solid var(--ac2);color:var(--ac);font-family:var(--mn);font-size:10px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.lbtn::before{content:'';position:absolute;left:-100%;top:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,var(--acg),transparent);transition:left .4s;}
.lbtn:hover{border-color:var(--ac);background:var(--acg);}
.lbtn:hover::before{left:100%;}
.lbtn:disabled{opacity:.3;cursor:not-allowed;}
.ndiv{height:1px;background:var(--b);margin:10px 0;}
.bsr{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--b);}
.bsr:last-child{border:none;}
.bsk{font-size:9px;color:var(--tx2);}
.bsv{font-size:9px;font-weight:600;}
.s-ok{color:var(--gr)}.s-warn{color:var(--am)}.s-al{color:var(--rd);animation:bk 1s infinite;}
@keyframes bk{0%,100%{opacity:1;}50%{opacity:.3;}}
.dview{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);position:relative;}
.vbar{height:38px;background:var(--bg-p);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:0 14px;flex-shrink:0;}
.bc-path{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--tx2);}
.bc-sep{color:var(--tx3)}.bc-act{color:var(--ac);font-weight:500;}
.vctrls{display:flex;gap:4px;}
.vc{padding:3px 9px;background:var(--bg-c);border:1px solid var(--b);color:var(--tx2);font-family:var(--mn);font-size:8px;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .15s;}
.vc:hover,.vc.on{border-color:var(--ac2);color:var(--ac);}
#cv3d{flex:1;display:block;cursor:grab;}
#cv3d:active{cursor:grabbing;}
.vov{position:absolute;bottom:12px;left:12px;display:flex;gap:6px;}
.vch{padding:3px 9px;background:rgba(6,9,13,.85);border:1px solid var(--b2);font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:var(--tx2);backdrop-filter:blur(4px);}
.vch b{color:var(--ac);font-weight:500;}
#evw{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--tx3);font-size:10px;letter-spacing:.15em;}
.eag{display:grid;grid-template-columns:repeat(5,1fr);gap:2px;width:60px;height:60px;opacity:.25;}
.eac{background:var(--b);animation:sh 2s infinite;}
.eac:nth-child(odd){animation-delay:.3s;}.eac:nth-child(3n){animation-delay:.6s;}
@keyframes sh{0%,100%{opacity:.3;}50%{opacity:1;}}
.drgt{width:290px;background:var(--bg-p);border-left:1px solid var(--b);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.dtabs{display:flex;border-bottom:1px solid var(--b);flex-shrink:0;}
.dtab{flex:1;padding:9px 4px;text-align:center;font-size:8px;letter-spacing:.15em;text-transform:uppercase;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;}
.dtab:hover{color:var(--tx2)}.dtab.on{color:var(--ac);border-bottom-color:var(--ac);}
.dtbody{flex:1;overflow-y:auto;padding:10px;}
.tp{display:none;}.tp.on{display:block;}
.stitle{font-family:var(--dp);font-size:8px;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--b);}
.stitle:first-child{margin-top:0;}
.pc{background:var(--bg-c);border:1px solid var(--b);padding:8px 10px;margin-bottom:4px;cursor:pointer;transition:all .15s;position:relative;animation:fu .25s ease both;}
.pc::before{content:'';position:absolute;left:0;top:0;width:2px;height:100%;background:var(--b);transition:background .2s;}
.pc:hover,.pc.sel{background:var(--bg-h);border-color:var(--b2);}
.pc:hover::before,.pc.sel::before{background:var(--ac);}
.pc.pw::before{background:var(--am)}.pc.pw{border-color:rgba(255,179,0,.3);}
.pc.pa::before{background:var(--rd);animation:bk 1s infinite;}.pc.pa{border-color:rgba(255,61,61,.3);}
@keyframes fu{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.pc-top{display:flex;align-items:flex-start;justify-content:space-between;}
.pc-nm{font-size:9px;color:var(--tx);line-height:1.4;font-weight:500;}
.pc-sid{font-size:8px;color:var(--tx2);}
.pc-dot{width:5px;height:5px;border-radius:50%;margin-top:2px;flex-shrink:0;}
.dok{background:var(--gr);box-shadow:0 0 4px var(--gr)}.dw{background:var(--am);box-shadow:0 0 4px var(--am)}.da{background:var(--rd);box-shadow:0 0 4px var(--rd);animation:lp 1s infinite;}
.pc-vr{display:flex;align-items:baseline;gap:3px;margin-top:3px;}
.pc-v{font-size:15px;font-weight:700;letter-spacing:-.02em;font-variant-numeric:tabular-nums;transition:color .3s;color:var(--tx);}
.pc-u{font-size:8px;color:var(--tx2);letter-spacing:.1em;}
.pc-bar{height:2px;background:var(--b);margin-top:6px;}
.pc-bf{height:100%;transition:width .6s ease;}
.irow{display:flex;gap:3px;margin-top:5px;}
.ib{padding:2px 6px;font-size:7px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;border:1px solid;display:flex;align-items:center;gap:3px;}
.ib-bim{color:#4499ff;border-color:rgba(68,153,255,.3);background:rgba(68,153,255,.08);}
.ib-gis{color:#44cc88;border-color:rgba(68,204,136,.3);background:rgba(68,204,136,.08);}
.ib-sca{color:#ff9944;border-color:rgba(255,153,68,.3);background:rgba(255,153,68,.08);}
.ib-dot{width:4px;height:4px;border-radius:50%;background:currentColor;}
.cpnl{background:var(--bg-p);border-top:1px solid var(--b);flex-shrink:0;}
.cbar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--b);}
.cpn{font-size:9px;color:var(--tx2);} .cpn b{color:var(--ac);}
.tbtns{display:flex;gap:2px;}
.tb{padding:2px 6px;background:transparent;border:1px solid var(--b);color:var(--tx3);font-family:var(--mn);font-size:8px;cursor:pointer;letter-spacing:.1em;transition:all .15s;}
.tb:hover{border-color:var(--b2);color:var(--tx2)}.tb.on{border-color:var(--ac2);color:var(--ac);}
.cwrap{padding:8px 10px 10px;height:140px;}
.aftr{height:26px;display:flex;align-items:center;padding:0 12px;gap:8px;font-size:9px;border-top:1px solid;overflow:hidden;flex-shrink:0;}
.aftr.ok{border-top-color:rgba(0,230,118,.2);background:rgba(0,230,118,.04);}
.aftr.warn{border-top-color:rgba(255,179,0,.25);background:rgba(255,179,0,.05);}
.aftr.alert{border-top-color:rgba(255,61,61,.3);background:rgba(255,61,61,.07);}
.aftag{font-weight:700;letter-spacing:.15em;text-transform:uppercase;white-space:nowrap;}
.aftag.ok{color:var(--gr)}.aftag.warn{color:var(--am)}.aftag.alert{color:var(--rd);}
.aftx{color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mrow{display:flex;align-items:flex-start;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--b);gap:8px;}
.mrow:last-child{border:none;}.mk{font-size:8px;color:var(--tx2);flex-shrink:0;}.mv{font-size:8px;color:var(--tx2);text-align:right;word-break:break-all;}

/* ════════════════
   SCREEN 3: NETWORK
════════════════ */
#s3{flex-direction:row;}

/* LEFT NAV - 210px */
.nleft{width:210px;background:var(--bg-p);border-right:1px solid var(--b);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.nleft-hd{padding:10px 14px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);}
.nleft-body{padding:10px;overflow-y:auto;flex:1;}

.nsec{font-size:8px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);margin:10px 0 5px;}
.nsec:first-child{margin-top:0;}

/* Layer toggles */
.ntog-group{display:flex;flex-direction:column;gap:3px;margin-bottom:8px;}
.ntog{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg-c);border:1px solid var(--b);cursor:pointer;transition:all .2s;font-size:10px;color:var(--tx2);font-family:var(--mn);}
.ntog:hover{border-color:var(--b2);background:var(--bg-h);}
.ntog.aw{border-color:rgba(0,180,255,.6);background:rgba(0,180,255,.08);color:#00b4ff;}
.ntog.ap{border-color:rgba(255,200,0,.6);background:rgba(255,200,0,.08);color:#ffc800;}
.ntog.ad{border-color:rgba(80,220,120,.6);background:rgba(80,220,120,.08);color:#50dc78;}
.ntdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.nd-w{background:#00b4ff;box-shadow:0 0 5px #00b4ff;}
.nd-p{background:#ffc800;box-shadow:0 0 5px #ffc800;}
.nd-d{background:#50dc78;box-shadow:0 0 5px #50dc78;}

/* Legend */
.nleg{margin-bottom:8px;}
.nleg-t{font-size:8px;letter-spacing:.18em;text-transform:uppercase;color:var(--tx3);margin:8px 0 4px;}
.nleg-r{display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px;color:var(--tx2);}
.ll{width:16px;height:2px;flex-shrink:0;}
.ll.m{height:3px;}.ll.br{border-top:1px dashed;background:transparent!important;}

/* Asset tree */
.ndiv{height:1px;background:var(--b);margin:8px 0;}
.asrch{width:100%;background:var(--bg-c);border:1px solid var(--b);border-bottom:none;color:var(--tx);font-family:var(--mn);font-size:10px;padding:6px 8px;outline:none;transition:border-color .2s;}
.asrch:focus{border-color:var(--ac2);}
.atree{background:var(--bg-c);border:1px solid var(--b);overflow-y:auto;max-height:200px;}
.tnd{padding:5px 8px;display:flex;align-items:center;gap:6px;cursor:pointer;font-size:9px;color:var(--tx2);border-bottom:1px solid var(--b);transition:background .15s;position:relative;}
.tnd:last-child{border:none;}.tnd:hover{background:var(--bg-h);color:var(--tx);}
.tnd.sel{background:rgba(0,200,255,.07);color:var(--ac);}
.tnd.sel::before{content:'';position:absolute;left:0;top:0;width:2px;height:100%;background:var(--ac);}
.tnd.ch{padding-left:20px;font-size:8px;color:var(--tx3);}
.tnd.ch:hover{color:var(--tx2)}.tnd.ch.sel{color:var(--ac);}
.tdot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.ttag{font-size:7px;letter-spacing:.1em;text-transform:uppercase;margin-left:auto;color:var(--tx3);padding:1px 4px;border:1px solid var(--b);flex-shrink:0;}

/* CENTER canvas */
.nctr{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.ntbar{height:38px;background:var(--bg-p);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:0 14px;flex-shrink:0;}
.nttitle{font-size:10px;color:var(--tx2);letter-spacing:.1em;}
.nttitle span{color:var(--ac);font-weight:500;}
.nzbtns{display:flex;gap:3px;}
.nzb{padding:3px 9px;background:var(--bg-c);border:1px solid var(--b);color:var(--tx2);font-family:var(--mn);font-size:10px;cursor:pointer;transition:all .15s;}
.nzb:hover{border-color:var(--b2);color:var(--tx);}
#ncv{flex:1;display:block;cursor:crosshair;}
.nstbar{position:absolute;bottom:0;left:0;right:0;height:26px;background:rgba(6,9,13,.92);border-top:1px solid var(--b);display:flex;align-items:center;padding:0 14px;gap:18px;backdrop-filter:blur(4px);}
.nsi{display:flex;align-items:center;gap:5px;font-size:9px;}
.nsdot{width:5px;height:5px;border-radius:50%;}
.nslbl{color:var(--tx3);}.nsval{color:var(--tx2);font-weight:500;font-variant-numeric:tabular-nums;}

/* RIGHT detail */
.nrgt{width:240px;background:var(--bg-p);border-left:1px solid var(--b);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.nrgt-hd{padding:10px 14px;border-bottom:1px solid var(--b);flex-shrink:0;font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);display:flex;align-items:center;justify-content:space-between;}
.nrgt-body{flex:1;overflow-y:auto;padding:10px;}
.ni-empty{text-align:center;color:var(--tx2);padding:24px 0;font-size:10px;letter-spacing:.06em;line-height:1.8;}
.ni-id{font-family:var(--dp);font-size:13px;font-weight:700;margin-bottom:3px;}
.ni-tl{font-size:8px;letter-spacing:.15em;text-transform:uppercase;color:var(--tx3);margin-bottom:8px;}
.ni-sec{font-size:8px;letter-spacing:.18em;text-transform:uppercase;color:var(--tx3);margin:10px 0 5px;padding-bottom:3px;border-bottom:1px solid var(--b);}
.ni-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--b);font-size:9px;}
.ni-row:last-child{border:none;}.ni-k{color:var(--tx3);}.ni-v{color:var(--tx);font-weight:500;}
.ni-v.ok{color:var(--gr)}.ni-v.warn{color:var(--am)}.ni-v.alert{color:var(--rd);}
.ni-rb{margin:4px 0 8px;display:flex;flex-direction:column;gap:4px;}
.ni-rb-r{display:flex;align-items:center;gap:5px;font-size:8px;}
.ni-rb-l{color:var(--tx3);width:68px;flex-shrink:0;}
.ni-rb-b{flex:1;height:2px;background:var(--b);}
.ni-rb-f{height:100%;transition:width .5s;}
.ni-rb-v{color:var(--tx2);width:44px;text-align:right;flex-shrink:0;font-variant-numeric:tabular-nums;}
.deplist{display:flex;flex-direction:column;gap:2px;}
.depitem{padding:4px 8px;background:var(--bg-c);border:1px solid var(--b);font-size:9px;color:var(--tx2);display:flex;align-items:center;gap:5px;cursor:pointer;transition:all .15s;}
.depitem:hover{border-color:var(--b2);color:var(--tx);}

/* SIM MODAL */
#simov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(6,9,13,.75);display:none;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(3px);}
#simov.on{display:flex;}
.smod{background:var(--bg-p);border:1px solid var(--b2);padding:28px 32px;max-width:360px;width:100%;animation:mi .3s ease;}
@keyframes mi{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:none;}}
.smod-t{font-family:var(--dp);font-size:16px;font-weight:800;margin-bottom:6px;}
.smod-s{font-size:10px;color:var(--tx2);margin-bottom:20px;line-height:1.6;}
.sopts{display:flex;flex-direction:column;gap:6px;margin-bottom:20px;}
.sopt{padding:10px 14px;border:1px solid var(--b);background:var(--bg-c);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;}
.sopt:hover{border-color:var(--b2);background:var(--bg-h);}
.sopt-ic{font-size:18px;}
.sopt-nm{font-size:11px;font-weight:500;}
.sopt-ds{font-size:9px;color:var(--tx2);margin-top:2px;}
.scanc{width:100%;padding:8px;background:transparent;border:1px solid var(--b);color:var(--tx2);font-family:var(--mn);font-size:10px;cursor:pointer;transition:all .2s;letter-spacing:.1em;}
.scanc:hover{border-color:var(--b2);color:var(--tx);}

/* ════════════════════════════════
   SCREEN 4 — DECISION ENGINE
════════════════════════════════ */
#s4 { flex-direction:row; }

/* LEFT */
.de-left { width:220px;background:var(--bg-p);border-right:1px solid var(--b);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden; }
.de-left-hd { padding:10px 14px;border-bottom:1px solid var(--b);font-size:9px;letter-spacing:.2em;text-transform:uppercase;color:var(--tx3);flex-shrink:0; }
.de-left-body { padding:10px 12px;overflow-y:auto;flex:1; }
.de-sec-lbl { font-size:8px;letter-spacing:.18em;text-transform:uppercase;color:var(--tx3);margin-bottom:6px; }

/* UC buttons */
.de-uc-btns { display:flex;flex-direction:column;gap:4px; }
.de-uc-btn {
  display:flex;align-items:center;gap:10px;padding:10px 10px;
  background:var(--bg-c);border:1px solid var(--b);cursor:pointer;
  transition:all .2s;position:relative;overflow:hidden;
}
.de-uc-btn::before { content:'';position:absolute;left:0;top:0;width:3px;height:100%;background:var(--b);transition:background .2s; }
.de-uc-btn:hover { border-color:var(--b2);background:var(--bg-h); }
.de-uc-btn:hover::before { background:var(--tx3); }
.de-uc-btn.sel { border-color:var(--ac2);background:rgba(0,200,255,.05); }
.de-uc-btn.sel::before { background:var(--ac); }
.de-uc-btn.flood-sel { border-color:rgba(0,180,255,.5);background:rgba(0,180,255,.05); }
.de-uc-btn.flood-sel::before { background:#00b4ff; }
.de-uc-btn.power-sel { border-color:rgba(255,200,0,.5);background:rgba(255,200,0,.05); }
.de-uc-btn.power-sel::before { background:#ffc800; }
.de-uc-btn.fire-sel { border-color:rgba(255,100,50,.5);background:rgba(255,100,50,.05); }
.de-uc-btn.fire-sel::before { background:#ff6432; }
.de-uc-icon { font-size:20px;flex-shrink:0; }
.de-uc-info { flex:1; }
.de-uc-name { font-size:10px;font-weight:600;color:var(--tx2); }
.de-uc-sub  { font-size:8px;color:var(--tx3);margin-top:1px; }
.de-uc-badge {
  font-size:8px;font-weight:700;letter-spacing:.08em;
  padding:2px 6px;border:1px solid var(--b);color:var(--tx3);
  white-space:nowrap;flex-shrink:0;
}
.de-uc-badge.ok    { color:var(--gr);border-color:rgba(0,230,118,.3); }
.de-uc-badge.warn  { color:var(--am);border-color:rgba(255,179,0,.3); }
.de-uc-badge.crit  { color:var(--rd);border-color:rgba(255,61,61,.3);animation:bk 1s infinite; }

/* Sensor watch list */
.de-watch-list { display:flex;flex-direction:column;gap:3px; }
.de-watch-row { display:flex;align-items:center;justify-content:space-between;padding:5px 8px;background:var(--bg-c);border:1px solid var(--b); }
.de-watch-row.crit { border-color:rgba(255,61,61,.35);background:var(--rdd); }
.de-watch-row.warn { border-color:rgba(255,179,0,.3);background:var(--amd); }
.de-wr-left { display:flex;flex-direction:column;gap:1px; }
.de-wr-id  { font-size:8px;color:var(--tx3);letter-spacing:.08em; }
.de-wr-loc { font-size:7px;color:var(--tx3); }
.de-wr-right { display:flex;flex-direction:column;align-items:flex-end;gap:1px; }
.de-wr-val { font-size:11px;font-weight:700;font-variant-numeric:tabular-nums; }
.de-wr-val.ok   { color:var(--gr); }
.de-wr-val.warn { color:var(--am); }
.de-wr-val.crit { color:var(--rd);animation:bk 1s infinite; }
.de-wr-thr { font-size:7px;color:var(--tx3); }

/* Data source rows */
.de-src-row { display:flex;align-items:center;gap:8px;padding:3px 0; }

/* CENTRE 3D VIEW */
.de-view { flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;background:var(--bg); }
.de-view-btns { display:flex;gap:2px; }
.de-vbtn { padding:3px 10px;border:1px solid var(--b);background:transparent;
  color:var(--tx3);font-family:var(--mn);font-size:8px;letter-spacing:.12em;
  text-transform:uppercase;cursor:pointer;transition:all .15s; }
.de-vbtn:hover { border-color:var(--b2);color:var(--tx2); }
.de-vbtn.active { border-color:var(--ac2);color:var(--ac);background:var(--acg); }

.de-scada-row { display:flex;align-items:center;gap:10px;padding:8px 10px;
  border:1px solid var(--b);background:var(--bg-c);margin-bottom:4px; }
.de-scada-id { font-size:9px;font-weight:600;color:var(--tx);font-family:var(--mn);min-width:80px; }
.de-scada-loc { font-size:8px;color:var(--tx2);flex:1; }
.de-scada-bar { width:80px;height:4px;background:var(--b);flex-shrink:0; }
.de-scada-bar-f { height:100%;transition:width .6s; }
.de-scada-val { font-size:11px;font-weight:700;min-width:60px;text-align:right;font-variant-numeric:tabular-nums; }
.de-scada-st { font-size:7px;letter-spacing:.1em;min-width:44px;text-align:right; }
.de-scada-sec { font-size:7px;letter-spacing:.16em;text-transform:uppercase;
  color:var(--tx3);padding:10px 0 4px;border-bottom:1px solid var(--b);margin-bottom:4px; }


.de-view-hd>span:first-child { font-size:10px;color:var(--tx2);letter-spacing:.06em; }
.de-view-hint { font-size:8px;color:var(--tx3);letter-spacing:.1em; }

/* Layer pills */
.de-layer-pills { display:flex;gap:3px; }
.de-pill { font-size:7px;letter-spacing:.12em;text-transform:uppercase;padding:2px 7px;border:1px solid;opacity:.3;transition:all .4s; }
.de-pill.lit { opacity:1; }
.de-pill-sca { color:#ff9944;border-color:rgba(255,153,68,.4); } .de-pill-sca.lit { background:rgba(255,153,68,.1); }
.de-pill-gis { color:#44cc88;border-color:rgba(68,204,136,.4); } .de-pill-gis.lit { background:rgba(68,204,136,.1); }
.de-pill-bim { color:#4499ff;border-color:rgba(68,153,255,.4); } .de-pill-bim.lit { background:rgba(68,153,255,.1); }

/* Event callout */
.de-callout {
  position:absolute;top:52px;left:16px;
  background:rgba(6,9,13,.92);border:1px solid var(--rd);
  padding:8px 12px;backdrop-filter:blur(4px);pointer-events:none;
  animation:si .3s ease both;
}
.de-callout-id  { font-size:8px;letter-spacing:.15em;text-transform:uppercase;color:var(--tx3);margin-bottom:2px; }
.de-callout-val { font-size:13px;font-weight:700;color:var(--rd);font-variant-numeric:tabular-nums; }

/* RIGHT COLUMN */
.de-right-col { width:300px;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;border-left:1px solid var(--b); }
.de-panel { display:flex;flex-direction:column;flex:1;overflow:hidden;border-bottom:1px solid var(--b); }
.de-panel:last-child { border-bottom:none; }
.de-panel-hd { padding:8px 12px;background:var(--bg-p);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;font-size:10px;font-weight:600;color:var(--tx2); }
.de-panel-sub { font-size:8px;color:var(--tx3);font-weight:400;letter-spacing:.05em; }
.de-panel-body { flex:1;overflow-y:auto;padding:0; }
.de-panel-body::-webkit-scrollbar { width:3px; }
.de-panel-body::-webkit-scrollbar-thumb { background:var(--b2); }
.de-empty { text-align:center;color:var(--tx3);padding:20px;font-size:9px;letter-spacing:.1em; }

/* Failure detail table rows */
.de-fail-row { display:flex;align-items:center;border-bottom:1px solid var(--b);padding:7px 10px;gap:8px;animation:fu .3s ease both; }
.de-fail-row:last-child { border:none; }
.de-fail-row.crit { background:rgba(255,61,61,.04); }
.de-fail-row.warn { background:rgba(255,179,0,.03); }
.de-fr-dot { width:6px;height:6px;border-radius:50%;flex-shrink:0; }
.de-fr-main { flex:1;min-width:0; }
.de-fr-id   { font-size:9px;font-weight:600;color:var(--tx);font-family:var(--mn); }
.de-fr-loc  { font-size:8px;color:var(--tx3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.de-fr-val  { text-align:right;flex-shrink:0; }
.de-fr-reading { font-size:11px;font-weight:700;font-variant-numeric:tabular-nums; }
.de-fr-reading.ok   { color:var(--gr); }
.de-fr-reading.warn { color:var(--am); }
.de-fr-reading.crit { color:var(--rd);animation:bk 1s infinite; }
.de-fr-status { font-size:7px;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-top:1px; }

/* Impact table rows */
.de-impact-row { display:flex;align-items:center;border-bottom:1px solid var(--b);padding:7px 10px;gap:8px;animation:fu .3s ease both; }
.de-impact-row:last-child { border:none; }
.de-impact-row.crit { background:rgba(255,61,61,.04); }
.de-impact-row.warn { background:rgba(255,179,0,.03); }
.de-ir-icon { font-size:14px;flex-shrink:0; }
.de-ir-main { flex:1;min-width:0; }
.de-ir-name { font-size:9px;font-weight:600;color:var(--tx);font-family:var(--mn); }
.de-ir-type { font-size:8px;color:var(--tx3);margin-top:1px; }
.de-ir-badge { flex-shrink:0;font-size:7px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:2px 6px;border:1px solid; }
.de-ir-badge.crit { color:var(--rd);border-color:rgba(255,61,61,.35);background:var(--rdd); }
.de-ir-badge.warn { color:var(--am);border-color:rgba(255,179,0,.3);background:var(--amd); }
.de-ir-badge.ok   { color:var(--gr);border-color:rgba(0,230,118,.25); }

/* Action buttons */
.de-actions { padding:8px 10px;background:var(--bg-p);border-top:1px solid var(--b);display:flex;flex-direction:column;gap:4px;flex-shrink:0; }
.de-act-btn { width:100%;padding:7px 10px;background:transparent;border:1px solid var(--b);color:var(--tx2);font-family:var(--mn);font-size:9px;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;gap:8px; }
.de-act-btn:hover { border-color:var(--b2);background:var(--bg-h);color:var(--tx); }
.de-act-btn.urgent { border-color:rgba(255,61,61,.4);color:var(--rd); }
.de-act-btn.urgent:hover { background:var(--rdd); }
.de-act-btn.done  { border-color:rgba(0,230,118,.3);color:var(--gr);background:rgba(0,230,118,.04);cursor:default; }


/* ── Asset Detail additions ── */
.lvl-tog { display:flex; gap:2px; margin-bottom:2px; }
.lvl-btn { flex:1; padding:5px 0; text-align:center; font-size:8px; letter-spacing:.12em;
  text-transform:uppercase; background:var(--bg-c); border:1px solid var(--b);
  color:var(--tx3); cursor:pointer; transition:all .2s; }
.lvl-btn:hover { border-color:var(--b2); color:var(--tx2); }
.lvl-btn.active { border-color:var(--ac2); color:var(--ac); background:rgba(0,200,255,.06); }

.layer-togs { display:flex; flex-direction:column; gap:3px; }
.ltog { display:flex; align-items:center; gap:8px; padding:5px 8px;
  background:var(--bg-c); border:1px solid var(--b); cursor:pointer;
  font-size:9px; color:var(--tx3); transition:all .2s; }
.ltog:hover { border-color:var(--b2); color:var(--tx2); }
.ltog.active { border-color:var(--b2); color:var(--tx2); background:var(--bg-h); }
.ltog-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; opacity:.4; transition:opacity .2s; }
.ltog.active .ltog-dot { opacity:1; }

/* Floor indicator overlay */
.floor-indicator {
  position:absolute; top:46px; right:14px;
  background:rgba(6,9,13,.88); border:1px solid var(--ac2);
  padding:6px 12px; backdrop-filter:blur(4px); pointer-events:none;
}
.fi-label { font-size:11px; font-weight:700; color:var(--ac); letter-spacing:.1em; }
.fi-sub   { font-size:8px; color:var(--tx3); margin-top:1px; letter-spacing:.1em; text-transform:uppercase; }

/* X-Ray button */
#v-xray.on { border-color:rgba(0,255,180,.4); color:#00ffb4; }


/* ── Network View additions ── */
.ntag-live { font-size:7px; color:var(--gr); letter-spacing:.15em; margin-left:10px; animation:bk 2s infinite; }
.n-bg-togs { display:flex; gap:2px; }
.n-bg-btn  { padding:3px 8px; font-size:8px; letter-spacing:.1em; background:var(--bg-c);
  border:1px solid var(--b); color:var(--tx3); cursor:pointer; transition:all .15s; }
.n-bg-btn:hover { border-color:var(--b2); color:var(--tx2); }
.n-bg-btn.active { border-color:var(--ac2); color:var(--ac); background:rgba(0,200,255,.06); }

/* Sensor control toggle in node detail */
.sen-ctrl { display:flex; align-items:center; justify-content:space-between;
  padding:7px 10px; border-top:1px solid var(--b); margin-top:4px; }
.sen-ctrl-lbl { font-size:9px; color:var(--tx2); }
.sen-toggle { position:relative; width:32px; height:16px; cursor:pointer; }
.sen-toggle input { opacity:0; width:0; height:0; }
.sen-toggle-track { position:absolute; inset:0; background:var(--b2);
  border-radius:8px; transition:background .2s; }
.sen-toggle input:checked + .sen-toggle-track { background:var(--gr); }
.sen-toggle-thumb { position:absolute; width:12px; height:12px; top:2px; left:2px;
  background:#fff; border-radius:50%; transition:transform .2s; }
.sen-toggle input:checked ~ .sen-toggle-thumb { transform:translateX(16px); }

/* Reading bars in node detail */
.nrd-bar { height:3px; background:var(--b2); margin-top:3px; border-radius:1px; }
.nrd-bar-fill { height:100%; border-radius:1px; transition:width .4s; }


/* ── Flood Modeller Modal ── */

/* ══ SIMULATE MODAL — Full Screen ══ */
#simov { position:fixed;inset:0;background:rgba(0,0,0,.82);display:none;
  align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(4px); }
#simov.on { display:flex; }

.smod-full {
  width:min(1100px,96vw); height:min(680px,92vh);
  background:var(--bg-p); border:1px solid var(--b2);
  display:flex; flex-direction:column;
  animation:mi .25s ease;
}
.sfull-hd {
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 24px; border-bottom:1px solid var(--b); flex-shrink:0;
}
.sfull-title { font-family:var(--dp);font-size:16px;font-weight:800; }
.sfull-sub   { font-size:9px;color:var(--tx3);margin-top:3px;letter-spacing:.08em; }
.sim-close-btn {
  padding:6px 14px; background:transparent; border:1px solid var(--b);
  color:var(--tx2); font-family:var(--mn); font-size:9px; cursor:pointer;
  letter-spacing:.1em; transition:all .15s;
}
.sim-close-btn:hover { border-color:var(--rd);color:var(--rd); }

.sfull-body {
  display:flex; flex:1; overflow:hidden;
}

/* Left panel */
.sfull-left {
  width:220px; flex-shrink:0; border-right:1px solid var(--b);
  padding:16px 14px; display:flex; flex-direction:column; overflow-y:auto;
}
.sfull-sec { font-size:8px;letter-spacing:.2em;text-transform:uppercase;
  color:var(--tx3); margin-bottom:8px; }
.sfull-sec-row { display:flex;align-items:center;justify-content:space-between;margin-bottom:8px; }
.sfull-sec-row .sfull-sec { margin-bottom:0; }

.sim-cards { display:flex;flex-direction:column;gap:4px; }
.sim-card {
  display:flex;align-items:center;gap:10px;padding:9px 10px;
  border:1px solid var(--b);background:var(--bg-c);cursor:pointer;transition:all .2s;
}
.sim-card:hover { border-color:var(--b2);background:var(--bg-h); }
.sim-card.active { border-color:var(--ac2);background:rgba(0,200,255,.06); }
.sim-card.active.flood  { border-color:rgba(0,180,255,.5);background:rgba(0,180,255,.06); }
.sim-card.active.power  { border-color:rgba(255,200,0,.5);background:rgba(255,200,0,.05); }
.sim-card.active.water  { border-color:rgba(0,200,255,.5);background:rgba(0,200,255,.05); }
.sim-card.active.fire   { border-color:rgba(255,100,50,.5);background:rgba(255,100,50,.06); }
.sim-card-icon { font-size:20px;flex-shrink:0; }
.sim-card-info { flex:1; }
.sim-card-name { font-size:10px;font-weight:600;color:var(--tx2); }
.sim-card-sub  { font-size:8px;color:var(--tx3);margin-top:1px; }
.sim-card-badge { font-size:7px;font-weight:700;letter-spacing:.1em;padding:2px 5px;border:1px solid;flex-shrink:0; }
.sim-card-badge.ok   { color:var(--gr);border-color:rgba(0,230,118,.3); }
.sim-card-badge.warn { color:var(--am);border-color:rgba(255,179,0,.35); }
.sim-card-badge.crit { color:var(--rd);border-color:rgba(255,61,61,.4);animation:bk 1s infinite; }

.sim-summary { display:flex;flex-direction:column;gap:3px; }
.sim-sum-row {
  display:flex;justify-content:space-between;align-items:center;
  padding:5px 8px;background:var(--bg-c);border:1px solid var(--b);
  font-size:9px;color:var(--tx3);
}
.sim-sum-val { font-weight:700;color:var(--tx2);font-variant-numeric:tabular-nums; }
.sim-sum-val.warn { color:var(--am); }
.sim-sum-val.crit { color:var(--rd); }

/* Centre params */
.sfull-centre {
  width:280px; flex-shrink:0; border-right:1px solid var(--b);
  padding:16px 14px; overflow-y:auto;
}
.sim-slider-row { display:flex;flex-direction:column;gap:5px;margin-bottom:14px; }
.sim-sl-lbl { display:flex;justify-content:space-between;font-size:9px;color:var(--tx2); }
.sim-sl-val { color:var(--ac);font-weight:700;font-variant-numeric:tabular-nums; }
.sim-range { -webkit-appearance:none;appearance:none;width:100%;height:3px;
  background:var(--b2);outline:none;cursor:pointer;border-radius:2px; }
.sim-range::-webkit-slider-thumb { -webkit-appearance:none;width:13px;height:13px;
  border-radius:50%;background:var(--ac);cursor:pointer;border:2px solid var(--bg-p); }
.sim-range::-moz-range-thumb { width:13px;height:13px;border-radius:50%;
  background:var(--ac);cursor:pointer;border:2px solid var(--bg-p); }
.sim-sl-scale { display:flex;justify-content:space-between;font-size:7px;color:var(--tx3); }
.sim-param-group-lbl { font-size:8px;letter-spacing:.15em;text-transform:uppercase;
  color:var(--tx3);margin-bottom:8px;margin-top:4px;padding-top:10px;border-top:1px solid var(--b); }
.sim-param-group-lbl:first-child { border-top:none;padding-top:0;margin-top:0; }

/* Right preview */
.sfull-right {
  flex:1; padding:16px 14px; display:flex; flex-direction:column; overflow:hidden;
}
.sim-view-togs { display:flex;gap:2px; }
.sim-vtog {
  padding:3px 12px;font-size:8px;letter-spacing:.15em;background:var(--bg-c);
  border:1px solid var(--b);color:var(--tx3);cursor:pointer;transition:all .15s;
}
.sim-vtog:hover { border-color:var(--b2);color:var(--tx2); }
.sim-vtog.active { border-color:var(--ac2);color:var(--ac);background:rgba(0,200,255,.06); }
.sim-view-wrap {
  flex:1;position:relative;margin-top:8px;background:var(--bg);
  border:1px solid var(--b);overflow:hidden;
}
.sim-view-wrap canvas { position:absolute;inset:0;width:100%;height:100%; }
.sim-view-info {
  position:absolute;bottom:10px;left:10px;
  display:flex;flex-direction:column;gap:4px;pointer-events:none;
}
.sim-vi-chip {
  background:rgba(6,9,13,.88);border:1px solid var(--b2);
  padding:3px 8px;font-size:8px;letter-spacing:.08em;color:var(--tx2);
  backdrop-filter:blur(4px);
}


/* ══ SCREEN 5: CAMERA FEEDS ══ */
#s5 { flex-direction:row; }

.cam-nav { width:290px;flex-shrink:0;border-right:1px solid var(--b);
  background:var(--bg-p);display:flex;flex-direction:column;overflow:hidden; }
.cam-nav-hd { padding:10px 14px;border-bottom:1px solid var(--b);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between; }
.cam-nav-body { flex:1;overflow-y:auto;padding:10px 12px;
  display:flex;flex-direction:column;gap:8px; }
.cam-nav-body::-webkit-scrollbar{width:2px;}
.cam-nav-body::-webkit-scrollbar-thumb{background:var(--b2);}

.cam-sec-lbl { font-size:7px;letter-spacing:.16em;text-transform:uppercase;color:var(--tx3); }
.cam-map-wrap { border:1px solid var(--b);background:var(--bg);overflow:hidden; }
#cam-map { display:block;width:100%;height:170px; }
.cam-legend { display:flex;gap:8px;flex-wrap:wrap; }
.cam-leg-r  { display:flex;align-items:center;gap:4px;font-size:8px;color:var(--tx3); }
.cam-leg-dot{ width:6px;height:6px;border-radius:50%;flex-shrink:0; }

#cam-list { display:flex;flex-direction:column;gap:3px; }
.cam-item { display:flex;align-items:center;gap:8px;padding:7px 9px;
  border:1px solid var(--b);background:var(--bg-c);cursor:pointer;transition:all .15s; }
.cam-item:hover  { border-color:var(--b2);background:var(--bg-h); }
.cam-item.sel    { border-color:var(--ac2);background:rgba(0,200,255,.06); }
.cam-item.al     { border-left:3px solid var(--rd); }
.cam-item.wn     { border-left:3px solid var(--am); }
.cam-item-dot    { width:7px;height:7px;border-radius:50%;flex-shrink:0; }
.cam-item-info   { flex:1;min-width:0; }
.cam-item-id     { font-size:9px;font-weight:600;color:var(--tx);font-family:var(--mn); }
.cam-item-loc    { font-size:7px;color:var(--tx3);margin-top:1px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.cam-item-badge  { font-size:7px;letter-spacing:.08em;color:var(--tx3);flex-shrink:0; }

.cam-feed-area { flex:1;display:flex;flex-direction:column;overflow:hidden; }
.cam-feed-hd { height:38px;background:var(--bg-p);border-bottom:1px solid var(--b);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;flex-shrink:0; }
.cam-ctrl { padding:3px 9px;border:1px solid var(--b);background:transparent;
  color:var(--tx3);font-family:var(--mn);font-size:8px;letter-spacing:.1em;cursor:pointer; }
.cam-ctrl:hover  { border-color:var(--b2);color:var(--tx2); }
.cam-ctrl.active { border-color:var(--ac2);color:var(--ac); }

.cam-canvas-wrap { flex:1;position:relative;background:#020806;overflow:hidden;min-height:0; }
.cam-canvas-wrap canvas { position:absolute;top:0;left:0;width:100%;height:100%;display:block; }
.cam-ol { position:absolute;font-size:8px;letter-spacing:.08em;
  background:rgba(0,0,0,.65);padding:3px 8px;pointer-events:none;color:var(--tx2); }
.cam-ol-tl { top:10px;left:10px;color:var(--ac); }
.cam-ol-tr { top:10px;right:10px; }
.cam-ol-bl { bottom:10px;left:10px;color:var(--gr);animation:bk 2s infinite; }
.cam-no-feed { position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center; }

.cam-inc-bar { height:72px;flex-shrink:0;border-top:1px solid var(--b);
  background:var(--bg-p);display:flex;align-items:center;gap:0;overflow:hidden; }
.cam-inc-bar-lbl { padding:0 12px;font-size:7px;letter-spacing:.16em;
  text-transform:uppercase;color:var(--tx3);flex-shrink:0;writing-mode:vertical-rl;
  transform:rotate(180deg); }
#cam-incidents { flex:1;display:flex;align-items:center;gap:6px;
  overflow-x:auto;padding:8px 0;height:100%; }
#cam-incidents::-webkit-scrollbar{height:2px;}
#cam-incidents::-webkit-scrollbar-thumb{background:var(--b2);}
.cam-chip { display:inline-flex;flex-direction:column;gap:2px;padding:5px 10px;
  border:1px solid var(--b);background:var(--bg-c);cursor:pointer;
  flex-shrink:0;min-width:160px;transition:border-color .15s; }
.cam-chip:hover { border-color:var(--b2); }
.cam-chip.al { border-color:rgba(255,61,61,.4);background:rgba(255,61,61,.05); }
.cam-chip.wn { border-color:rgba(255,179,0,.35);background:rgba(255,179,0,.04); }
.cam-chip-top { display:flex;align-items:center;gap:5px; }
.cam-chip-dot { width:5px;height:5px;border-radius:50%;flex-shrink:0; }
.cam-chip-id  { font-size:8px;font-weight:600;color:var(--tx2);font-family:var(--mn); }
.cam-chip-time{ font-size:7px;color:var(--tx3);margin-left:auto; }
.cam-chip-msg { font-size:8px;color:var(--tx3);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px; }

/* Main feed */
.cam-main { flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg); }
.cam-main-hd { height:38px;background:var(--bg-p);border-bottom:1px solid var(--b);
  display:flex;align-items:center;justify-content:space-between;padding:0 14px;flex-shrink:0; }
.cam-feed-wrap { flex:1;position:relative;background:#000;overflow:hidden; }
.cam-feed-wrap canvas { position:absolute;inset:0;width:100%;height:100%; }
.cam-overlay-tl,.cam-overlay-tr,.cam-overlay-br {
  position:absolute;font-size:8px;letter-spacing:.08em;pointer-events:none;
  background:rgba(0,0,0,.55);padding:3px 7px; }
.cam-overlay-tl { top:10px;left:10px;color:var(--ac); }
.cam-overlay-tr { top:10px;right:10px;color:var(--tx3); }
.cam-overlay-br { bottom:10px;left:10px;color:var(--tx3); }

.cam-ctrl-btn { padding:3px 9px;background:transparent;border:1px solid var(--b);
  color:var(--tx3);font-family:var(--mn);font-size:8px;letter-spacing:.1em;
  cursor:pointer;transition:all .15s; }
.cam-ctrl-btn:hover { border-color:var(--b2);color:var(--tx2); }
.cam-ctrl-btn.active { border-color:var(--ac2);color:var(--ac); }

.cam-playbar { height:42px;background:var(--bg-p);border-top:1px solid var(--b);
  display:flex;align-items:center;gap:10px;padding:0 14px;flex-shrink:0; }
.cam-play-btns { display:flex;gap:3px;flex-shrink:0; }
.cam-pb { padding:3px 8px;background:transparent;border:1px solid var(--b);
  color:var(--tx2);font-family:var(--mn);font-size:8px;cursor:pointer;transition:all .15s; }
.cam-pb:hover { border-color:var(--b2); }
.cam-pb-main { font-size:12px;padding:2px 10px;border-color:var(--b2); }
.cam-timeline { flex:1; }
.cam-tl-track { height:4px;background:var(--b2);border-radius:2px;
  position:relative;cursor:pointer;margin-bottom:4px; }
.cam-tl-fill  { height:100%;background:var(--ac2);border-radius:2px; }
.cam-tl-head  { position:absolute;top:-4px;width:10px;height:10px;
  background:var(--ac);border-radius:50%;transform:translateX(-50%); }
.cam-tl-times { display:flex;justify-content:space-between;font-size:7px;color:var(--tx3); }

/* Right panel */
.cam-right { width:260px;flex-shrink:0;border-left:1px solid var(--b);
  display:flex;flex-direction:column;overflow:hidden;background:var(--bg-p); }
.cam-right-hd { padding:8px 12px;border-bottom:1px solid var(--b);font-size:9px;
  font-weight:600;color:var(--tx2);letter-spacing:.06em;flex-shrink:0; }
.cam-quad { display:grid;grid-template-columns:1fr 1fr;gap:2px;
  padding:6px;background:var(--bg);flex-shrink:0; }
.cam-quad-cv { width:100%;aspect-ratio:4/3;display:block;cursor:pointer;
  border:1px solid var(--b);background:#050a08;transition:border-color .15s; }
.cam-quad-cv:hover { border-color:var(--b2); }

.cam-incident-log { flex:1;overflow-y:auto;padding:6px 8px;display:flex;flex-direction:column;gap:3px; }
.cam-incident-log::-webkit-scrollbar{width:2px;}
.cam-incident-log::-webkit-scrollbar-thumb{background:var(--b2);}
.cam-inc { display:flex;align-items:flex-start;gap:8px;padding:6px 8px;
  border:1px solid var(--b);background:var(--bg-c);animation:fu .3s ease both; }
.cam-inc.alert { border-color:rgba(255,61,61,.35);background:rgba(255,61,61,.04); }
.cam-inc.warn  { border-color:rgba(255,179,0,.3);background:rgba(255,179,0,.03); }
.cam-inc-dot   { width:5px;height:5px;border-radius:50%;flex-shrink:0;margin-top:3px; }
.cam-inc-body  { flex:1;min-width:0; }
.cam-inc-msg   { font-size:8px;color:var(--tx2);line-height:1.4; }
.cam-inc-time  { font-size:7px;color:var(--tx3);margin-top:2px; }


/* ════════════════════════════════════════════════════════════
   RESPONSIVE — Desktop ≥1024 · Tablet 768–1023 · Mobile <768
════════════════════════════════════════════════════════════ */
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199;backdrop-filter:blur(2px);}
.mob-overlay.on{display:block;}
.drawer-toggle{display:none;width:34px;height:34px;border-radius:4px;background:var(--bg-c);border:1px solid var(--b);color:var(--tx);font-size:16px;cursor:pointer;align-items:center;justify-content:center;flex-shrink:0;}

/* ── TABLET 768–1023px ─────────────────────────────────── */
@media(max-width:1023px){
  #hdr{padding:0 12px;gap:8px;}
  .hsub,.hst{display:none;}
  .hctr{font-size:8px;letter-spacing:.04em;}
  #nav{padding:0 8px;overflow-x:auto;overflow-y:hidden;gap:0;}
  #nav::-webkit-scrollbar{height:2px;}
  .ntab{padding:9px 10px;font-size:8px;letter-spacing:.08em;white-space:nowrap;}
  .nsep{display:none;}
  .sbtn{font-size:7px;padding:5px 8px;}
  #app{height:calc(100vh - 88px);}

  /* CC */
  .cctop{grid-template-columns:repeat(3,1fr);}
  .ccbody{flex-direction:column;}
  .cclog{width:100%;height:170px;border-left:none;border-top:1px solid var(--b);}

  /* Drawers — Asset Detail */
  .scr#s2{position:relative;}
  .dnav{position:absolute;left:0;top:0;bottom:0;z-index:200;transform:translateX(-100%);transition:transform .25s ease;box-shadow:4px 0 20px rgba(0,0,0,.5);}
  .dnav.open{transform:translateX(0);}
  .drawer-toggle{display:flex;}
  #dnav-toggle{position:absolute;top:6px;left:6px;z-index:50;}

  /* Network */
  .scr#s3{position:relative;}
  .nleft{position:absolute;left:0;top:0;bottom:0;z-index:200;transform:translateX(-100%);transition:transform .25s ease;box-shadow:4px 0 20px rgba(0,0,0,.5);}
  .nleft.open{transform:translateX(0);}
  .nright{display:none;}
  #nleft-toggle{position:absolute;top:6px;left:6px;z-index:50;}

  /* Decision */
  .scr#s4{position:relative;}
  .de-left{position:absolute;left:0;top:0;bottom:0;z-index:200;transform:translateX(-100%);transition:transform .25s ease;box-shadow:4px 0 20px rgba(0,0,0,.5);}
  .de-left.open{transform:translateX(0);}
  .de-right{display:none;}
  .de-ctr{flex:1;}
  #de-left-toggle{position:absolute;top:6px;left:6px;z-index:50;}

  /* Camera */
  .cam-body{flex-direction:column;}
  .cam-left{width:100%;height:160px;border-right:none;border-bottom:1px solid var(--b);flex-direction:row;}
  .cam-list{flex-direction:row;overflow-x:auto;overflow-y:hidden;flex:1;}
  .cam-item{min-width:140px;flex-shrink:0;border-bottom:none;border-right:1px solid var(--b);}
  .cam-map-wrap{display:none;}
  .cam-right{width:100%;height:190px;border-left:none;border-top:1px solid var(--b);flex-direction:row;overflow-x:auto;}
  .cam-incidents{display:flex;flex-direction:row;overflow-x:auto;padding:6px;gap:6px;}
  .cam-chip{min-width:180px;flex-shrink:0;}
}

/* ── MOBILE <768px ─────────────────────────────────────── */
@media(max-width:767px){
  #hdr{height:44px;padding:0 10px;}
  .hlm,.hsub,.hctr,.hst{display:none;}
  .hname{font-size:11px;}
  #htime{font-size:9px;}

  /* Bottom nav tab bar */
  #nav{
    position:fixed;bottom:0;left:0;right:0;top:auto;
    height:54px;padding:0;
    border-top:1px solid var(--b);border-bottom:none;
    display:flex;align-items:stretch;justify-content:space-around;
    z-index:150;box-shadow:0 -4px 20px rgba(0,0,0,.6);
    overflow:visible;
  }
  .ntab{
    flex:1;padding:5px 2px 3px;
    font-size:0;letter-spacing:0;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    border-bottom:none;border-top:2px solid transparent;gap:2px;
  }
  .ntab::before{font-size:18px;display:block;}
  .ntab[onclick*="'cc'"]::before{content:'⬛';}
  .ntab[onclick*="'detail'"]::before{content:'◈';}
  .ntab[onclick*="'net'"]::before{content:'⬡';}
  .ntab[onclick*="'decision'"]::before{content:'⚡';}
  .ntab[onclick*="'camera'"]::before{content:'📷';}
  .ntab::after{font-size:6px;letter-spacing:.05em;text-transform:uppercase;color:var(--tx3);}
  .ntab[onclick*="'cc'"]::after{content:'CMD';}
  .ntab[onclick*="'detail'"]::after{content:'ASSET';}
  .ntab[onclick*="'net'"]::after{content:'NET';}
  .ntab[onclick*="'decision'"]::after{content:'ENGINE';}
  .ntab[onclick*="'camera'"]::after{content:'CAM';}
  .ntab.on{border-top-color:var(--ac);}
  .nsep,.sbtn{display:none;}

  #app{height:calc(100vh - 44px - 54px);}

  /* CC */
  .cctop{grid-template-columns:repeat(2,1fr);}
  .cctop .ccst:last-child{grid-column:span 2;}
  .ccst-val{font-size:20px;}
  .ccbody{flex-direction:column;}
  .cclog{width:100%;height:150px;border-left:none;border-top:1px solid var(--b);}

  /* Asset Detail */
  .scr#s2{position:relative;}
  .dnav{position:fixed;left:0;top:44px;bottom:54px;z-index:200;transform:translateX(-100%);transition:transform .25s ease;width:82vw;max-width:280px;box-shadow:4px 0 24px rgba(0,0,0,.7);}
  .dnav.open{transform:translateX(0);}
  .dview{width:100%;}
  .drawer-toggle{display:flex;}
  #dnav-toggle{position:absolute;top:6px;left:6px;z-index:50;}
  .pcg{grid-template-columns:1fr !important;}

  /* Network */
  .scr#s3{position:relative;}
  .nleft{position:fixed;left:0;top:44px;bottom:54px;z-index:200;transform:translateX(-100%);transition:transform .25s ease;width:82vw;max-width:260px;box-shadow:4px 0 24px rgba(0,0,0,.7);}
  .nleft.open{transform:translateX(0);}
  .nright{display:none;}
  #nleft-toggle{position:absolute;top:6px;left:6px;z-index:50;}
  .nst-bar{flex-wrap:wrap;height:auto !important;padding:4px 8px;gap:4px;}

  /* Decision */
  .scr#s4{position:relative;}
  .de-left{position:fixed;left:0;top:44px;bottom:54px;z-index:200;transform:translateX(-100%);transition:transform .25s ease;width:82vw;max-width:260px;box-shadow:4px 0 24px rgba(0,0,0,.7);}
  .de-left.open{transform:translateX(0);}
  .de-right{display:none;}
  .de-ctr{flex:1;}
  #de-left-toggle{position:absolute;top:6px;left:6px;z-index:50;}
  .de-view-btns{gap:2px;}
  .de-vbtn{padding:4px 6px;font-size:7px;}

  /* Camera */
  .cam-body{flex-direction:column;}
  .cam-left{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--b);flex-direction:column;}
  .cam-map-wrap{display:none;}
  .cam-list{height:100px;flex-direction:row;overflow-x:auto;overflow-y:hidden;flex:none;}
  .cam-item{min-width:130px;flex-shrink:0;border-right:1px solid var(--b);border-bottom:none;}
  .cam-feed{flex:1;min-height:200px;}
  .cam-right{display:none;}
}

/* ── Drawer close button ── */
.drawer-close{
  display:none;margin-left:auto;background:none;border:none;
  color:var(--tx2);font-size:14px;cursor:pointer;padding:2px 6px;
  line-height:1;flex-shrink:0;
}
@media(max-width:1023px){
  .drawer-close{display:block;}
  /* Ensure screen containers are position:relative for absolute drawers */
  .scr#s2,.scr#s3,.scr#s4{position:relative;overflow:hidden;}
  /* Shift toggle right of any top bar content */
  #dnav-toggle,#nleft-toggle,#de-left-toggle{
    position:absolute;top:48px;left:8px;z-index:50;
  }
  /* Give main view area padding-left so toggle doesn't overlap content */
  .dview,.nctr,.de-ctr{padding-left:0;}
}
@media(max-width:767px){
  #dnav-toggle,#nleft-toggle,#de-left-toggle{
    position:absolute;top:48px;left:8px;z-index:50;
  }
}
</style>
</head>
<body>
<div class="mob-overlay" id="mob-overlay" onclick="closeAllDrawers()"></div>

<!-- HEADER -->
<div id="hdr">
  <div class="hlg">
    <div class="hlm"><div class="lc"></div><div class="lc"></div><div class="lc"></div><div class="lc"></div></div>
    <div><div class="hname">DIMS</div><div class="hsub">Dharavi Infrastructure Management System</div></div>
  </div>
  <div class="hctr"><div class="ldot"></div><span>LIVE TELEMETRY</span><span style="color:var(--tx3);margin:0 4px">|</span><span>SECTOR 4-B · DHARAVI REDEVELOPMENT</span></div>
  <div class="hrgt">
    <div id="htime">--:--:--</div>
  </div>
</div>

<!-- NAV -->
<div id="nav">
  <div class="ntab on" onclick="go('cc')">⬛ Command Center</div>
  <div class="nsep"></div>
  <div class="ntab" onclick="go('detail')">◈ Asset Detail</div>
  <div class="nsep"></div>
  <div class="ntab" onclick="go('net')">⬡ Network View</div>
  <div class="nsep"></div>
  <div class="ntab" onclick="go('decision')">⚡ Decision Engine</div>
  <div class="nsep"></div>
  <div class="ntab" onclick="go('camera')">📷 Camera Feeds</div>
  <button class="sbtn" id="sbtn" onclick="openSim()">⚡ Simulate Event</button>
</div>

<!-- APP -->
<div id="app">

<!-- ═══ SCREEN 1: COMMAND CENTER ═══ -->
<div class="scr on" id="s1">
  <div style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
    <div class="cctop">
      <div class="ccst"><div class="ccst-lbl">Total Buildings</div><div class="ccst-val c-ac" id="st-tot">142</div><div class="ccst-sub">100–150 target</div></div>
      <div class="ccst"><div class="ccst-lbl">Operational</div><div class="ccst-val c-gr" id="st-ok">127</div><div class="ccst-sub">All systems nominal</div></div>
      <div class="ccst"><div class="ccst-lbl">Warnings</div><div class="ccst-val c-am" id="st-warn">12</div><div class="ccst-sub">Monitoring active</div></div>
      <div class="ccst"><div class="ccst-lbl">Critical Alerts</div><div class="ccst-val c-rd" id="st-alert">3</div><div class="ccst-sub">Action required</div></div>
      <div class="ccst"><div class="ccst-lbl">Active Sensors</div><div class="ccst-val c-ac" id="st-sen">1,247</div><div class="ccst-sub">98.4% uptime</div></div>
    </div>
    <div class="ccbody">
      <div class="ccgrid-wrap">
        <div class="ccgrid-title">Building Health Overview — All 142 Assets</div>
        <div id="bgrid"></div>
      </div>
      <div class="cclog">
        <div class="cclog-hd">Event Log — Live Feed</div>
        <div id="evlog"></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 2: ASSET DETAIL ═══ -->
<div class="scr" id="s2">
  <button class="drawer-toggle" id="dnav-toggle" onclick="toggleDrawer('dnav')" title="Navigator">☰</button>
  <!-- LEFT: Navigator -->
  <div class="dnav">
    <div class="dpnl-hd"><span class="dpnl-t">Asset Navigator</span><span class="atag" id="dtag">—</span><button class="drawer-close" onclick="closeAllDrawers()">✕</button></div>
    <div class="dnav-body">

      <!-- Level toggle -->
      <div class="slbl">View Level</div>
      <div class="lvl-tog">
        <div class="lvl-btn" id="lvl-township" onclick="setLevel('township')">Township</div>
        <div class="lvl-btn active" id="lvl-building" onclick="setLevel('building')">Building</div>
        <div class="lvl-btn" id="lvl-floor"    onclick="setLevel('floor')">Floor</div>
        <div class="lvl-btn" id="lvl-unit"     onclick="setLevel('unit')">Unit</div>
      </div>

      <div class="slbl" style="margin-top:10px">Building</div>
      <select id="selB" onchange="onB()">
        <option value="">— Select —</option>
        <option value="B04">B-04 · Residential North</option>
        <option value="B07">B-07 · Mixed Use Tower</option>
        <option value="B11">B-11 · Community Block</option>
        <option value="B15">B-15 · Commercial Podium</option>
        <option value="B22">B-22 · Residential Tower S</option>
      </select>
      <div id="row-floor" style="display:none">
        <div class="slbl" style="margin-top:8px">Floor</div>
        <select id="selF" disabled onchange="onF()"><option value="">— Select —</option></select>
      </div>
      <div id="row-unit" style="display:none">
        <div class="slbl" style="margin-top:8px">Unit</div>
        <select id="selU" disabled onchange="onU()"><option value="">— Select —</option></select>
      </div>

      <!-- Layer toggles -->
      <div class="ndiv" style="margin-top:10px"></div>
      <div class="slbl">Network Layers</div>
      <div class="layer-togs">
        <div class="ltog active" id="ltog-water" onclick="toggleLayer('water')">
          <div class="ltog-dot" style="background:#00b4ff"></div>Water
        </div>
        <div class="ltog" id="ltog-power" onclick="toggleLayer('power')">
          <div class="ltog-dot" style="background:#ffc800"></div>Power
        </div>
        <div class="ltog" id="ltog-drain" onclick="toggleLayer('drain')">
          <div class="ltog-dot" style="background:#00cc66"></div>Drain
        </div>
      </div>

      <div class="ndiv" style="margin-top:10px"></div>
      <div class="slbl">Critical Components</div>
      <div id="bsr-panel">
        <div class="bsr"><span class="bsk">🛗 Lift / Elevator</span><span class="bsv s-ok" id="bsr-lift">OPERATIONAL</span></div>
        <div class="bsr"><span class="bsk">🔥 Fire Suppression</span><span class="bsv s-ok" id="bsr-fire">ARMED</span></div>
        <div class="bsr"><span class="bsk">⚡ Main Elec Panel</span><span class="bsv s-ok" id="bsr-elec">ONLINE</span></div>
        <div class="bsr"><span class="bsk">💧 Water Pump</span><span class="bsv s-warn" id="bsr-pump">⚠ LOW PRESSURE</span></div>
        <div class="bsr"><span class="bsk">🔋 Generator</span><span class="bsv s-ok" id="bsr-gen">STANDBY</span></div>
        <div class="bsr"><span class="bsk">📡 SCADA Link</span><span class="bsv s-ok" id="bsr-scada">LIVE</span></div>
      </div>

    </div>
  </div>

  <!-- CENTRE: 3D Viewer -->
  <div class="dview">
    <div class="vbar">
      <div class="bc-path" id="bcpath"><span>DIMS</span><span class="bc-sep">›</span><span style="color:var(--tx2)">Select an asset to begin</span></div>
      <div class="vctrls">
        <button class="vc on" id="v3d" onclick="setV('3d')">3D</button>
        <button class="vc" onclick="toggleWF()">Wire</button>
      </div>
    </div>
    <div id="evw">
      <div class="eag"><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div><div class="eac"></div></div>
      <div style="color:var(--tx2);font-size:11px;letter-spacing:.06em">SELECT BUILDING → FLOOR → UNIT</div>
      <div style="font-size:9px;color:var(--tx3);margin-top:4px">3D model with network layers will render here</div>
    </div>
    <canvas id="cv3d" style="display:none;"></canvas>
    <div class="vov" id="vov" style="display:none;">
      <div class="vch">BIM: <b id="ovbim">—</b></div>
      <div class="vch">GIS: <b>19.04°N 72.85°E</b></div>
      <div class="vch">LEVEL: <b id="ov-level">—</b></div>
    </div>
    <!-- Floor slice indicator -->
    <div class="floor-indicator" id="floor-indicator" style="display:none">
      <div class="fi-label" id="fi-label">—</div>
      <div class="fi-sub">Isolated view</div>
    </div>
  </div>

  <!-- RIGHT: Params + Meta -->
  <div class="drgt">
    <div class="dtabs">
      <div class="dtab on" onclick="dtab('params')">Params</div>
      <div class="dtab" onclick="dtab('meta')">Metadata</div>
    </div>
    <div class="dtbody" id="dtbody">
      <div class="tp on" id="tp-params">
        <div style="text-align:center;padding:24px 0;font-size:10px;letter-spacing:.04em;color:var(--tx2)">
          ← Select a building, floor or unit<br>to load live parameters
        </div>
      </div>
      <div class="tp" id="tp-meta">
        <div style="text-align:center;color:var(--tx2);padding:24px 0;font-size:10px">No asset loaded</div>
      </div>
    </div>
    <div class="cpnl" id="cpnl" style="display:none;">
      <div class="cbar">
        <div class="cpn">History: <b id="cpn">—</b></div>
        <div class="tbtns">
          <button class="tb on" onclick="setR(this,'1h')">1H</button>
          <button class="tb" onclick="setR(this,'6h')">6H</button>
          <button class="tb" onclick="setR(this,'24h')">24H</button>
          <button class="tb" onclick="setR(this,'7d')">7D</button>
        </div>
      </div>
      <div class="cwrap"><canvas id="sch"></canvas></div>
    </div>
    <div class="aftr ok" id="aftr" style="display:none;">
      <span class="aftag ok" id="aftag">STATUS</span>
      <span class="aftx" id="aftx">—</span>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 3: NETWORK VIEW ═══ -->
<div class="scr" id="s3">
  <button class="drawer-toggle" id="nleft-toggle" onclick="toggleDrawer('nleft')" title="Navigator">☰</button>
  <!-- LEFT: Navigator -->
  <div class="nleft">
    <div class="nleft-hd">
      <span>Network Navigator</span>
      <span class="atag" id="ntag">—</span>
      <button class="drawer-close" onclick="closeAllDrawers()">✕</button>
    </div>
    <div class="nleft-body">

      <div class="nsec">Utility Layer</div>
      <div class="ntog-group">
        <div class="ntog aw" id="tog-w" onclick="setLayer('water')">
          <div class="ntdot nd-w"></div>Water Supply
        </div>
        <div class="ntog" id="tog-p" onclick="setLayer('power')">
          <div class="ntdot nd-p"></div>Power / Electrical
        </div>
        <div class="ntog" id="tog-d" onclick="setLayer('drain')">
          <div class="ntdot nd-d"></div>Drainage & Sewer
        </div>
        <div class="ntog" id="tog-r" onclick="setLayer('road')">
          <div class="ntdot" style="background:#a0c870"></div>Road Network
        </div>
        <div class="ntog" id="tog-i" onclick="setLayer('internet')">
          <div class="ntdot" style="background:#c060ff"></div>Internet / Fibre
        </div>
      </div>

      <!-- Dynamic legend -->
      <div class="nleg" id="nleg">
        <div class="nleg-t">Legend</div>
        <div class="nleg-r"><div class="ll m" style="background:#00b4ff"></div>Main Line</div>
        <div class="nleg-r"><div class="ll br" style="border-color:#00b4ff66"></div>Branch / Secondary</div>
        <div class="nleg-r"><div style="width:9px;height:9px;border-radius:50%;background:#00b4ff22;border:1.5px solid #00b4ff;flex-shrink:0"></div>Junction / Node</div>
        <div class="nleg-r"><div style="width:9px;height:9px;background:#0e1820;border:1px solid #2a4060;flex-shrink:0"></div>Building</div>
        <div class="nleg-r"><div style="width:9px;height:9px;border-radius:50%;background:#ff3d3d33;border:1.5px solid #ff3d3d;flex-shrink:0"></div>Fault / Alert</div>
        <div class="nleg-r"><div style="width:9px;height:9px;border-radius:50%;background:#ffb30033;border:1.5px solid #ffb300;flex-shrink:0"></div>Warning</div>
        <div class="nleg-r"><div style="width:9px;height:9px;border-radius:50%;background:#00663322;border:1.5px solid #00cc66;flex-shrink:0"></div>Source / Plant</div>
      </div>

      <div class="ndiv"></div>
      <div class="nsec">Asset Navigator</div>
      <input class="asrch" id="asrch" placeholder="Search node ID or building..." oninput="filterTree(this.value)">
      <div class="nsec" style="margin-top:8px;font-size:7px">Jump to Building</div>
      <select class="asrch" id="net-bldg-sel" style="margin-bottom:4px" onchange="netJumpToBuilding(this.value)">
        <option value="">— Select building —</option>
        <option value="B04">B04 · Residential North</option>
        <option value="B07">B07 · Mixed Use Tower</option>
        <option value="B11">B11 · Community Block</option>
        <option value="B15">B15 · Commercial Podium</option>
        <option value="B22">B22 · Residential Tower S</option>
      </select>
      <div class="atree" id="atree"></div>

    </div>
  </div>

  <!-- CENTER: Map canvas with terrain background -->
  <div class="nctr" style="position:relative">
    <div class="ntbar">
      <div class="nttitle">
        Sector 4-B &mdash; <span id="nlname">Water Supply & Distribution</span>
        <span class="ntag-live">● LIVE</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <div class="n-bg-togs">
          <div class="n-bg-btn active" id="nbg-terrain" onclick="setBG('terrain')">Terrain</div>
          <div class="n-bg-btn" id="nbg-satellite" onclick="setBG('satellite')">Satellite</div>
          <div class="n-bg-btn" id="nbg-schematic" onclick="setBG('schematic')">Schematic</div>
        </div>
        <div class="nzbtns">
          <button class="nzb" onclick="nzoom(1.2)">＋</button>
          <button class="nzb" onclick="nzoom(0.83)">－</button>
          <button class="nzb" onclick="nreset()">⌂</button>
        </div>
      </div>
    </div>
    <!-- Background terrain canvas -->
    <canvas id="ncv-bg" style="position:absolute;top:38px;left:0;right:0;bottom:26px;width:100%;pointer-events:none"></canvas>
    <!-- Network canvas -->
    <canvas id="ncv" style="position:absolute;top:38px;left:0;right:0;bottom:26px;width:100%"></canvas>
    <div class="nstbar" style="position:absolute;bottom:0;left:0;right:0">
      <div class="nsi"><div class="nsdot" style="background:var(--gr)"></div><span class="nslbl">Nodes:</span><span class="nsval" id="nst1">—</span></div>
      <div class="nsi"><div class="nsdot" style="background:var(--ac)"></div><span class="nslbl">Links:</span><span class="nsval" id="nst2">—</span></div>
      <div class="nsi"><div class="nsdot" style="background:var(--am)"></div><span class="nslbl">Warnings:</span><span class="nsval" id="nst3">0</span></div>
      <div class="nsi"><div class="nsdot" style="background:var(--rd)"></div><span class="nslbl">Faults:</span><span class="nsval" id="nst4">0</span></div>
      <div style="margin-left:auto;font-size:8px;color:var(--tx3);letter-spacing:.1em">GIS · SCADA · BIM · LIVE</div>
    </div>
  </div>

  <!-- RIGHT: Node detail + sensor controls -->
  <div class="nrgt">
    <div class="nrgt-hd">
      <span>Node Detail</span>
      <div class="ldot" style="width:5px;height:5px"></div>
    </div>
    <div class="nrgt-body" id="ndetail">
      <div class="ni-empty" style="color:var(--tx2);font-size:10px;letter-spacing:.04em">Click any node<br>on the network<br>to view its details</div>
    </div>
  </div>

</div><!-- end s3 -->

<!-- ═══ SCREEN 4: DECISION ENGINE ═══ -->
<div class="scr" id="s4">
  <button class="drawer-toggle" id="de-left-toggle" onclick="toggleDrawer('de-left')" title="Layers">☰</button>
  <!-- LEFT: Utility layer selector + live sensor watch -->
  <div class="de-left">
    <div class="de-left-hd">Decision Engine <button class="drawer-close" onclick="closeAllDrawers()">✕</button></div>
    <div class="de-left-body">

      <div class="de-sec-lbl">Utility Layer</div>
      <div class="de-uc-btns">
        <div class="de-uc-btn" id="de-btn-drain" onclick="deSelectLayer('drain')">
          <div class="de-uc-icon">🌧</div>
          <div class="de-uc-info">
            <div class="de-uc-name">Drainage & Sewer</div>
            <div class="de-uc-sub">Drain levels · overflow risk</div>
          </div>
          <div class="de-uc-badge" id="de-badge-drain">—</div>
        </div>
        <div class="de-uc-btn" id="de-btn-power" onclick="deSelectLayer('power')">
          <div class="de-uc-icon">⚡</div>
          <div class="de-uc-info">
            <div class="de-uc-name">Power / Electrical</div>
            <div class="de-uc-sub">Feeder load · fault status</div>
          </div>
          <div class="de-uc-badge" id="de-badge-power">—</div>
        </div>
        <div class="de-uc-btn" id="de-btn-water" onclick="deSelectLayer('water')">
          <div class="de-uc-icon">💧</div>
          <div class="de-uc-info">
            <div class="de-uc-name">Water Supply</div>
            <div class="de-uc-sub">Pressure · flow · valves</div>
          </div>
          <div class="de-uc-badge" id="de-badge-water">—</div>
        </div>
      </div>

      <div class="de-sec-lbl" style="margin-top:14px">Live Sensor Watch</div>
      <div class="de-watch-list" id="de-watch-list"></div>

    </div>
  </div>

  <!-- CENTRE: 3D Site View -->
  <div class="de-view">
    <div class="de-view-hd">
      <span id="de-view-title">Decision Engine — Select a utility layer</span>
      <div style="display:flex;gap:5px;align-items:center">
        <span class="de-view-hint" id="de-view-hint">Drag to rotate · Scroll to zoom</span>
        <div class="de-view-btns">
          <div class="de-vbtn active" id="de-vbtn-bim" onclick="deSetView('bim')">BIM</div>
          <div class="de-vbtn" id="de-vbtn-gis" onclick="deSetView('gis')">GIS</div>
          <div class="de-vbtn" id="de-vbtn-scada" onclick="deSetView('scada')">SCADA</div>
        </div>
      </div>
    </div>
    <canvas id="de3d" style="flex:1;display:block;cursor:grab"></canvas>
    <canvas id="de-gis-cv" style="flex:1;display:none;cursor:crosshair"></canvas>
    <div id="de-scada-panel" style="flex:1;display:none;overflow-y:auto;padding:14px;"></div>
    <!-- Event callout overlaid on canvas -->
    <div class="de-callout" id="de-callout" style="display:none">
      <div class="de-callout-id" id="de-callout-id">—</div>
      <div class="de-callout-val" id="de-callout-val">—</div>
    </div>
  </div>

  <!-- RIGHT SPLIT: Failure Detail top + Impact Assessment bottom -->
  <div class="de-right-col">

    <!-- Failure Detail table -->
    <div class="de-panel de-panel-top">
      <div class="de-panel-hd">
        <span>📡 Failure Detail</span>
        <span class="de-panel-sub" id="de-fail-sub">—</span>
      </div>
      <div class="de-panel-body" id="de-fail-body">
        <div class="de-empty" style="color:var(--tx2);font-size:10px">Select a scenario<br>from the left panel</div>
      </div>
    </div>

    <!-- Impact Assessment table -->
    <div class="de-panel de-panel-bot">
      <div class="de-panel-hd">
        <span>🏗 Impact Assessment</span>
        <span class="de-panel-sub" id="de-impact-sub">—</span>
      </div>
      <div class="de-panel-body" id="de-impact-body">
        <div class="de-empty" style="color:var(--tx2);font-size:10px">Select a scenario<br>from the left panel</div>
      </div>
      <!-- Action buttons -->
      <div class="de-actions" id="de-actions" style="display:none"></div>
    </div>

  </div>

</div><!-- end s4 -->


<!-- ═══ SCREEN 5: CAMERA FEEDS ═══ -->
<div class="scr" id="s5">

  <!-- LEFT: 300px — site map + camera list -->
  <div class="cam-nav">
    <div class="cam-nav-hd">
      <span class="dpnl-t">📷 Camera Navigator</span>
      <span class="atag" id="cam-tag">—</span>
    </div>
    <div class="cam-nav-body">
      <div class="cam-sec-lbl">SITE MAP — click a camera</div>
      <div class="cam-map-wrap"><canvas id="cam-map"></canvas></div>
      <div class="cam-legend">
        <div class="cam-leg-r"><div class="cam-leg-dot" style="background:#00e676"></div>Live</div>
        <div class="cam-leg-r"><div class="cam-leg-dot" style="background:#ff3d3d"></div>Alert</div>
        <div class="cam-leg-r"><div class="cam-leg-dot" style="background:#ffb300"></div>Warn</div>
        <div class="cam-leg-r"><div class="cam-leg-dot" style="background:#333"></div>Offline</div>
      </div>
      <div class="cam-sec-lbl" style="margin-top:6px">CAMERA LIST</div>
      <div id="cam-list"></div>
    </div>
  </div>

  <!-- RIGHT: feed -->
  <div class="cam-feed-area">
    <div class="cam-feed-hd">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="ldot" id="cam-status-dot" style="background:#333;width:7px;height:7px;border-radius:50%"></div>
        <span id="cam-feed-title" style="font-size:11px;color:var(--tx2);letter-spacing:.06em">Select a camera</span>
      </div>
      <div style="display:flex;gap:4px">
        <div class="cam-ctrl" id="cam-motion-btn" onclick="camToggleMotion()">◈ MOTION</div>
        <div class="cam-ctrl" id="cam-thermal-btn" onclick="camToggleThermal()">⊞ THERMAL</div>
      </div>
    </div>
    <div class="cam-canvas-wrap" id="cam-canvas-wrap">
      <canvas id="cam-cv"></canvas>
      <div class="cam-ol cam-ol-tl" id="cam-ol-tl"></div>
      <div class="cam-ol cam-ol-tr" id="cam-ol-tr"></div>
      <div class="cam-ol cam-ol-bl" id="cam-ol-bl">● REC</div>
      <div class="cam-no-feed" id="cam-no-feed">
        <div style="font-size:32px;margin-bottom:10px">📷</div>
        <div style="font-size:11px;color:var(--tx2)">Select a camera to view live feed</div>
        <div style="font-size:9px;color:var(--tx3);margin-top:6px">12 cameras · Sector 4-B</div>
      </div>
    </div>
    <div class="cam-inc-bar">
      <div class="cam-inc-bar-lbl">INCIDENTS</div>
      <div id="cam-incidents"></div>
    </div>
  </div>

</div><!-- end s5 -->

</div><!-- end app -->





<!-- SIM MODAL -->
<div id="simov">
  <div class="smod-full">

    <!-- Header -->
    <div class="sfull-hd">
      <div>
        <div class="sfull-title">⚡ Event Simulation &amp; Modelling</div>
        <div class="sfull-sub">Select scenario · Adjust parameters · Preview impact in 2D / 3D</div>
      </div>
      <button class="sim-close-btn" onclick="closeSim()">✕ Close</button>
    </div>

    <div class="sfull-body">

      <!-- LEFT: Scenario cards -->
      <div class="sfull-left">
        <div class="sfull-sec">Scenario</div>
        <div class="sim-cards">
          <div class="sim-card active" id="scard-flood" onclick="selectScenario('flood')">
            <div class="sim-card-icon">🌧</div>
            <div class="sim-card-info">
              <div class="sim-card-name">Flood Model</div>
              <div class="sim-card-sub">Rainfall &amp; drainage analysis</div>
            </div>
            <div class="sim-card-badge warn" id="scbadge-flood">RISK</div>
          </div>
          <div class="sim-card" id="scard-power" onclick="selectScenario('power')">
            <div class="sim-card-icon">⚡</div>
            <div class="sim-card-info">
              <div class="sim-card-name">Power Failure</div>
              <div class="sim-card-sub">Feeder trip cascade</div>
            </div>
            <div class="sim-card-badge ok" id="scbadge-power">NOMINAL</div>
          </div>
          <div class="sim-card" id="scard-water" onclick="selectScenario('water')">
            <div class="sim-card-icon">💧</div>
            <div class="sim-card-info">
              <div class="sim-card-name">Water Pressure</div>
              <div class="sim-card-sub">Pressure drop scenario</div>
            </div>
            <div class="sim-card-badge ok" id="scbadge-water">NOMINAL</div>
          </div>
          <div class="sim-card" id="scard-fire" onclick="selectScenario('fire')">
            <div class="sim-card-icon">🔥</div>
            <div class="sim-card-info">
              <div class="sim-card-name">Fire Detection</div>
              <div class="sim-card-sub">Smoke / heat trigger</div>
            </div>
            <div class="sim-card-badge ok" id="scbadge-fire">NOMINAL</div>
          </div>
        </div>

        <!-- Computed summary -->
        <div class="sfull-sec" style="margin-top:14px">Impact Summary</div>
        <div class="sim-summary" id="sim-summary">
          <div class="sim-sum-row"><span>Peak Level</span><span class="sim-sum-val" id="ss-level">—</span></div>
          <div class="sim-sum-row"><span>Buildings at Risk</span><span class="sim-sum-val warn" id="ss-bldgs">—</span></div>
          <div class="sim-sum-row"><span>Flood Area</span><span class="sim-sum-val" id="ss-area">—</span></div>
          <div class="sim-sum-row"><span>Risk Level</span><span class="sim-sum-val" id="ss-risk">—</span></div>
        </div>

        <button class="sbtn" style="width:100%;margin-top:12px" id="sim-run-btn"
          onclick="commitSimulation()">▶ Run Simulation</button>
      </div>

      <!-- CENTRE: Parameters -->
      <div class="sfull-centre">
        <div class="sfull-sec">Parameters</div>
        <div id="sim-params-panel"></div>
      </div>

      <!-- RIGHT: Live preview -->
      <div class="sfull-right">
        <div class="sfull-sec-row">
          <div class="sfull-sec">Live Preview</div>
          <div class="sim-view-togs">
            <div class="sim-vtog active" id="svtog-2d" onclick="simSetView('2d')">2D</div>
            <div class="sim-vtog" id="svtog-3d" onclick="simSetView('3d')">3D</div>
          </div>
        </div>
        <div class="sim-view-wrap">
          <canvas id="sim-cv2d" style="display:block"></canvas>
          <canvas id="sim-cv3d" style="display:none"></canvas>
          <!-- Overlay info -->
          <div class="sim-view-info" id="sim-view-info"></div>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
// ══════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════
const BDATA = {
  B04:{name:'B-04 · Residential Block North',floors:{F01:'Floor 1',F02:'Floor 2',F03:'Floor 3',F04:'Floor 4',F05:'Floor 5',RF:'Terrace'},flats:{F01:['101','102','103'],F02:['201','202','203'],F03:['301','302','303'],F04:['401','402'],F05:['501','502'],RF:['RT-A']},h:6,col:0x00c8ff},
  B07:{name:'B-07 · Mixed Use Tower',floors:{B1:'Basement',GF:'Ground',F01:'Floor 1',F02:'Floor 2',F03:'Floor 3',F04:'Floor 4',F05:'Floor 5',F06:'Floor 6',F07:'Floor 7',F08:'Floor 8',F09:'Floor 9',F10:'Floor 10'},flats:{B1:['PARK-01','UTIL-01'],GF:['SHOP-01','LOBBY'],F01:['101','102'],F02:['201','202'],F03:['301','302'],F04:['401','402'],F05:['501','502'],F06:['601','602'],F07:['701','702'],F08:['801'],F09:['901'],F10:['PENTHOUSE']},h:12,col:0x00ff99},
  B11:{name:'B-11 · Community Block East',floors:{GF:'Ground',F01:'Floor 1',F02:'Floor 2',F03:'Floor 3'},flats:{GF:['HEALTH','COMM-HALL'],F01:['101','102'],F02:['201','202'],F03:['301','302']},h:4,col:0xffb300},
  B15:{name:'B-15 · Commercial Podium',floors:{B2:'Basement -2',B1:'Basement -1',GF:'Ground',F01:'Mezzanine',F02:'Floor 2'},flats:{B2:['PARK-A1','SUMP-ROOM'],B1:['PARK-B1','PARK-B2'],GF:['RETAIL-01','RETAIL-02','LOBBY'],F01:['FOOD-COURT'],F02:['OFFICE-01','OFFICE-02']},h:5,col:0xcc66ff},
  B22:{name:'B-22 · Residential Tower S',floors:{B1:'Basement',GF:'Ground + Lobby',F01:'Floor 1',F02:'Floor 2',F03:'Floor 3',F04:'Floor 4',F05:'Floor 5',F06:'Floor 6',F07:'Floor 7',F08:'Floor 8'},flats:{B1:['PUMP-ROOM','SUMP'],GF:['LOBBY'],F01:['101','102','103'],F02:['201','202','203'],F03:['301','302','303'],F04:['401','402'],F05:['501','502'],F06:['601','602'],F07:['701','702'],F08:['PENTHOUSE-N','PENTHOUSE-S']},h:10,col:0xff6644}
};

// 142 buildings
const BLDGS = [];
const STATS = ['ok','ok','ok','ok','ok','ok','ok','ok','ok','warn','warn','alert'];
for(let i=1;i<=142;i++){
  BLDGS.push({id:'B'+String(i).padStart(2,'0'),floors:Math.floor(Math.random()*14+2),status:STATS[Math.floor(Math.random()*STATS.length)]});
}
[3,10,20].forEach(i=>BLDGS[i].status='alert');
[6,13,24].forEach(i=>BLDGS[i].status='warn');

// Network data - nodes positioned as fraction of canvas (0..1)
const NDATA = {
  water: {
    nodes:[
      {id:'RES-01',x:.06,y:.5,lbl:'Water Reservoir',type:'source',st:'ok',pressure:'3.4 bar',flow:'240 L/min'},
      {id:'JN-W1', x:.22,y:.2,lbl:'Junction W1',type:'jct',st:'ok',pressure:'3.1 bar',flow:'120 L/min'},
      {id:'JN-W2', x:.22,y:.5,lbl:'Junction W2',type:'jct',st:'warn',pressure:'1.3 bar',flow:'45 L/min'},
      {id:'JN-W3', x:.22,y:.8,lbl:'Junction W3',type:'jct',st:'ok',pressure:'2.9 bar',flow:'95 L/min'},
      {id:'VLV-01',x:.38,y:.5,lbl:'Isolation Valve',type:'valve',st:'warn',pressure:'—',flow:'PARTIAL'},
      {id:'JN-W4', x:.52,y:.18,lbl:'Junction W4',type:'jct',st:'ok',pressure:'3.0 bar',flow:'110 L/min'},
      {id:'JN-W5', x:.52,y:.5,lbl:'Junction W5',type:'jct',st:'ok',pressure:'2.8 bar',flow:'88 L/min'},
      {id:'JN-W6', x:.52,y:.82,lbl:'Junction W6',type:'jct',st:'ok',pressure:'2.7 bar',flow:'76 L/min'},
      {id:'TNK-01',x:.38,y:.06,lbl:'Overhead Tank 1',type:'tank',st:'ok',pressure:'3.2 bar',flow:'—'},
      {id:'JN-W7', x:.72,y:.3,lbl:'Junction W7',type:'jct',st:'ok',pressure:'2.9 bar',flow:'92 L/min'},
      {id:'JN-W8', x:.72,y:.7,lbl:'Junction W8',type:'jct',st:'ok',pressure:'2.6 bar',flow:'70 L/min'},
      {id:'STP-01',x:.92,y:.5,lbl:'STP Plant',type:'source',st:'ok',pressure:'3.1 bar',flow:'180 L/min'},
      {id:'B04',x:.35,y:.3,lbl:'B-04',type:'bldg',st:'warn',floors:6},
      {id:'B07',x:.62,y:.2,lbl:'B-07',type:'bldg',st:'ok',floors:12},
      {id:'B11',x:.62,y:.5,lbl:'B-11',type:'bldg',st:'ok',floors:4},
      {id:'B22',x:.62,y:.75,lbl:'B-22',type:'bldg',st:'alert',floors:10},
      {id:'B15',x:.82,y:.45,lbl:'B-15',type:'bldg',st:'ok',floors:5},
    ],
    edges:[
      {a:'RES-01',b:'JN-W1',m:1},{a:'RES-01',b:'JN-W2',m:1},{a:'RES-01',b:'JN-W3',m:1},
      {a:'JN-W1',b:'JN-W4',m:1},{a:'JN-W1',b:'TNK-01',m:0},
      {a:'JN-W2',b:'VLV-01',m:1},{a:'VLV-01',b:'JN-W5',m:1},
      {a:'JN-W3',b:'JN-W6',m:1},
      {a:'JN-W4',b:'JN-W7',m:1},{a:'JN-W5',b:'JN-W7',m:0},{a:'JN-W5',b:'JN-W8',m:1},{a:'JN-W6',b:'JN-W8',m:0},
      {a:'JN-W7',b:'STP-01',m:1},{a:'JN-W8',b:'STP-01',m:1},
      {a:'JN-W2',b:'B04',m:0},{a:'JN-W4',b:'B07',m:0},{a:'JN-W5',b:'B11',m:0},{a:'JN-W6',b:'B22',m:0},{a:'JN-W7',b:'B15',m:0},
    ]
  },
  power: {
    nodes:[
      {id:'SUB-A',x:.07,y:.25,lbl:'Substation A',type:'source',st:'ok',voltage:'11kV',load:'340 kW'},
      {id:'SUB-B',x:.07,y:.7,lbl:'Substation B',type:'source',st:'alert',voltage:'11kV',load:'FAULT'},
      {id:'TR-01',x:.25,y:.15,lbl:'Transformer 1',type:'jct',st:'ok',voltage:'415V',load:'180 kW'},
      {id:'TR-02',x:.25,y:.55,lbl:'Transformer 2',type:'jct',st:'alert',voltage:'FAIL',load:'OFFLINE'},
      {id:'TR-03',x:.25,y:.82,lbl:'Transformer 3',type:'jct',st:'ok',voltage:'415V',load:'210 kW'},
      {id:'DB-01',x:.48,y:.1,lbl:'Dist. Board 1',type:'jct',st:'ok',voltage:'415V',load:'90 kW'},
      {id:'DB-02',x:.48,y:.38,lbl:'Dist. Board 2',type:'jct',st:'warn',voltage:'410V',load:'87%'},
      {id:'DB-03',x:.48,y:.65,lbl:'Dist. Board 3',type:'jct',st:'ok',voltage:'415V',load:'72 kW'},
      {id:'DB-04',x:.48,y:.88,lbl:'Dist. Board 4',type:'jct',st:'ok',voltage:'415V',load:'65 kW'},
      {id:'DB-05',x:.72,y:.25,lbl:'Dist. Board 5',type:'jct',st:'ok',voltage:'415V',load:'95 kW'},
      {id:'DB-06',x:.72,y:.6,lbl:'Dist. Board 6',type:'jct',st:'ok',voltage:'415V',load:'88 kW'},
      {id:'GEN-01',x:.9,y:.15,lbl:'DG Set 1',type:'source',st:'ok',voltage:'415V',load:'STANDBY'},
      {id:'GEN-02',x:.9,y:.6,lbl:'DG Set 2',type:'source',st:'ok',voltage:'415V',load:'STANDBY'},
      {id:'B06',x:.62,y:.15,lbl:'B-06',type:'bldg',st:'alert',floors:8},
      {id:'B07',x:.62,y:.4,lbl:'B-07',type:'bldg',st:'ok',floors:12},
      {id:'B15',x:.62,y:.65,lbl:'B-15',type:'bldg',st:'ok',floors:5},
      {id:'B11',x:.62,y:.88,lbl:'B-11',type:'bldg',st:'ok',floors:4},
    ],
    edges:[
      {a:'SUB-A',b:'TR-01',m:1},{a:'SUB-B',b:'TR-02',m:1},{a:'SUB-B',b:'TR-03',m:1},
      {a:'TR-01',b:'DB-01',m:1},{a:'TR-01',b:'DB-02',m:0},
      {a:'TR-02',b:'DB-02',m:1},{a:'TR-02',b:'DB-03',m:1},
      {a:'TR-03',b:'DB-03',m:0},{a:'TR-03',b:'DB-04',m:1},
      {a:'DB-01',b:'DB-05',m:1},{a:'DB-02',b:'DB-05',m:0},
      {a:'DB-03',b:'DB-06',m:1},{a:'DB-05',b:'GEN-01',m:0},{a:'DB-06',b:'GEN-02',m:0},
      {a:'DB-01',b:'B06',m:0},{a:'DB-05',b:'B07',m:0},{a:'DB-06',b:'B15',m:0},{a:'DB-04',b:'B11',m:0},
    ]
  },
  drain: {
    nodes:[
      {id:'STP-D1',x:.88,y:.25,lbl:'STP Inlet 1',type:'source',st:'ok',flow:'180 L/min',level:'1.2m'},
      {id:'STP-D2',x:.88,y:.75,lbl:'STP Inlet 2',type:'source',st:'ok',flow:'160 L/min',level:'1.1m'},
      {id:'MH-01',x:.68,y:.12,lbl:'Manhole 1',type:'jct',st:'ok',flow:'95 L/min',level:'0.8m'},
      {id:'MH-02',x:.68,y:.42,lbl:'Manhole 2',type:'jct',st:'warn',flow:'140 L/min',level:'1.6m'},
      {id:'MH-03',x:.68,y:.72,lbl:'Manhole 3',type:'jct',st:'ok',flow:'88 L/min',level:'0.9m'},
      {id:'MH-04',x:.45,y:.2,lbl:'Manhole 4',type:'jct',st:'ok',flow:'72 L/min',level:'0.7m'},
      {id:'MH-05',x:.45,y:.55,lbl:'Manhole 5',type:'jct',st:'alert',flow:'210 L/min',level:'2.1m'},
      {id:'MH-06',x:.45,y:.82,lbl:'Manhole 6',type:'jct',st:'ok',flow:'80 L/min',level:'0.8m'},
      {id:'MH-07',x:.22,y:.35,lbl:'Manhole 7',type:'jct',st:'ok',flow:'65 L/min',level:'0.6m'},
      {id:'MH-08',x:.22,y:.68,lbl:'Manhole 8',type:'jct',st:'ok',flow:'70 L/min',level:'0.7m'},
      {id:'PUMP-01',x:.07,y:.5,lbl:'Pump Station',type:'valve',st:'ok',flow:'ACTIVE',level:'—'},
      {id:'RET-01',x:.3,y:.92,lbl:'Retention Tank',type:'tank',st:'ok',flow:'BUFFER',level:'2.4m'},
      {id:'B22',x:.55,y:.42,lbl:'B-22',type:'bldg',st:'alert',floors:10},
      {id:'B11',x:.55,y:.65,lbl:'B-11',type:'bldg',st:'ok',floors:4},
      {id:'B04',x:.3,y:.55,lbl:'B-04',type:'bldg',st:'warn',floors:6},
    ],
    edges:[
      {a:'MH-04',b:'MH-01',m:1},{a:'MH-05',b:'MH-02',m:1},{a:'MH-05',b:'MH-03',m:1},
      {a:'MH-04',b:'MH-07',m:1},{a:'MH-05',b:'MH-07',m:0},{a:'MH-05',b:'MH-08',m:1},{a:'MH-06',b:'MH-08',m:1},
      {a:'MH-07',b:'PUMP-01',m:1},{a:'MH-08',b:'PUMP-01',m:1},
      {a:'MH-01',b:'STP-D1',m:1},{a:'MH-02',b:'STP-D1',m:0},{a:'MH-03',b:'STP-D2',m:1},
      {a:'MH-06',b:'RET-01',m:0},
      {a:'MH-05',b:'B22',m:0},{a:'MH-06',b:'B11',m:0},{a:'MH-08',b:'B04',m:0},
    ]
  }
};

// Road network
NDATA.road = {
  nodes:[
    {id:'RD-N1', x:.5, y:.04,lbl:'North Gate',     type:'jct',  st:'ok'},
    {id:'RD-N2', x:.5, y:.18,lbl:'Junction N',     type:'jct',  st:'ok'},
    {id:'RD-C1', x:.25,y:.5, lbl:'Central Cross W',type:'jct',  st:'ok'},
    {id:'RD-C2', x:.5, y:.5, lbl:'Central Cross',  type:'jct',  st:'ok'},
    {id:'RD-C3', x:.75,y:.5, lbl:'Central Cross E',type:'jct',  st:'ok'},
    {id:'RD-S1', x:.5, y:.82,lbl:'Junction S',     type:'jct',  st:'warn'},
    {id:'RD-S2', x:.5, y:.96,lbl:'South Gate',     type:'jct',  st:'ok'},
    {id:'RD-E1', x:.96,y:.5, lbl:'East Gate',      type:'source',st:'ok'},
    {id:'RD-W1', x:.04,y:.5, lbl:'West Gate',      type:'source',st:'ok'},
    {id:'RD-BZ', x:.25,y:.25,lbl:'Zone A Access',  type:'jct',  st:'ok'},
    {id:'RD-CZ', x:.75,y:.25,lbl:'Zone B Access',  type:'jct',  st:'ok'},
    {id:'RD-DZ', x:.25,y:.75,lbl:'Zone C Access',  type:'jct',  st:'warn'},
    {id:'RD-EZ', x:.75,y:.75,lbl:'Zone D Access',  type:'jct',  st:'ok'},
  ],
  edges:[
    {a:'RD-N1',b:'RD-N2',m:true},{a:'RD-N2',b:'RD-C2',m:true},
    {a:'RD-C2',b:'RD-S1',m:true},{a:'RD-S1',b:'RD-S2',m:true},
    {a:'RD-W1',b:'RD-C1',m:true},{a:'RD-C1',b:'RD-C2',m:true},
    {a:'RD-C2',b:'RD-C3',m:true},{a:'RD-C3',b:'RD-E1',m:true},
    {a:'RD-N2',b:'RD-BZ',m:false},{a:'RD-BZ',b:'RD-C1',m:false},
    {a:'RD-N2',b:'RD-CZ',m:false},{a:'RD-CZ',b:'RD-C3',m:false},
    {a:'RD-S1',b:'RD-DZ',m:false},{a:'RD-DZ',b:'RD-C1',m:false},
    {a:'RD-S1',b:'RD-EZ',m:false},{a:'RD-EZ',b:'RD-C3',m:false},
  ]
};

// Internet / fibre network
NDATA.internet = {
  nodes:[
    {id:'NOC-01',x:.5, y:.5, lbl:'Network NOC',      type:'source',st:'ok',  load:'98% uptime'},
    {id:'SW-A',  x:.22,y:.22,lbl:'Switch Zone A',    type:'jct',   st:'ok',  load:'12 Gbps'},
    {id:'SW-B',  x:.78,y:.22,lbl:'Switch Zone B',    type:'jct',   st:'warn',load:'8.4 Gbps'},
    {id:'SW-C',  x:.22,y:.78,lbl:'Switch Zone C',    type:'jct',   st:'ok',  load:'6 Gbps'},
    {id:'SW-D',  x:.78,y:.78,lbl:'Switch Zone D',    type:'jct',   st:'ok',  load:'4 Gbps'},
    {id:'FBR-01',x:.08,y:.3, lbl:'Fibre POP 1',      type:'source',st:'ok',  load:'40 Gbps'},
    {id:'FBR-02',x:.92,y:.7, lbl:'Fibre POP 2',      type:'source',st:'ok',  load:'40 Gbps'},
    {id:'AP-A1', x:.14,y:.15,lbl:'AP Cluster A1',    type:'valve', st:'ok',  load:'340 Mbps'},
    {id:'AP-B1', x:.86,y:.15,lbl:'AP Cluster B1',    type:'valve', st:'warn',load:'890 Mbps'},
    {id:'AP-C1', x:.14,y:.85,lbl:'AP Cluster C1',    type:'valve', st:'ok',  load:'210 Mbps'},
    {id:'AP-D1', x:.86,y:.85,lbl:'AP Cluster D1',    type:'valve', st:'ok',  load:'190 Mbps'},
    {id:'CCTV-HUB',x:.5,y:.15,lbl:'CCTV Hub',        type:'tank',  st:'ok',  load:'1.2 Gbps'},
  ],
  edges:[
    {a:'FBR-01',b:'NOC-01',m:true},{a:'FBR-02',b:'NOC-01',m:true},
    {a:'NOC-01',b:'SW-A',m:true},{a:'NOC-01',b:'SW-B',m:true},
    {a:'NOC-01',b:'SW-C',m:true},{a:'NOC-01',b:'SW-D',m:true},
    {a:'SW-A',b:'AP-A1',m:false},{a:'SW-B',b:'AP-B1',m:false},
    {a:'SW-C',b:'AP-C1',m:false},{a:'SW-D',b:'AP-D1',m:false},
    {a:'SW-A',b:'CCTV-HUB',m:false},{a:'SW-B',b:'CCTV-HUB',m:false},
    {a:'FBR-01',b:'SW-A',m:false},{a:'FBR-02',b:'SW-D',m:false},
  ]
};

const LCOLS = {water:'#00b4ff',power:'#ffc800',drain:'#50dc78',road:'#a0c870',internet:'#c060ff'};
const LNAMES = {water:'Water Supply & Distribution',power:'Power / Electrical Network',drain:'Drainage & Sewer Network',road:'Road Network',internet:'Internet / Fibre Network'};

// ══════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════
let curLayer = 'water';
let netZ = 1, nox = 0, noy = 0;
let nDrag = false, nLX = 0, nLY = 0;
let hovNode = null, selNode = null;
let faultNodes = [], faultEdges = [];
let netReady = false;

let S = {b:null,f:null,u:null,params:null,selP:null,level:'building'};
let three = {scene:null,cam:null,rend:null,af:null,wf:false};
let camT=0.9,camP=0.9,camR=18;
let chart = null;

// ══════════════════════════════════════════════════
// CLOCK
// ══════════════════════════════════════════════════
setInterval(()=>document.getElementById('htime').textContent=new Date().toLocaleTimeString('en-GB'),1000);
document.getElementById('htime').textContent=new Date().toLocaleTimeString('en-GB');

// ══════════════════════════════════════════════════
// SCREEN ROUTING - single function, handles all 3
// ══════════════════════════════════════════════════
function go(id) {
  if(typeof closeAllDrawers==='function') closeAllDrawers();
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('on'));
  if(id==='cc') {
    document.getElementById('s1').classList.add('on');
    document.querySelectorAll('.ntab')[0].classList.add('on');
  } else if(id==='detail') {
    document.getElementById('s2').classList.add('on');
    document.querySelectorAll('.ntab')[1].classList.add('on');
  } else if(id==='net') {
    document.getElementById('s3').classList.add('on');
    document.querySelectorAll('.ntab')[2].classList.add('on');
    setTimeout(initNet, 50);
  } else if(id==='decision') {
    document.getElementById('s4').classList.add('on');
    document.querySelectorAll('.ntab')[3].classList.add('on');
    setTimeout(onDETabOpen, 50);
  } else if(id==='camera') {
    document.getElementById('s5').classList.add('on');
    document.querySelectorAll('.ntab')[4].classList.add('on');
    setTimeout(initCamScreen, 80);
  }
}

// ══════════════════════════════════════════════════
// COMMAND CENTER
// ══════════════════════════════════════════════════
function renderGrid() {
  const g = document.getElementById('bgrid');
  g.innerHTML = '';
  let ok=0,warn=0,al=0;
  BLDGS.forEach(b=>{
    if(b.status==='ok')ok++;else if(b.status==='warn')warn++;else al++;
    const el=document.createElement('div');
    el.className='bc '+b.status;
    el.id='bc-'+b.id;
    el.innerHTML=`<div class="bdot ${b.status}"></div><div class="bid">${b.id}</div><div class="bfl">${b.floors}F</div><div class="bbar ${b.status}"></div>`;
    el.onclick=()=>{
      if(BDATA[b.id]){document.getElementById('selB').value=b.id;onB();}
      go('detail');
    };
    g.appendChild(el);
  });
  updateStats(ok,warn,al);
}

function updateStats(ok,warn,al) {
  if(ok===undefined){let o=0,w=0,a=0;BLDGS.forEach(b=>{if(b.status==='ok')o++;else if(b.status==='warn')w++;else a++;});ok=o;warn=w;al=a;}
  document.getElementById('st-ok').textContent=ok;
  document.getElementById('st-warn').textContent=warn;
  document.getElementById('st-alert').textContent=al;
  if(document.getElementById('ha'))document.getElementById('ha').textContent=al;
}

function addEvent(type,msg,asset) {
  const log=document.getElementById('evlog');
  const el=document.createElement('div');
  el.className='ev';
  el.innerHTML=`<div class="ev-top"><span class="ev-type ${type}">${type.toUpperCase()}</span><span class="ev-time">${new Date().toLocaleTimeString('en-GB')}</span></div><div class="ev-msg">${msg}</div><div class="ev-asset">${asset}</div>`;
  log.insertBefore(el,log.firstChild);
  if(log.children.length>30)log.removeChild(log.lastChild);
}

// ══════════════════════════════════════════════════
// SIMULATION
// ══════════════════════════════════════════════════

// ══════════════════════════════════════════════════
// SIMULATION MODAL
// ══════════════════════════════════════════════════
let simScenario = 'flood';
let simView     = '2d';
let simThree    = {};
let simAF       = null;
let simModel    = {}; // computed results

const SIM_SCENARIOS = {
  flood: {
    name:'Flood Model', icon:'🌧', color:'#00b4ff',
    params: [
      {group:'Rainfall'},
      {id:'rain', label:'Rainfall Intensity', min:0, max:150, val:45, unit:'mm/hr', scale:['Light','Moderate','Heavy','Extreme']},
      {id:'soil', label:'Soil Saturation',    min:0, max:100, val:60, unit:'%',     scale:['Dry','Moist','Saturated']},
      {group:'Drainage'},
      {id:'drain', label:'Drain Capacity',    min:10,max:100, val:70, unit:'%',     scale:['Blocked','Reduced','Full']},
      {id:'dur',   label:'Event Duration',    min:1, max:12,  val:2,  unit:'hrs',   scale:['1hr','4hrs','8hrs','12hrs']},
    ]
  },
  power: {
    name:'Power Failure', icon:'⚡', color:'#ffc800',
    params: [
      {group:'Feeder'},
      {id:'load',    label:'Load at Trip (%)',   min:60,max:100,val:92,  unit:'%',   scale:['Safe','Warning','Critical']},
      {id:'voltage', label:'Voltage Drop',        min:0, max:40, val:18,  unit:'%',   scale:['Stable','Brownout','Blackout']},
      {group:'Response'},
      {id:'backup',  label:'Backup Gen Capacity', min:0, max:100,val:40,  unit:'%',   scale:['None','Partial','Full']},
      {id:'restime', label:'Restoration Time',    min:1, max:60, val:15,  unit:'min', scale:['Fast','Normal','Slow']},
    ]
  },
  water: {
    name:'Water Pressure', icon:'💧', color:'#00c8ff',
    params: [
      {group:'Pressure'},
      {id:'press',   label:'Main Header Pressure',min:0, max:5,  val:0.8, unit:'bar', step:0.1, scale:['Critical','Low','Normal']},
      {id:'demand',  label:'Demand Multiplier',   min:1, max:3,  val:1.4, unit:'x',   step:0.1, scale:['Normal','Peak','Extreme']},
      {group:'Network'},
      {id:'valves',  label:'Isolation Valves Open',min:0,max:100,val:70,  unit:'%',   scale:['Isolated','Partial','Full']},
      {id:'tankfil', label:'Storage Tank Level',   min:0,max:100,val:55,  unit:'%',   scale:['Empty','Low','Full']},
    ]
  },
  fire: {
    name:'Fire Detection', icon:'🔥', color:'#ff6432',
    params: [
      {group:'Ignition'},
      {id:'floor',   label:'Floor Level',          min:1, max:10, val:3,   unit:'',    scale:['Ground','Mid','High']},
      {id:'spread',  label:'Spread Rate',           min:1, max:5,  val:2,   unit:'',    scale:['Slow','Medium','Fast','Rapid','Extreme']},
      {group:'Systems'},
      {id:'sprink',  label:'Sprinkler Coverage',    min:0, max:100,val:80,  unit:'%',   scale:['None','Partial','Full']},
      {id:'evac',    label:'Evacuation Time',        min:1, max:20, val:6,   unit:'min', scale:['Fast','Normal','Slow']},
    ]
  }
};

function openSim(){
  document.getElementById('simov').classList.add('on');
  selectScenario('flood');
}
function closeSim(){
  document.getElementById('simov').classList.remove('on');
  if(simAF){ cancelAnimationFrame(simAF); simAF=null; }
  if(simThree.rend){ simThree.rend.dispose(); simThree={} ; }
}

function selectScenario(sc){
  simScenario = sc;
  // Update card highlights
  Object.keys(SIM_SCENARIOS).forEach(k=>{
    const el = document.getElementById('scard-'+k);
    if(!el) return;
    el.className = 'sim-card' + (k===sc?' active '+k:'');
  });
  // Render params panel
  renderSimParams(sc);
  // Trigger model compute
  computeSimModel();
  // Update view
  renderSimView();
}

function simSetView(v){
  simView = v;
  ['2d','3d'].forEach(t=>{
    document.getElementById('svtog-'+t).classList.toggle('active', t===v);
  });
  const cv2 = document.getElementById('sim-cv2d');
  const cv3 = document.getElementById('sim-cv3d');
  if(v==='2d'){ cv2.style.display='block'; cv3.style.display='none'; draw2DSim(); }
  else        { cv2.style.display='none';  cv3.style.display='block'; init3DSim(); }
}

function renderSimParams(sc){
  const def = SIM_SCENARIOS[sc];
  let html = '';
  def.params.forEach(p=>{
    if(p.group){
      html += `<div class="sim-param-group-lbl">${p.group}</div>`;
      return;
    }
    const step = p.step || 1;
    html += `<div class="sim-slider-row">
      <div class="sim-sl-lbl">
        <span>${p.label}</span>
        <span class="sim-sl-val" id="sv-${p.id}">${p.val} ${p.unit}</span>
      </div>
      <input type="range" class="sim-range" id="sr-${p.id}"
        min="${p.min}" max="${p.max}" value="${p.val}" step="${step}"
        oninput="onSimSlider('${p.id}',this.value,'${p.unit}')">
      <div class="sim-sl-scale">${p.scale.map(s=>`<span>${s}</span>`).join('')}</div>
    </div>`;
  });
  document.getElementById('sim-params-panel').innerHTML = html;
}

function onSimSlider(id, val, unit){
  const el = document.getElementById('sv-'+id);
  if(el) el.textContent = parseFloat(val) + (unit?' '+unit:'');
  computeSimModel();
  renderSimView();
}

function getSliderVal(id, def){
  const el = document.getElementById('sr-'+id);
  return el ? parseFloat(el.value) : def;
}

function computeSimModel(){
  const sc = simScenario;
  if(sc==='flood'){
    const rain  = getSliderVal('rain',45);
    const soil  = getSliderVal('soil',60);
    const drain = getSliderVal('drain',70);
    const dur   = getSliderVal('dur',2);
    const soilAbs   = (100-soil)/100;
    const drainRel  = drain/100;
    const runoff    = rain*(1-soilAbs*0.5)*(1-drainRel*0.6);
    const peakLevel = 0.8+(runoff/150)*3.2*Math.sqrt(dur/2);
    const floodArea = Math.max(0,(peakLevel-1.2)*1800*(dur*0.4));
    const atRisk    = peakLevel>2.5?8:peakLevel>2.0?6:peakLevel>1.8?4:peakLevel>1.4?2:0;
    const riskPct   = Math.min(100,Math.round((peakLevel-0.8)/3.0*100));
    simModel = {peakLevel, floodArea, atRisk, riskPct,
      riskLabel: riskPct>75?'CRITICAL':riskPct>50?'HIGH':riskPct>30?'MODERATE':'LOW',
      riskCol:   riskPct>75?'#ff3d3d':riskPct>50?'#ff7700':riskPct>30?'#ffb300':'#00e676'};
    updateSimSummary(`${peakLevel.toFixed(2)}m`, atRisk, `${Math.round(floodArea).toLocaleString()} m²`,
      simModel.riskLabel, simModel.riskCol, atRisk>4?'crit':atRisk>0?'warn':'ok');
  } else if(sc==='power'){
    const load = getSliderVal('load',92);
    const volt = getSliderVal('voltage',18);
    const back = getSliderVal('backup',40);
    const rest = getSliderVal('restime',15);
    const affected = Math.round((load-60)/40*9);
    const riskPct  = Math.min(100,Math.round((load-60)/40*100*(1-back/200)));
    simModel = {affected, riskPct, restTime:rest,
      riskLabel: riskPct>70?'CRITICAL':riskPct>45?'HIGH':riskPct>25?'MODERATE':'LOW',
      riskCol:   riskPct>70?'#ff3d3d':riskPct>45?'#ff7700':riskPct>25?'#ffb300':'#00e676'};
    updateSimSummary(`${volt}% drop`, affected, `${rest} min restore`, simModel.riskLabel, simModel.riskCol, affected>5?'crit':'warn');
  } else if(sc==='water'){
    const press  = getSliderVal('press',0.8);
    const demand = getSliderVal('demand',1.4);
    const valves = getSliderVal('valves',70);
    const tank   = getSliderVal('tankfil',55);
    const affected = Math.round((2-press)/2*20*demand);
    const riskPct  = Math.min(100,Math.round((2-press)/2*100*(demand/2)));
    simModel = {press, affected, riskPct,
      riskLabel: riskPct>70?'CRITICAL':riskPct>45?'HIGH':riskPct>25?'MODERATE':'LOW',
      riskCol:   riskPct>70?'#ff3d3d':riskPct>45?'#ff7700':riskPct>25?'#ffb300':'#00e676'};
    updateSimSummary(`${press} bar`, affected, `${tank}% tank`, simModel.riskLabel, simModel.riskCol, press<1.2?'crit':'warn');
  } else if(sc==='fire'){
    const floor  = getSliderVal('floor',3);
    const spread = getSliderVal('spread',2);
    const sprink = getSliderVal('sprink',80);
    const evac   = getSliderVal('evac',6);
    const zones  = Math.round(spread*(1-sprink/200));
    const riskPct= Math.min(100,Math.round(spread*20*(1-sprink/200)));
    simModel = {floor, zones, evac, riskPct, spread,
      riskLabel: riskPct>70?'CRITICAL':riskPct>45?'HIGH':riskPct>25?'MODERATE':'LOW',
      riskCol:   riskPct>70?'#ff3d3d':riskPct>45?'#ff7700':riskPct>25?'#ffb300':'#00e676'};
    updateSimSummary(`Floor ${floor}`, zones, `${evac} min evac`, simModel.riskLabel, simModel.riskCol, spread>3?'crit':'warn');
  }
}

function updateSimSummary(v1, v2, v3, risk, col, cls){
  const set = (id, val, c) => {
    const el = document.getElementById(id); if(!el)return;
    el.textContent = val; el.className = 'sim-sum-val '+(c||'');
  };
  set('ss-level', v1, '');
  set('ss-bldgs', v2, cls);
  set('ss-area',  v3, '');
  set('ss-risk',  risk, cls);
  if(document.getElementById('ss-risk')) document.getElementById('ss-risk').style.color = col;
  // Update scenario badge
  const badge = document.getElementById('scbadge-'+simScenario);
  if(badge){
    badge.textContent = risk;
    badge.className = 'sim-card-badge '+(cls==='crit'?'crit':cls==='warn'?'warn':'ok');
  }
}

function renderSimView(){
  if(simView==='2d') draw2DSim();
  else               sync3DSim();
}

// ── 2D view ──────────────────────────────────────
function draw2DSim(){
  const cv = document.getElementById('sim-cv2d'); if(!cv) return;
  const W  = cv.parentElement.clientWidth;
  const H  = cv.parentElement.clientHeight;
  cv.width=W; cv.height=H;
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,W,H);

  const sc  = simScenario;
  const col = SIM_SCENARIOS[sc].color;

  // Background
  ctx.fillStyle='#07100d'; ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#0e1a14'; ctx.lineWidth=.5;
  for(let x=0;x<W;x+=W/12){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=H/9) {ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Zone labels
  ctx.fillStyle='rgba(0,180,80,0.12)'; ctx.fillRect(0,0,W/2,H/2);
  ctx.fillStyle='rgba(0,120,80,0.08)'; ctx.fillRect(W/2,0,W/2,H/2);
  ctx.fillStyle='rgba(0,100,60,0.1)';  ctx.fillRect(0,H/2,W/2,H/2);
  ctx.fillStyle='rgba(0,80,50,0.08)';  ctx.fillRect(W/2,H/2,W/2,H/2);
  ['ZONE A','ZONE B','ZONE C','ZONE D'].forEach((z,i)=>{
    ctx.fillStyle='rgba(0,180,80,0.18)'; ctx.font='bold 10px monospace'; ctx.textAlign='center';
    ctx.fillText(z, (i%2+0.5)*W/2, (Math.floor(i/2)+0.5)*H/2 - 20);
  });

  // Building grid
  const cols=8, rows=6;
  const bw=W/cols*0.52, bh=H/rows*0.45;
  const buildings=[];
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const bx=(c+0.5)*W/cols, by=(r+0.5)*H/rows;
    buildings.push({x:bx,y:by,id:`B${r*cols+c+1}`});
  }

  // Scenario-specific overlay FIRST (under buildings)
  if(sc==='flood'){
    const {peakLevel,floodArea,atRisk} = simModel;
    if(peakLevel>1.2){
      const t    = (Date.now()%1200)/1200;
      const rad  = Math.min(W*.45,(peakLevel-1.2)*W*.2);
      const cx=W*.55, cy=H*.58;
      const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,rad);
      grad.addColorStop(0,`rgba(0,100,255,${0.18+Math.sin(t*Math.PI*2)*.04})`);
      grad.addColorStop(0.7,`rgba(0,60,200,0.08)`);
      grad.addColorStop(1,'rgba(0,40,120,0)');
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(cx,cy,rad,0,Math.PI*2); ctx.fill();
      // Flood boundary ring
      ctx.strokeStyle=`rgba(0,150,255,${0.4+Math.sin(t*Math.PI*2)*.15})`;
      ctx.lineWidth=1.5; ctx.setLineDash([5,4]);
      ctx.beginPath(); ctx.arc(cx,cy,rad,0,Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
      // Drain lines
      ctx.strokeStyle='rgba(0,200,100,0.35)'; ctx.lineWidth=1.2;
      [[.1,.5,.55,.58],[.55,.58,.9,.5],[.55,.58,.55,.95],[.3,.25,.55,.58],[.75,.25,.55,.58]].forEach(([x1,y1,x2,y2])=>{
        ctx.beginPath();ctx.moveTo(x1*W,y1*H);ctx.lineTo(x2*W,y2*H);ctx.stroke();
      });
      // MH-05 label
      ctx.fillStyle=peakLevel>1.8?'#ff3d3d':'#ffb300';
      ctx.font='bold 9px monospace'; ctx.textAlign='center';
      ctx.fillText(`MH-05: ${peakLevel.toFixed(2)}m`, cx, cy-rad-8);
    }
  } else if(sc==='power'){
    // Power lines from substation
    const {riskPct} = simModel;
    const subcx=W*.15, subcy=H*.5;
    ctx.strokeStyle=`rgba(255,200,0,0.35)`; ctx.lineWidth=1.5;
    [[.15,.5,.4,.25],[.15,.5,.4,.5],[.15,.5,.4,.75],[.4,.25,.7,.2],[.4,.5,.7,.5],[.4,.75,.7,.8]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath();ctx.moveTo(x1*W,y1*H);ctx.lineTo(x2*W,y2*H);ctx.stroke();
    });
    // Substation marker
    ctx.fillStyle='rgba(255,200,0,0.2)'; ctx.strokeStyle='#ffc800'; ctx.lineWidth=1.5;
    ctx.fillRect(subcx-14,subcy-14,28,28); ctx.strokeRect(subcx-14,subcy-14,28,28);
    ctx.fillStyle='#ffc800'; ctx.font='bold 9px monospace'; ctx.textAlign='center';
    ctx.fillText('SUB-B',subcx,subcy+4);
  } else if(sc==='water'){
    // Water mains
    ctx.strokeStyle='rgba(0,180,255,0.3)'; ctx.lineWidth=2;
    [[.1,.1,.9,.1],[.1,.1,.1,.9],[.9,.1,.9,.9],[.1,.9,.9,.9],[.5,.1,.5,.9],[.1,.5,.9,.5]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath();ctx.moveTo(x1*W,y1*H);ctx.lineTo(x2*W,y2*H);ctx.stroke();
    });
  } else if(sc==='fire'){
    const {floor,spread} = simModel;
    // Fire glow at B11 area
    const fcx=W*.55, fcy=H*.55;
    const pls=(Math.sin(Date.now()/300)+1)/2;
    const grad=ctx.createRadialGradient(fcx,fcy,0,fcx,fcy,40+spread*15);
    grad.addColorStop(0,`rgba(255,100,0,${0.3+pls*.2})`);
    grad.addColorStop(0.5,`rgba(200,60,0,0.15)`);
    grad.addColorStop(1,'rgba(180,40,0,0)');
    ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(fcx,fcy,40+spread*15,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,100,0,0.6)'; ctx.font='bold 10px monospace'; ctx.textAlign='center';
    ctx.fillText(`🔥 FLOOR ${floor}`,fcx,fcy-50-spread*5);
  }

  // Buildings
  buildings.forEach((b,i)=>{
    const atRisk = isAtRisk(b,i,sc);
    const t = (Date.now()%900)/900;
    ctx.fillStyle   = atRisk ? `rgba(255,61,61,${0.15+Math.sin(t*Math.PI*2)*.08})` : '#0e1820';
    ctx.strokeStyle = atRisk ? '#ff3d3d' : '#1a2a38';
    ctx.lineWidth   = atRisk ? 1.5 : 0.8;
    ctx.fillRect(b.x-bw/2,b.y-bh/2,bw,bh);
    ctx.strokeRect(b.x-bw/2,b.y-bh/2,bw,bh);
    if(atRisk){
      ctx.strokeStyle=`rgba(255,61,61,${0.3*(1-t)})`;
      ctx.strokeRect(b.x-bw/2-t*5,b.y-bh/2-t*4,bw+t*10,bh+t*8);
    }
  });

  // Compass + scale
  ctx.fillStyle='rgba(0,200,100,0.5)'; ctx.font='bold 9px monospace'; ctx.textAlign='left';
  ctx.fillText('N ↑',W-24,16);
  ctx.strokeStyle='rgba(0,200,100,0.4)';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(10,H-12);ctx.lineTo(60,H-12);ctx.stroke();
  ctx.fillStyle='rgba(0,200,100,0.5)';ctx.fillText('~200m',10,H-16);

  // Info chips
  const infoEl=document.getElementById('sim-view-info');
  if(infoEl){
    const sc2=SIM_SCENARIOS[sc];
    infoEl.innerHTML=`<div class="sim-vi-chip">${sc2.icon} ${sc2.name}</div>
    <div class="sim-vi-chip" id="svi-risk" style="color:${simModel.riskCol||'var(--tx2)'}">${simModel.riskLabel||'—'}</div>`;
  }

  simAF=requestAnimationFrame(()=>{if(document.getElementById('simov').classList.contains('on')&&simView==='2d')draw2DSim();});
}

function isAtRisk(b,i,sc){
  if(sc==='flood')  return simModel.atRisk>0 && i>=28&&i<=37;
  if(sc==='power')  return simModel.affected>0 && (i===5||i===6||i===7||i===13||i===14);
  if(sc==='water')  return simModel.affected>0 && i%3===0 && i<simModel.affected*2;
  if(sc==='fire')   return i===28||i===29||i===30;
  return false;
}

// ── 3D view ──────────────────────────────────────
function init3DSim(){
  if(simAF){ cancelAnimationFrame(simAF); simAF=null; }
  const cv = document.getElementById('sim-cv3d'); if(!cv) return;
  const W = cv.parentElement.clientWidth;
  const H = cv.parentElement.clientHeight;
  cv.width=W; cv.height=H;
  if(simThree.rend){ simThree.rend.dispose(); }
  simThree.scene = new THREE.Scene();
  simThree.cam   = new THREE.PerspectiveCamera(50,W/H,0.1,1000);
  simThree.rend  = new THREE.WebGLRenderer({canvas:cv,antialias:true,alpha:true});
  simThree.rend.setSize(W,H);
  simThree.rend.setPixelRatio(Math.min(devicePixelRatio,2));
  simThree.rend.setClearColor(0x06090d,1);
  simThree.scene.add(new THREE.AmbientLight(0x334455,1.0));
  const dl=new THREE.DirectionalLight(0x88ccff,1.3); dl.position.set(8,14,10); simThree.scene.add(dl);
  simThree.scene.add(new THREE.GridHelper(40,40,0x182330,0x0e151c));
  simThree.camT=0.7; simThree.camP=0.75; simThree.camR=26;
  // Orbit
  let drag=false,lx=0,ly=0;
  cv.onmousedown=e=>{drag=true;lx=e.clientX;ly=e.clientY;};
  window.addEventListener('mouseup',()=>drag=false);
  window.addEventListener('mousemove',e=>{
    if(!drag||!simThree.cam)return;
    simThree.camT-=(e.clientX-lx)*.012; simThree.camP=Math.max(.2,Math.min(1.4,simThree.camP-(e.clientY-ly)*.012));
    lx=e.clientX;ly=e.clientY; updSimCam();
  });
  cv.onwheel=e=>{simThree.camR=Math.max(10,Math.min(50,simThree.camR+e.deltaY*.03));updSimCam();};
  updSimCam();
  build3DSim();
  const loop=()=>{simAF=requestAnimationFrame(loop);simThree.rend.render(simThree.scene,simThree.cam);};
  loop();
}

function updSimCam(){
  if(!simThree.cam)return;
  simThree.cam.position.set(
    simThree.camR*Math.sin(simThree.camT)*Math.sin(simThree.camP),
    simThree.camR*Math.cos(simThree.camP),
    simThree.camR*Math.cos(simThree.camT)*Math.sin(simThree.camP)
  );
  simThree.cam.lookAt(0,1,0);
}

function build3DSim(){
  // Remove old geometry
  const toRem=[...simThree.scene.children].filter(c=>!c.isLight&&!c.isGridHelper);
  toRem.forEach(c=>simThree.scene.remove(c));
  const sc=simScenario;
  const cols=8,rows=6,bw=2.8,bd=2.2,gap=1.0;
  const offX=-(cols*(bw+gap))/2, offZ=-(rows*(bd+gap))/2;
  const atRiskIdxs=new Set();
  if(sc==='flood')  [28,29,30,31,32,33,34,35,36,37].slice(0,simModel.atRisk||0).forEach(i=>atRiskIdxs.add(i));
  if(sc==='power')  [5,6,7,13,14].slice(0,simModel.affected||0).forEach(i=>atRiskIdxs.add(i));
  if(sc==='water')  [...Array(48).keys()].filter(i=>i%3===0&&i<(simModel.affected||0)*2).forEach(i=>atRiskIdxs.add(i));
  if(sc==='fire')   [28,29,30].forEach(i=>atRiskIdxs.add(i));
  let idx=0;
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const atR=atRiskIdxs.has(idx);
    const h = 1.5+Math.random()*3;
    const geo=new THREE.BoxGeometry(bw,h,bd);
    const mat=new THREE.MeshPhongMaterial({
      color:  atR?0x3d1010:0x0e1820,
      emissive: atR?0xff3d3d:0x0a0f14,
      emissiveIntensity: atR?.25:.04,
      transparent:true, opacity:atR?.95:.8
    });
    const m=new THREE.Mesh(geo,mat);
    m.position.set(offX+c*(bw+gap)+bw/2, h/2, offZ+r*(bd+gap)+bd/2);
    simThree.scene.add(m);
    if(atR){
      const eg=new THREE.EdgesGeometry(geo);
      const es=new THREE.LineSegments(eg,new THREE.LineBasicMaterial({color:0xff3d3d}));
      es.position.copy(m.position); simThree.scene.add(es);
    }
    idx++;
  }

  // Flood plane
  if(sc==='flood' && simModel.peakLevel>1.2){
    const fRad=(simModel.peakLevel-1.2)*8;
    const fg=new THREE.CircleGeometry(fRad,32);
    const fm=new THREE.MeshPhongMaterial({color:0x0044cc,emissive:0x0022aa,
      emissiveIntensity:.3,transparent:true,opacity:.35,side:THREE.DoubleSide});
    const fp=new THREE.Mesh(fg,fm); fp.rotation.x=-Math.PI/2; fp.position.y=0.05;
    fp.position.set(4,0.05,3); simThree.scene.add(fp);
    simThree.floodMesh=fp;
  }
  // Fire glow
  if(sc==='fire'){
    const fg2=new THREE.SphereGeometry(2,16,16);
    const fm2=new THREE.MeshPhongMaterial({color:0xff4400,emissive:0xff2200,
      emissiveIntensity:.8,transparent:true,opacity:.3});
    const fp2=new THREE.Mesh(fg2,fm2);
    fp2.position.set(offX+4*(bw+gap)+bw/2,3,offZ+3*(bd+gap)+bd/2);
    simThree.scene.add(fp2); simThree.fireMesh=fp2;
  }
  // Ground
  const gg=new THREE.BoxGeometry(42,.08,34);
  const gm=new THREE.MeshPhongMaterial({color:0x0a0f14,emissive:0x050a0f});
  simThree.scene.add(new THREE.Mesh(gg,gm));
}

function sync3DSim(){
  if(!simThree.rend){ init3DSim(); return; }
  build3DSim();
}

function commitSimulation(){
  const sc = simScenario;
  // Write model back into live data
  if(sc==='flood'){
    const mh05=NDATA.drain.nodes.find(n=>n.id==='MH-05');
    if(mh05) mh05.level=simModel.peakLevel.toFixed(2)+'m';
  }
  closeSim();
  runSim(sc==='flood'?'flood':sc==='power'?'power':sc==='water'?'water':'fire');
  setTimeout(()=>{
    go('decision');
    setTimeout(()=>deSelect(sc==='water'?'flood':sc), 600);
  }, 1000);
  addEvent('warn',`⚡ Simulation committed: ${SIM_SCENARIOS[sc].name}`, 'SIM-MODEL');
}


function runSim(type) {
  closeSim();
  const btn=document.getElementById('sbtn');
  btn.classList.add('run');btn.textContent='⚡ Simulating...';

  const cfg = {
    water:{label:'WATER PRESSURE DROP',bldgs:['B04','B07','B01','B02','B08','B09','B10','B12','B13','B16','B17','B18','B20','B21','B23'],
      events:[
        {t:'alert',m:'💧 WATER PRESSURE CRITICAL: 0.8 bar at main header',a:'SEN-WTR-MAIN-B04'},
        {t:'alert',m:'💧 Pressure cascade — Zone A supply affected',a:'ZONE-A-HEADER'},
        {t:'warn', m:'Backup pump activated — monitoring',a:'PUMP-BACKUP-01'},
        {t:'alert',m:'18 residential units below minimum pressure',a:'ZONE-A · B04/B07/B08'},
        {t:'warn', m:'Isolation valve B-07 partially closed',a:'VLV-B07-MAIN'},
      ],
      faultN:['JN-W2','VLV-01','JN-W5','B04','B07'],
      faultE:[{a:'RES-01',b:'JN-W2'},{a:'JN-W2',b:'VLV-01'},{a:'VLV-01',b:'JN-W5'}],
      netLayer:'water'
    },
    power:{label:'POWER FEEDER FAILURE',bldgs:['B06','B07','B08','B13','B14','B15','B25','B26','B27'],
      events:[
        {t:'alert',m:'⚡ SUBSTATION B TRIP — feeder fault detected',a:'SUB-B · SECTOR-4B'},
        {t:'alert',m:'Power outage: 3 residential blocks offline',a:'B06 / B07 / B08'},
        {t:'alert',m:'Emergency lighting activated — battery backup online',a:'EL-SYS-ZONE-B'},
        {t:'warn', m:'Load shed initiated — non-critical circuits isolated',a:'LOAD-CTRL-B'},
        {t:'ok',   m:'Restoration team dispatched — ETA 12 mins',a:'OPS-TEAM-2'},
      ],
      faultN:['SUB-B','TR-02','DB-02','B06','B07'],
      faultE:[{a:'SUB-B',b:'TR-02'},{a:'TR-02',b:'DB-02'},{a:'TR-02',b:'DB-03'}],
      netLayer:'power'
    },
    flood:{label:'FLOOD / DRAINAGE ALERT',bldgs:['B22','B23','B24','B30','B31','B32','B40','B41'],
      events:[
        {t:'alert',m:'🌧 DRAIN OVERFLOW: Level 2.1m — threshold 1.8m',a:'SEN-DRAIN-045 · B22'},
        {t:'alert',m:'Basement flooding risk — B22 PUMP-ROOM & SUMP',a:'AST-B22-B1-SUMP'},
        {t:'alert',m:'GIS trace: 12 downstream assets at risk',a:'DRAIN-NETWORK · ZONE-S'},
        {t:'warn', m:'Construction zone C — stop work order issued',a:'SITE-ZONE-C'},
        {t:'warn', m:'Evacuation advisory — B22 Basement level',a:'SAFETY-PROTOCOL-FL-001'},
      ],
      faultN:['MH-05','MH-02','B22','B04'],
      faultE:[{a:'MH-05',b:'MH-02'},{a:'MH-05',b:'MH-07'},{a:'MH-05',b:'MH-08'}],
      netLayer:'drain'
    },
    fire:{label:'FIRE DETECTION',bldgs:['B11','B12','B13'],
      events:[
        {t:'alert',m:'🔥 SMOKE DETECTED — B11 Floor 3, Unit 302',a:'SEN-SMK-B11-F03-302'},
        {t:'alert',m:'Fire alarm activated — B11 building-wide',a:'FRE-PANEL-B11'},
        {t:'alert',m:'Evacuation protocol initiated — all floors',a:'EVAC-B11'},
        {t:'warn', m:'Utility isolation: Gas & power shutoff B11',a:'UTL-SHUTOFF-B11'},
        {t:'ok',   m:'Emergency services notified — response incoming',a:'EMERGENCY-DISPATCH'},
      ],
      faultN:['B11'],faultE:[],netLayer:'water'
    }
  };

  const c = cfg[type]; if(!c) return;
  go('cc');

  let delay=0;
  c.bldgs.forEach((bid,i)=>{
    setTimeout(()=>{
      const cell=document.getElementById('bc-'+bid);
      const b=BLDGS.find(x=>x.id===bid);
      if(cell&&b){
        b._prev=b.status; cell.classList.add('sim');
        setTimeout(()=>{
          cell.classList.remove('sim');
          b.status='alert';
          cell.className='bc alert';
          cell.querySelector('.bdot').className='bdot alert';
          cell.querySelector('.bbar').className='bbar alert';
          updateStats();
        },600);
      }
    },delay);
    delay+=160;
  });

  c.events.forEach((ev,i)=>setTimeout(()=>addEvent(ev.t,ev.m,ev.a),i*900+400));

  faultNodes=c.faultN; faultEdges=c.faultE;
  if(netReady){setLayer(c.netLayer);drawNet();}

  setTimeout(()=>{
    c.bldgs.forEach(bid=>{
      const cell=document.getElementById('bc-'+bid);
      const b=BLDGS.find(x=>x.id===bid);
      if(cell&&b){
        b.status=b._prev||'ok';
        cell.className='bc '+b.status;
        cell.querySelector('.bdot').className='bdot '+b.status;
        cell.querySelector('.bbar').className='bbar '+b.status;
      }
    });
    faultNodes=[];faultEdges=[];
    if(netReady)drawNet();
    updateStats();
    addEvent('ok',`✓ ${c.label}: System recovery complete`,'PLATFORM · AUTO-RECOVERY');
    btn.classList.remove('run');btn.textContent='⚡ Simulate Event';
  },delay+c.events.length*900+4000);
}


// ══════════════════════════════════════════════════
// ASSET DETAIL - SELECTORS
// ══════════════════════════════════════════════════
function onB(){
  const b = document.getElementById('selB').value;
  S.b = b; S.f = null; S.u = null;
  // Reset floor + unit selects
  const selF = document.getElementById('selF');
  const selU = document.getElementById('selU');
  selF.innerHTML = '<option value="">— Select —</option>';
  selU.innerHTML = '<option value="">— Select —</option>';
  selF.disabled = true;
  selU.disabled = true;
  if(!b) return;
  // Populate floor options
  Object.entries(BDATA[b].floors).forEach(([k,v])=>{
    const o = document.createElement('option'); o.value=k; o.textContent=v; selF.appendChild(o);
  });
  selF.disabled = false;
  updateCriticalComponents(b);
  // Building level — auto-load immediately, no floor needed
  if(S.level === 'building') tryLoad();
}

function onF(){
  const f = document.getElementById('selF').value;
  S.f = f; S.u = null;
  const selU = document.getElementById('selU');
  selU.innerHTML = '<option value="">— Select —</option>';
  selU.disabled = true;
  if(!f) return;
  // Populate unit options
  (BDATA[S.b].flats[f]||[]).forEach(u=>{
    const o = document.createElement('option'); o.value=u; o.textContent='Unit '+u; selU.appendChild(o);
  });
  selU.disabled = false;
  // Floor level — auto-load when floor selected
  if(S.level === 'floor') tryLoad();
}

function onU(){
  S.u = document.getElementById('selU').value;
  // Unit level — auto-load when unit selected
  if(S.u && S.level === 'unit') tryLoad();
}

// ══════════════════════════════════════════════════
// PARAMS GENERATION — level-aware
// ══════════════════════════════════════════════════
function sv(base,range){return parseFloat((base+(Math.random()-.5)*range*2).toFixed(2));}
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

function genParams(b,f,u){
  const ww=b==='B04', ib=f&&f.startsWith('B');
  const lvl = S.level || 'building';

  if(lvl==='building') return {
    utilities:[
      {id:'UTL-B01',nm:'Total Water Consumption',val:sv(42,8),  unit:'m³/day',max:80, st:'ok',  src:'SCADA',sen:'SEN-WTR-BLDG-'+b},
      {id:'UTL-B02',nm:'Total Power Load',        val:sv(85,12), unit:'kW',    max:150,st:'ok',  src:'SCADA',sen:'SEN-PWR-BLDG-'+b},
      {id:'UTL-B03',nm:'Sewer Discharge',          val:sv(38,6),  unit:'m³/day',max:80, st:'ok',  src:'SCADA',sen:'SEN-SEW-BLDG-'+b},
      {id:'UTL-B04',nm:'Gas Consumption',          val:sv(12,3),  unit:'m³/day',max:30, st:'ok',  src:'SCADA',sen:'SEN-GAS-BLDG-'+b},
    ],
    environmental:[
      {id:'ENV-B01',nm:'CO₂ Level (avg)',    val:sv(780,80), unit:'ppm',   max:2000,st:'ok',src:'SCADA',sen:'SEN-CO2-BLDG-'+b},
      {id:'ENV-B02',nm:'Ambient Temp (avg)', val:sv(27,2),   unit:'°C',    max:45,  st:'ok',src:'SCADA',sen:'SEN-TMP-BLDG-'+b},
      {id:'ENV-B03',nm:'PM2.5 (avg)',        val:sv(32,10),  unit:'µg/m³', max:100, st:'ok',src:'SCADA',sen:'SEN-AQI-BLDG-'+b},
    ],
    safety:[
      {id:'SAF-B01',nm:'Fire Alarm',      val:'CLEAR',    unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-FRE-BLDG-'+b},
      {id:'SAF-B02',nm:'Total Occupancy', val:ri(40,120), unit:'persons',max:200, st:'ok',src:'SCADA',sen:'SEN-OCC-BLDG-'+b},
      {id:'SAF-B03',nm:'Lift Status',     val:'RUNNING',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-LFT-BLDG-'+b},
      {id:'SAF-B04',nm:'Generator',       val:'STANDBY',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-GEN-BLDG-'+b},
    ]
  };

  if(lvl==='floor') return {
    utilities:[
      {id:'UTL-F01',nm:'Water Pressure',  val:sv(ww?1.3:2.8,.3),unit:'bar',   max:4,  st:ww?'warn':'ok',src:'SCADA',sen:'SEN-WTR-'+b+'-'+f},
      {id:'UTL-F02',nm:'Floor Power Load',val:sv(ib?14:8,2),    unit:'kW',    max:30, st:'ok',           src:'SCADA',sen:'SEN-PWR-'+b+'-'+f},
      {id:'UTL-F03',nm:'Drain Flow Rate', val:sv(18,5),          unit:'L/min', max:60, st:'ok',           src:'SCADA',sen:'SEN-DRN-'+b+'-'+f},
      {id:'UTL-F04',nm:'Gas Pressure',    val:sv(2.1,.2),        unit:'bar',   max:3.5,st:'ok',           src:'SCADA',sen:'SEN-GAS-'+b+'-'+f},
      {id:'UTL-F05',nm:'Hot Water Temp',  val:sv(58,4),          unit:'°C',    max:80, st:'ok',           src:'SCADA',sen:'SEN-HWT-'+b+'-'+f},
    ],
    environmental:[
      {id:'ENV-F01',nm:'CO₂ Level',  val:sv(820,120),unit:'ppm',   max:2000,st:'ok',src:'SCADA',sen:'SEN-CO2-'+b+'-'+f},
      {id:'ENV-F02',nm:'Temperature',val:sv(26.5,2), unit:'°C',    max:45,  st:'ok',src:'SCADA',sen:'SEN-TMP-'+b+'-'+f},
      {id:'ENV-F03',nm:'Humidity',   val:sv(62,10),  unit:'%',     max:100, st:'ok',src:'SCADA',sen:'SEN-HUM-'+b+'-'+f},
      {id:'ENV-F04',nm:'PM2.5',      val:sv(28,10),  unit:'µg/m³', max:100, st:'ok',src:'SCADA',sen:'SEN-AQI-'+b+'-'+f},
    ],
    safety:[
      {id:'SAF-F01',nm:'Fire Alarm',    val:'CLEAR',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-FRE-'+b+'-'+f},
      {id:'SAF-F02',nm:'Smoke Detector',val:'CLEAR',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-SMK-'+b+'-'+f},
      {id:'SAF-F03',nm:'Occupancy',     val:ri(4,18), unit:'persons',max:40,  st:'ok',src:'SCADA',sen:'SEN-OCC-'+b+'-'+f},
      {id:'SAF-F04',nm:'Emergency Exit',val:'SECURE', unit:'',       max:null,st:'ok',src:'BIM',  sen:null},
    ]
  };

  // Unit level
  return {
    utilities:[
      {id:'UTL-001',nm:'Water Pressure',    val:sv(ww?1.3:2.8,.3),unit:'bar', max:4,  st:ww?'warn':'ok',src:'SCADA',sen:'SEN-WTR-'+ri(100,999)},
      {id:'UTL-002',nm:'Power Consumption', val:sv(ib?2.8:1.4,.4), unit:'kW',  max:6,  st:'ok',           src:'SCADA',sen:'SEN-PWR-'+ri(100,999)},
      {id:'UTL-003',nm:'Gas Pressure',      val:sv(2.1,.15),        unit:'bar', max:3.5,st:'ok',           src:'SCADA',sen:'SEN-GAS-'+ri(100,999)},
      {id:'UTL-004',nm:'Hot Water Temp',    val:sv(58,4),           unit:'°C',  max:80, st:'ok',           src:'SCADA',sen:'SEN-HWT-'+ri(100,999)},
    ],
    environmental:[
      {id:'ENV-001',nm:'CO₂ Level',        val:sv(820,150),unit:'ppm',   max:2000,st:'ok',src:'SCADA',sen:'SEN-CO2-'+ri(100,999)},
      {id:'ENV-002',nm:'Temperature',      val:sv(26.5,2), unit:'°C',    max:45,  st:'ok',src:'SCADA',sen:'SEN-TMP-'+ri(100,999)},
      {id:'ENV-003',nm:'Humidity',         val:sv(62,10),  unit:'%',     max:100, st:'ok',src:'SCADA',sen:'SEN-HUM-'+ri(100,999)},
      {id:'ENV-004',nm:'Air Quality PM2.5',val:sv(28,12),  unit:'µg/m³', max:100, st:'ok',src:'SCADA',sen:'SEN-AQI-'+ri(100,999)},
    ],
    safety:[
      {id:'SAF-001',nm:'Fire Alarm',    val:'CLEAR',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-FRE-'+ri(100,999)},
      {id:'SAF-002',nm:'Smoke Detector',val:'CLEAR',  unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-SMK-'+ri(100,999)},
      {id:'SAF-003',nm:'Occupancy',     val:ri(1,4),  unit:'persons',max:8,   st:'ok',src:'SCADA',sen:'SEN-OCC-'+ri(100,999)},
      {id:'SAF-004',nm:'Door / Access', val:'SECURE', unit:'',       max:null,st:'ok',src:'SCADA',sen:'SEN-ACC-'+ri(100,999)},
    ]
  };
}


const SLBLS={utilities:'Utilities & Services',environmental:'Environmental',safety:'Safety & Life'};
const BARC={ok:'#00e676',warn:'#ffb300',alert:'#ff3d3d'};

// ══════════════════════════════════════════════════
// PARAMS RENDERING
// ══════════════════════════════════════════════════
function irow(sec){
  const map={utilities:'SCADA+GIS',environmental:'SCADA',safety:'SCADA+BIM'};
  const s=map[sec]||'SCADA';
  let h='<div class="irow">';
  if(s.includes('BIM'))h+=`<span class="ib ib-bim"><span class="ib-dot"></span>BIM</span>`;
  if(s.includes('GIS'))h+=`<span class="ib ib-gis"><span class="ib-dot"></span>GIS</span>`;
  if(s.includes('SCADA'))h+=`<span class="ib ib-sca"><span class="ib-dot"></span>SCADA</span>`;
  return h+'</div>';
}

function renderParams(){
  const pane=document.getElementById('tp-params');
  if(!pane||!S.params)return;
  let html='';
  Object.entries(S.params).forEach(([sec,ps])=>{
    html+=`<div class="stitle">${SLBLS[sec]||sec}</div>`;
    ps.forEach((p,i)=>{
      const pct=p.max?Math.min(100,(parseFloat(p.val)||0)/p.max*100):0;
      const bc=BARC[p.st]||BARC.ok;
      const cc=p.st==='warn'?'pw':p.st==='alert'?'pa':'';
      const dc=p.st==='warn'?'dw':p.st==='alert'?'da':'dok';
      html+=`<div class="pc ${cc}" id="pc-${p.id}" onclick="selParam('${sec}','${p.id}')" style="animation-delay:${i*.05}s">
        <div class="pc-top">
          <div class="pc-nm">${p.nm}${p.sen?`<br><span class="pc-sid">${p.sen}</span>`:''}
          </div>
          <div class="pc-dot ${dc}"></div>
        </div>
        <div class="pc-vr">
          <div class="pc-v ${p.st}" id="pv-${p.id}">${p.val}</div>
          <div class="pc-u">${p.unit}</div>
        </div>
        ${p.max?`<div class="pc-bar"><div class="pc-bf" id="pb-${p.id}" style="width:${pct}%;background:${bc}"></div></div>`:''}
        ${irow(sec)}
      </div>`;
    });
  });
  pane.innerHTML=html;
}

function selParam(sec,pid){
  document.querySelectorAll('.pc').forEach(c=>c.classList.remove('sel'));
  const card=document.getElementById('pc-'+pid);if(card)card.classList.add('sel');
  const p=S.params[sec]?S.params[sec].find(x=>x.id===pid):null;
  if(!p||!p.max)return;
  S.selP=p;
  document.getElementById('cpnl').style.display='block';
  document.getElementById('cpn').textContent=p.nm;
  drawChart(p,'1h');
}


function renderMeta(id){
  const {b, f, u} = S;
  const bd = BDATA[b];
  if(!bd) return;
  const lvl = S.level || 'building';
  const rows = [
    ['Asset ID', id],
    ['Building', bd.name],
    ['Floor', f ? (bd.floors[f]||f) : '—'],
    ['Unit', u||'—'],
    ['View Level', lvl.toUpperCase()],
    ['BIM Reference', `IFC-${b}-LOD300.rvt`],
    ['GIS Layer', 'SECTOR-4B-BUILDINGS'],
    ['SCADA Node', `SCD-${b}-${f||'B1'}`],
    ['Coordinates', '19.0401°N, 72.8533°E'],
    ['Lifecycle', 'CONSTRUCTION — PHASE 2'],
    ['Data Quality', '98.4%'],
    ['Last Sync', new Date().toISOString().slice(0,19).replace('T',' ')],
  ];
  let html = '<div class="stitle">Asset Metadata</div>';
  rows.forEach(([k,v]) => html += `<div class="mrow"><span class="mk">${k}</span><span class="mv">${v}</span></div>`);
  html += `<div class="stitle" style="margin-top:14px">Data Sources</div>`;
  html += `<div class="mrow"><span class="mk">Asset Identity</span><span class="ib ib-bim" style="font-size:8px"><span class="ib-dot"></span>BIM</span></div>`;
  html += `<div class="mrow"><span class="mk">Spatial Context</span><span class="ib ib-gis" style="font-size:8px"><span class="ib-dot"></span>GIS</span></div>`;
  html += `<div class="mrow"><span class="mk">Live State</span><span class="ib ib-sca" style="font-size:8px"><span class="ib-dot"></span>SCADA</span></div>`;
  document.getElementById('tp-meta').innerHTML = html;
}

function checkAlert(){
  const all = Object.values(S.params).flat();
  const alerts = all.filter(p => p.st==='alert' || p.st==='warn');
  const f = document.getElementById('aftr');
  if(!f) return;
  f.style.display = 'flex';
  if(alerts.length){
    const w = alerts.find(p=>p.st==='alert') || alerts[0];
    f.className = 'aftr ' + w.st;
    document.getElementById('aftag').className = 'aftag ' + w.st;
    document.getElementById('aftag').textContent = w.st.toUpperCase();
    document.getElementById('aftx').textContent = `${w.nm}: ${w.val} ${w.unit} — threshold exceeded`;
  } else {
    f.className = 'aftr ok';
    document.getElementById('aftag').className = 'aftag ok';
    document.getElementById('aftag').textContent = 'NOMINAL';
    document.getElementById('aftx').textContent = `All ${all.length} parameters within bounds`;
  }
}

function openParam(id, nm){
  const p = Object.values(S.params).flat().find(x=>x.id===id);
  if(!p) return;
  S.selP = p;
  document.getElementById('cpnl').style.display = 'block';
  document.getElementById('cpn').textContent = nm;
  drawChart(p);
}

function dtab(tab){
  document.querySelectorAll('.dtab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.tp').forEach(t=>t.classList.remove('on'));
  event.target.classList.add('on');
  document.getElementById('tp-'+tab).classList.add('on');
}

function setR(btn, range){
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(S.selP) drawChart(S.selP, range);
}

function drawChart(p, range){
  const canvas = document.getElementById('sch');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.parentElement.clientWidth - 4;
  const H = 110;
  canvas.width = W; canvas.height = H;

  const PAD = {t:10, r:10, b:28, l:46};
  const CW = W - PAD.l - PAD.r;
  const CH = H - PAD.t - PAD.b;

  // Generate realistic time-series data
  const pts = 48;
  const base = typeof p.val === 'number' ? p.val : null;
  if(base === null){ ctx.fillStyle='rgba(0,200,100,.15)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='var(--tx3)'; ctx.font='9px monospace'; ctx.textAlign='center';
    ctx.fillText('No numeric history', W/2, H/2+3); return; }

  // Build realistic pattern — slow drift + noise + occasional spike
  const vals = [];
  let cur = base;
  for(let i=0;i<pts;i++){
    const drift = (Math.random()-.48) * (p.max||base) * 0.012;
    const noise = (Math.random()-.5) * (p.max||base) * 0.018;
    const spike = Math.random()<.04 ? (Math.random()-.5)*(p.max||base)*.06 : 0;
    cur = Math.max(p.min||0, Math.min(p.max||base*1.5, cur+drift+noise+spike));
    vals.push(cur);
  }
  // End close to current value
  vals[pts-1] = base;

  const mn = Math.min(...vals), mx2 = Math.max(...vals);
  const pad = (mx2-mn)*0.15 || base*0.05 || 1;
  const yMin = Math.max(0, mn-pad), yMax = mx2+pad;
  const yRange = yMax-yMin || 1;

  const col = p.st==='warn'?'#ffb300':p.st==='alert'?'#ff3d3d':'#00e676';

  ctx.clearRect(0,0,W,H);

  // Background
  ctx.fillStyle='#060d09'; ctx.fillRect(0,0,W,H);

  // Grid lines + Y axis labels
  ctx.font='7px monospace'; ctx.textAlign='right'; ctx.fillStyle='rgba(100,160,120,.5)';
  ctx.strokeStyle='rgba(255,255,255,.04)'; ctx.lineWidth=1;
  const yTicks = 4;
  for(let i=0;i<=yTicks;i++){
    const y = PAD.t + CH - (i/yTicks)*CH;
    const v = yMin + (i/yTicks)*yRange;
    ctx.beginPath(); ctx.moveTo(PAD.l, y); ctx.lineTo(PAD.l+CW, y); ctx.stroke();
    const label = v >= 1000 ? (v/1000).toFixed(1)+'k' : v.toFixed(v<10?1:0);
    ctx.fillText(label, PAD.l-4, y+3);
  }

  // X axis time labels
  const now = new Date();
  const rangeMs = range==='1h'?3600:range==='6h'?21600:range==='24h'?86400:604800;
  const xTicks = 6;
  ctx.textAlign='center'; ctx.fillStyle='rgba(100,160,120,.5)';
  for(let i=0;i<=xTicks;i++){
    const x = PAD.l + (i/xTicks)*CW;
    const t2 = new Date(now - (1-(i/xTicks))*rangeMs*1000);
    const lbl = range==='7d'
      ? ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t2.getDay()]
      : `${String(t2.getHours()).padStart(2,'0')}:${String(t2.getMinutes()).padStart(2,'0')}`;
    ctx.fillText(lbl, x, H-8);
    ctx.strokeStyle='rgba(255,255,255,.04)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(x, PAD.t); ctx.lineTo(x, PAD.t+CH); ctx.stroke();
  }

  // Threshold line if max exists
  if(p.max && yMax >= p.max*0.8){
    const ty = PAD.t + CH - ((p.max*0.9-yMin)/yRange)*CH;
    ctx.strokeStyle='rgba(255,100,0,.35)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(PAD.l, ty); ctx.lineTo(PAD.l+CW, ty); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,100,0,.6)'; ctx.textAlign='right'; ctx.font='6px monospace';
    ctx.fillText('LIMIT', PAD.l+CW, ty-2);
  }

  // Area fill
  const grad = ctx.createLinearGradient(0, PAD.t, 0, PAD.t+CH);
  grad.addColorStop(0, col+'33'); grad.addColorStop(1, col+'00');
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const x = PAD.l + (i/(pts-1))*CW;
    const y = PAD.t + CH - ((v-yMin)/yRange)*CH;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.lineTo(PAD.l+CW, PAD.t+CH); ctx.lineTo(PAD.l, PAD.t+CH);
  ctx.closePath(); ctx.fillStyle=grad; ctx.fill();

  // Line
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const x = PAD.l + (i/(pts-1))*CW;
    const y = PAD.t + CH - ((v-yMin)/yRange)*CH;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.setLineDash([]); ctx.stroke();

  // Current value dot
  const lastX = PAD.l+CW, lastY = PAD.t+CH-((base-yMin)/yRange)*CH;
  ctx.beginPath(); ctx.arc(lastX, lastY, 3, 0, Math.PI*2);
  ctx.fillStyle=col; ctx.fill();
  ctx.strokeStyle='#06090d'; ctx.lineWidth=1.5; ctx.stroke();

  // Y axis label (unit)
  ctx.save(); ctx.translate(10, PAD.t+CH/2); ctx.rotate(-Math.PI/2);
  ctx.fillStyle='rgba(100,160,120,.6)'; ctx.font='7px monospace'; ctx.textAlign='center';
  ctx.fillText(p.unit||'', 0, 0); ctx.restore();

  // Axis lines
  ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(PAD.l, PAD.t); ctx.lineTo(PAD.l, PAD.t+CH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(PAD.l, PAD.t+CH); ctx.lineTo(PAD.l+CW, PAD.t+CH); ctx.stroke();
}

// ── Tab + chart helpers ───────────────────────────────────

// Core loader — called automatically based on level
function tryLoad(){
  const {b, f, u} = S;
  const lvl = S.level || 'unit';
  // Check we have enough info for the chosen level
  if(lvl === 'building' && !b) return;
  if(lvl === 'floor'    && (!b || !f)) return;
  if(lvl === 'unit'     && (!b || !f || !u)) return;
  // Use first floor as anchor for building-level render
  const renderFloor = f || Object.keys(BDATA[b].floors)[0];
  S.f = S.f || renderFloor;
  S.params = genParams(b, renderFloor, u||'—');
  // Compute display ID
  const id = lvl==='building' ? b : lvl==='floor' ? `${b}·${f}` : `AST-${b}-${f}-${u}`;
  document.getElementById('dtag').textContent = id;
  document.getElementById('ovbim').textContent = id;
  updateBreadcrumb();
  // Floor indicator
  const fi  = document.getElementById('floor-indicator');
  const fiL = document.getElementById('fi-label');
  if(fi && fiL){
    fi.style.display = (lvl==='floor'||lvl==='unit') ? 'block' : 'none';
    if(lvl!=='building') fiL.textContent = BDATA[b].floors[renderFloor]||renderFloor;
  }
  // OV level badge
  const ovl = document.getElementById('ov-level');
  if(ovl) ovl.textContent = lvl.toUpperCase();
  document.getElementById('vov').style.display = 'flex';
  // Render
  init3D(b, renderFloor);
  renderParams();
  renderMeta(id);
  checkAlert();
}

function loadAsset(){ tryLoad(); } // legacy alias kept

function setLevel(lvl){
  S.level = lvl;
  // Highlight active button
  ['township','building','floor','unit'].forEach(l=>{
    const el=document.getElementById('lvl-'+l); if(el) el.classList.toggle('active', l===lvl);
  });
  // Township: show all-buildings 3D and hide selectors
  const rowB = document.querySelector('.slbl[for="selB"]') || document.querySelector('.slbl+select')?.previousElementSibling;
  const selB = document.getElementById('selB');
  const rowF = document.getElementById('row-floor');
  const rowU = document.getElementById('row-unit');
  if(lvl==='township'){
    if(selB) selB.closest('div')?.querySelectorAll('.slbl,select').forEach(e=>e.style.opacity='.35');
    if(rowF) rowF.style.display='none';
    if(rowU) rowU.style.display='none';
    loadTownship(); return;
  }
  if(selB) selB.closest('div')?.querySelectorAll('.slbl,select').forEach(e=>e.style.opacity='');
  // Show/hide selector rows based on level
  if(rowF) rowF.style.display = (lvl==='floor'||lvl==='unit') ? 'block' : 'none';
  if(rowU) rowU.style.display = (lvl==='unit') ? 'block' : 'none';
  // Update OV level
  const ovl = document.getElementById('ov-level');
  if(ovl) ovl.textContent = lvl.toUpperCase();
  // If we already have enough selection, re-render at new level
  if(S.b) tryLoad();
}

// ── Layer toggle ──────────────────────────────────────────
function toggleLayer(lk){
  three.layers = three.layers || {water:true,power:false,drain:false};
  three.layers[lk] = !three.layers[lk];
  document.getElementById('ltog-'+lk).classList.toggle('active', three.layers[lk]);
  if(S.b && S.f) build3D(S.b, S.f||Object.keys(BDATA[S.b].floors)[0]);
}
// ── Layer toggle ──────────────────────────────────────────
function toggleLayer(lk){
  three.layers = three.layers || {water:true,power:false,drain:false};
  three.layers[lk] = !three.layers[lk];
  document.getElementById('ltog-'+lk).classList.toggle('active', three.layers[lk]);
  // Re-render 3D if active
  if(S.b && S.f) build3D(S.b, S.f);
}

// ── X-Ray toggle ──────────────────────────────────────────
function setV(m){ document.getElementById('v3d').classList.toggle('on', m==='3d'); }

function toggleWF(){
  three.wf = !three.wf;
  if(three.scene) three.scene.traverse(o=>{
    if(o.isMesh && o.material && !o.material.isLineBasicMaterial)
      o.material.wireframe = three.wf;
  });
}

function toggleXray(){
  three.xray = !three.xray;
  document.getElementById('v-xray').classList.toggle('on', three.xray);
  if(S.b && S.f) build3D(S.b, S.f);
}

// ── Update breadcrumb based on level ─────────────────────
function updateBreadcrumb(){
  const b=S.b, f=S.f, u=S.u, lvl=S.level||'unit';
  const bd=BDATA[b];
  let html='<span>DIMS</span><span class="bc-sep">›</span>';
  if(!b){ html+='<span style="color:var(--tx2)">Select an asset to begin</span>'; }
  else if(lvl==='building'){ html+=`<span class="bc-act">${bd.name}</span>`; }
  else if(lvl==='floor' && f){ html+=`<span>${bd.name}</span><span class="bc-sep">›</span><span class="bc-act">${bd.floors[f]}</span>`; }
  else { html+=`<span>${b}</span><span class="bc-sep">›</span><span>${bd.floors[f]||f}</span><span class="bc-sep">›</span><span class="bc-act">Unit ${u}</span>`; }
  document.getElementById('bcpath').innerHTML = html;
}

// ── Update critical components based on building ──────────
function updateCriticalComponents(b){
  const isWarn = b==='B04';
  const isPower = b==='B07';
  const items = [
    {id:'bsr-lift',  val: isPower?'⚠ MAINTENANCE':'OPERATIONAL', cls: isPower?'s-warn':'s-ok'},
    {id:'bsr-fire',  val: 'ARMED',                              cls: 's-ok'},
    {id:'bsr-elec',  val: isPower?'⚠ OVERLOAD':'ONLINE',        cls: isPower?'s-warn':'s-ok'},
    {id:'bsr-pump',  val: isWarn?'⚠ LOW PRESSURE':'NOMINAL',    cls: isWarn?'s-warn':'s-ok'},
    {id:'bsr-gen',   val: 'STANDBY',                            cls: 's-ok'},
    {id:'bsr-scada', val: 'LIVE',                               cls: 's-ok'},
  ];
  items.forEach(it=>{
    const el=document.getElementById(it.id); if(!el)return;
    el.textContent=it.val; el.className='bsv '+it.cls;
  });
}


// ── Township view — all buildings 3D ─────────────────────────
function loadTownship(){
  document.getElementById('evw').style.display='none';
  const cv=document.getElementById('cv3d');
  cv.style.display='block';
  document.getElementById('vov').style.display='flex';
  if(three.af){ cancelAnimationFrame(three.af); three.af=null; }
  if(three.rend){ three.rend.dispose(); three.rend=null; }

  const cont=document.querySelector('.dview');
  const W=cont.clientWidth||900, H=(cont.clientHeight||600)-38;
  cv.width=W; cv.height=H;

  three.scene=new THREE.Scene();
  three.scene.fog=new THREE.FogExp2(0x06090d,.008);
  three.cam=new THREE.PerspectiveCamera(42,W/H,0.1,2000);
  three.rend=new THREE.WebGLRenderer({canvas:cv,antialias:true,alpha:false});
  three.rend.setSize(W,H);
  three.rend.setPixelRatio(Math.min(devicePixelRatio,2));
  three.rend.setClearColor(0x06090d,1);

  three.scene.add(new THREE.AmbientLight(0x334455,1.2));
  const sun=new THREE.DirectionalLight(0x88ccff,1.8); sun.position.set(40,80,30); three.scene.add(sun);
  const fill=new THREE.DirectionalLight(0x002244,0.6); fill.position.set(-20,20,-40); three.scene.add(fill);
  three.scene.add(new THREE.GridHelper(300,40,0x0d1620,0x0a1018));

  // Ground
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshLambertMaterial({color:0x070e14}));
  gnd.rotation.x=-Math.PI/2; three.scene.add(gnd);

  // Road grid (main axes)
  const roadMat=new THREE.MeshBasicMaterial({color:0x0f1e2a});
  [{x:0,z:0,w:300,d:5},{x:0,z:0,w:5,d:300}].forEach(r=>{
    const rm=new THREE.Mesh(new THREE.PlaneGeometry(r.w,r.d),roadMat);
    rm.rotation.x=-Math.PI/2; rm.position.set(r.x,0.01,r.z); three.scene.add(rm);
  });

  // All 142 buildings in grid
  const COLS=14, spacing=14;
  const totalW=(COLS-1)*spacing, totalD=Math.ceil(142/COLS)*spacing;
  BLDGS.forEach((b,i)=>{
    const ci=i%COLS, ri=Math.floor(i/COLS);
    const bx=(ci-(COLS/2)+.5)*spacing;
    const bz=(ri-Math.ceil(142/COLS)/2+.5)*spacing;
    const fh=Math.max(1.5,b.floors*.32);
    const bw=5+((i*7)%4), bd2=5+((i*11)%4);
    const isAlert=b.status==='alert', isWarn=b.status==='warn';
    const baseCol=isAlert?0x3d1010:isWarn?0x2a2000:0x162436;
    const emitCol=isAlert?0x551515:isWarn?0x332200:0x1e3a5a;
    const emitInt=isAlert?.6:isWarn?.4:.25;
    const mat=new THREE.MeshPhongMaterial({color:baseCol,emissive:emitCol,emissiveIntensity:emitInt});
    const mesh=new THREE.Mesh(new THREE.BoxGeometry(bw,fh,bd2),mat);
    mesh.position.set(bx,fh/2,bz);
    three.scene.add(mesh);
    // Edge outline
    const edgeCol=isAlert?0x882222:isWarn?0x665500:0x2a4a6a;
    const edges=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(bw,fh,bd2)),
      new THREE.LineBasicMaterial({color:edgeCol}));
    edges.position.copy(mesh.position); three.scene.add(edges);
    // Alert point light
    if(isAlert){
      const pl=new THREE.PointLight(0xff2200,.6,16); pl.position.set(bx,fh+2,bz); three.scene.add(pl);
    }
  });

  // Set camera — wide angle looking down at township centre
  camLY = 12;
  camR = 130; camT = 0.55; camP = 0.58;
  three.cam.position.set(
    camR*Math.sin(camT)*Math.sin(camP),
    camLY+camR*Math.cos(camP),
    camR*Math.cos(camT)*Math.sin(camP)
  );
  three.cam.lookAt(0, camLY, 0);

  setupOrbit(cv);

  const loop=()=>{
    three.af=requestAnimationFrame(loop);
    three.rend.render(three.scene,three.cam);
  };
  loop();

  // Update overlays
  const bcpath=document.getElementById('bcpath');
  if(bcpath) bcpath.innerHTML='<span>DIMS</span><span class="bc-sep">›</span><span class="bc-act">TOWNSHIP · All 142 Buildings</span>';
  const ovl=document.getElementById('ov-level'); if(ovl) ovl.textContent='TOWNSHIP';
  const dtag=document.getElementById('dtag'); if(dtag) dtag.textContent='TWN';
}


// ══════════════════════════════════════════════════
// 3D VIEWER
// ══════════════════════════════════════════════════
function init3D(bid,floor){
  S.level = S.level || 'building';
  three.layers = three.layers || {water:true,power:false,drain:false};
  document.getElementById('evw').style.display='none';
  const cv=document.getElementById('cv3d'); cv.style.display='block';
  document.getElementById('vov').style.display='flex';
  // Stop existing render loop
  if(three.af) cancelAnimationFrame(three.af);
  // Dispose old renderer cleanly
  if(three.rend){ three.rend.dispose(); }
  // Fresh scene
  const cont = document.querySelector('.dview');
  const W = cont.clientWidth, H = cont.clientHeight - 38;
  cv.width = W; cv.height = H;
  three.scene = new THREE.Scene();
  three.cam   = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000);
  three.rend  = new THREE.WebGLRenderer({canvas:cv, antialias:true, alpha:true});
  three.rend.setSize(W, H);
  three.rend.setPixelRatio(Math.min(devicePixelRatio, 2));
  three.rend.setClearColor(0x06090d, 1);
  // Lights
  three.scene.add(new THREE.AmbientLight(0x334455, 1.0));
  const dl = new THREE.DirectionalLight(0x88ccff, 1.4);
  dl.position.set(5,12,8); three.scene.add(dl);
  const rl = new THREE.DirectionalLight(0x002244, 0.6);
  rl.position.set(-4,4,-8); three.scene.add(rl);
  three.scene.add(new THREE.GridHelper(30, 30, 0x182330, 0x0e151c));
  // Build geometry — camera is set inside build3D based on level
  build3D(bid, floor);
  // Setup orbit AFTER camera is positioned
  setupOrbit(cv);
  // Render loop
  const loop = () => {
    three.af = requestAnimationFrame(loop);
    three.rend.render(three.scene, three.cam);
  };
  loop();
}

function build3D(bid, floor){
  const bd = BDATA[bid]; if(!bd) return;
  const fkeys = Object.keys(bd.floors);
  const si = fkeys.indexOf(floor);
  const lvl = S.level || 'unit';
  const xray = three.xray || false;
  const fh = 0.45, gap = 0.06;

  // Clear all non-light, non-grid children cleanly
  const toRemove = [...three.scene.children].filter(c => !c.isLight && !c.isGridHelper);
  toRemove.forEach(c => { three.scene.remove(c); });

  // ── Build floors ──
  for(let i = 0; i < bd.h; i++){
    const isSel = (lvl==='floor'||lvl==='unit') ? i===si : true;
    const isHidden = (lvl==='floor'||lvl==='unit') && i!==si && !xray;
    const y = i * (fh + gap);

    const opacity = isHidden ? 0.12 : 1;
    const col = isSel ? bd.col : 0x0e1820;
    const emCol = isSel ? bd.col : 0x0a0f14;
    const emInt = isSel ? 0.25 : 0.05;

    const geo = new THREE.BoxGeometry(6, fh, 5);
    const mat = new THREE.MeshPhongMaterial({
      color: col, emissive: emCol, emissiveIntensity: emInt,
      transparent: true, opacity: opacity, wireframe: three.wf
    });
    const m = new THREE.Mesh(geo, mat);
    m.position.set(0, y + fh/2, 0);
    m.castShadow = true;
    three.scene.add(m);

    // Edge outline on selected floor
    if(isSel){
      const eg = new THREE.EdgesGeometry(geo);
      const es = new THREE.LineSegments(eg, new THREE.LineBasicMaterial({color: bd.col, linewidth:2}));
      es.position.copy(m.position);
      three.scene.add(es);
    }

    // Windows on visible floors
    if(!three.wf && !isHidden){
      const wg = new THREE.BoxGeometry(0.48, 0.22, 0.02);
      const wm = new THREE.MeshPhongMaterial({color:0x223344,emissive:isSel?0x002244:0x001122,emissiveIntensity:.6});
      for(let wx=-2; wx<=2; wx+=1.2){
        const w=new THREE.Mesh(wg,wm); w.position.set(wx,y+fh*.5,2.51); three.scene.add(w);
        const w2=w.clone(); w2.position.z=-2.51; three.scene.add(w2);
      }
    }

    // Floor label on selected
    if(isSel && lvl!=='building'){
      const canvas=document.createElement('canvas'); canvas.width=256; canvas.height=64;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='rgba(0,0,0,0)'; ctx.fillRect(0,0,256,64);
      ctx.fillStyle='rgba(0,200,255,0.9)'; ctx.font='bold 22px monospace';
      ctx.fillText(bd.floors[floor]||floor, 10, 40);
      const tex=new THREE.CanvasTexture(canvas);
      const sp=new THREE.SpriteMaterial({map:tex,transparent:true});
      const sprite=new THREE.Sprite(sp);
      sprite.scale.set(3,0.75,1);
      sprite.position.set(4.2, y+fh/2, 0);
      three.scene.add(sprite);
    }
  }

  // ── Network layers — horizontal 2D plan on each floor ────────────────────
  // Each layer shows a realistic floor-plan network: main corridor trunk + branch risers
  const activeLayers = three.layers || {water:true,power:false,drain:false};

  // Building footprint: X ∈ [-3,3], Z ∈ [-2.5,2.5]
  // Network drawn as flat horizontal lines in the X-Z plane at each floor Y
  const layerNets = {
    water:{
      col:0x0099dd,
      // Each segment: [x1,z1, x2,z2] — corridor trunk + lateral branches
      segs:[
        // Main horizontal trunk along back wall
        [-2.8,-2.2,  2.8,-2.2],
        // Lateral drops to each unit zone
        [-2.2,-2.2, -2.2, 2.2],
        [ 0.0,-2.2,  0.0, 2.2],
        [ 2.2,-2.2,  2.2, 2.2],
        // Cross trunk at front
        [-2.8, 2.0,  2.8, 2.0],
      ],
      nodes:[[-2.8,-2.2],[-2.2,0.0],[0.0,-2.2],[2.2,0.0],[2.8,2.0],[0.0,2.0]],
    },
    power:{
      col:0xddaa00,
      segs:[
        // Main busbar at centre
        [-2.8, 0.0,  2.8, 0.0],
        // Sub-distribution to each quadrant
        [-2.8, 0.0, -2.8,-2.2],
        [-2.8, 0.0, -2.8, 2.2],
        [ 2.8, 0.0,  2.8,-2.2],
        [ 2.8, 0.0,  2.8, 2.2],
        // Cross-link
        [-1.0,-2.2,  1.0,-2.2],
        [-1.0, 2.2,  1.0, 2.2],
      ],
      nodes:[[-2.8,0.0],[0.0,0.0],[2.8,0.0],[-2.8,-2.2],[2.8,2.2]],
    },
    drain:{
      col:0x33cc66,
      segs:[
        // Central drain spine
        [ 0.0,-2.4,  0.0, 2.4],
        // Branch collectors
        [-2.6,-1.8,  0.0,-1.8],
        [-2.6, 1.8,  0.0, 1.8],
        [ 0.0,-1.8,  2.6,-1.8],
        [ 0.0, 1.8,  2.6, 1.8],
        // Wet riser connections
        [-2.4, 0.0,  0.0, 0.0],
        [ 0.0, 0.0,  2.4, 0.0],
      ],
      nodes:[[0.0,-2.4],[0.0,0.0],[0.0,2.4],[-2.4,0.0],[2.4,0.0]],
    },
  };

  const lvl2 = S.level || 'building';
  Object.entries(layerNets).forEach(([lk, ln])=>{
    if(!activeLayers[lk]) return;
    const lineMat  = new THREE.LineBasicMaterial({color:ln.col});
    const dotMat   = new THREE.MeshPhongMaterial({color:ln.col,emissive:ln.col,emissiveIntensity:.8});
    const riserMat = new THREE.MeshPhongMaterial({color:ln.col,emissive:ln.col,emissiveIntensity:.2});

    // Full-height riser at main node
    const riserH = bd.h*(fh+gap);
    const rx=ln.nodes[0][0], rz=ln.nodes[0][1];
    const riser=new THREE.Mesh(new THREE.CylinderGeometry(.025,.025,riserH,6),riserMat);
    riser.position.set(rx,riserH/2,rz);
    three.scene.add(riser);

    for(let fi=0; fi<bd.h; fi++){
      const isSel3=(lvl2==='floor'||lvl2==='unit') ? fi===si : true;
      const isHid3=(lvl2==='floor'||lvl2==='unit') && fi!==si && !xray;
      if(isHid3) continue;
      const fy = fi*(fh+gap) + fh*0.12;  // slightly above floor slab
      const alpha = isSel3?1.0:0.28;

      // Draw all segments as flat horizontal lines at this floor
      ln.segs.forEach(([x1,z1,x2,z2])=>{
        const pts=[new THREE.Vector3(x1,fy,z1), new THREE.Vector3(x2,fy,z2)];
        const geo=new THREE.BufferGeometry().setFromPoints(pts);
        const mat=new THREE.LineBasicMaterial({color:ln.col,transparent:alpha<1,opacity:alpha});
        three.scene.add(new THREE.Line(geo,mat));
      });

      // Draw node dots at junction points
      ln.nodes.forEach(([nx,nz])=>{
        const r=isSel3?0.1:0.06;
        const sg=new THREE.SphereGeometry(r,8,8);
        const sm=new THREE.MeshPhongMaterial({color:ln.col,emissive:ln.col,emissiveIntensity:isSel3?.9:.2,transparent:alpha<1,opacity:alpha});
        const sp=new THREE.Mesh(sg,sm); sp.position.set(nx,fy,nz);
        three.scene.add(sp);
      });
    }
  });
  // Ground plate
  const gpGeo = new THREE.BoxGeometry(7,0.05,6);
  const gpMat = new THREE.MeshPhongMaterial({color:0x0a0f14,emissive:0x050a0f});
  const gp = new THREE.Mesh(gpGeo,gpMat);
  gp.position.set(0,-0.025,0);
  three.scene.add(gp);

  // Camera position based on level — sync camLY so orbit stays centred
  if(lvl==='building'||lvl==='township'){
    const totalH = bd.h*(fh+gap);
    camLY = totalH*0.35;
    camR = 18; camT = 0.7; camP = 0.75;
    three.cam.position.set(
      camR*Math.sin(camT)*Math.sin(camP),
      camLY+camR*Math.cos(camP),
      camR*Math.cos(camT)*Math.sin(camP)
    );
    three.cam.lookAt(0, camLY, 0);
  } else {
    const selY = (si>=0?si:0)*(fh+gap)+fh/2;
    camLY = selY;
    camR = 12; camT = 0.7; camP = 0.85;
    three.cam.position.set(
      camR*Math.sin(camT)*Math.sin(camP),
      camLY+camR*Math.cos(camP),
      camR*Math.cos(camT)*Math.sin(camP)
    );
    three.cam.lookAt(0, camLY, 0);
  }
}

let drag3=false,lx=0,ly=0;
function setupOrbit(cv){
  cv.onmousedown=e=>{drag3=true;lx=e.clientX;ly=e.clientY;};
  window.addEventListener('mouseup',()=>drag3=false);
  window.addEventListener('mousemove',e=>{
    if(!drag3||!three.cam)return;
    camT-=(e.clientX-lx)*.01;camP=Math.max(.1,Math.min(1.5,camP-(e.clientY-ly)*.01));
    lx=e.clientX;ly=e.clientY;updCam();
  });
  cv.onwheel=e=>{camR=Math.max(5,Math.min(30,camR+e.deltaY*.02));updCam();};
}
let camLY=2;function updCam(){if(!three.cam)return;three.cam.position.set(camR*Math.sin(camT)*Math.sin(camP),camLY+camR*Math.cos(camP),camR*Math.cos(camT)*Math.sin(camP));three.cam.lookAt(0,camLY,0);}

// ══════════════════════════════════════════════════
// LIVE TICK
// ══════════════════════════════════════════════════
setInterval(()=>{
  if(!S.params)return;
  Object.values(S.params).flat().forEach(p=>{
    if(typeof p.val==='number'&&p.max){
      p.val=parseFloat(Math.max(p.min||0,Math.min(p.max,p.val+(Math.random()-.5)*p.max*.02)).toFixed(1));
      const ve=document.getElementById('pv-'+p.id);if(ve)ve.textContent=p.val;
      const be=document.getElementById('pb-'+p.id);if(be)be.style.width=Math.min(100,p.val/p.max*100)+'%';
    }
  });
  if(Math.random()<.08){
    const evs=[{t:'ok',m:'Sensor self-test passed',a:'SEN-'+ri(100,999)},{t:'warn',m:`Power load at ${ri(80,94)}% capacity`,a:`AST-B${ri(1,42).toString().padStart(2,'0')}`},{t:'ok',m:'BIM–GIS sync completed',a:'PLATFORM·SYNC'}];
    const ev=evs[Math.floor(Math.random()*evs.length)];
    addEvent(ev.t,ev.m,ev.a);
  }
},2500);

// ══════════════════════════════════════════════════
// NETWORK VIEW
// ══════════════════════════════════════════════════

// ── Background mode ─────────────────────────────
let netBG = 'terrain'; // terrain | satellite | schematic

function setBG(mode){
  netBG = mode;
  ['terrain','satellite','schematic'].forEach(m=>{
    document.getElementById('nbg-'+m).classList.toggle('active', m===mode);
  });
  drawNetBG();
  drawNet();
}

function drawNetBG(){
  const cv = document.getElementById('ncv-bg');
  if(!cv) return;
  const parent = cv.parentElement;
  const W = parent.clientWidth;
  const H = parent.clientHeight - 64; // minus top bar + status bar
  cv.width = W; cv.height = H;
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,W,H);

  if(netBG === 'schematic'){
    // Dark grid only — matches old look
    ctx.fillStyle = '#06090d';
    ctx.fillRect(0,0,W,H);
    return;
  }

  if(netBG === 'satellite'){
    // Simulated satellite: dark green/grey patches + grid
    ctx.fillStyle = '#0a1208';
    ctx.fillRect(0,0,W,H);
    // Irregular land patches
    const patches = [
      {x:.08,y:.1,w:.25,h:.18,c:'#0d1a0a'},{x:.3,y:.05,w:.2,h:.15,c:'#0e1e0b'},
      {x:.5,y:.12,w:.3,h:.22,c:'#0c1809'},{x:.1,y:.4,w:.35,h:.25,c:'#0f200c'},
      {x:.55,y:.45,w:.28,h:.2,c:'#0d1b0a'},{x:.2,y:.7,w:.4,h:.2,c:'#0e1e0b'},
      {x:.65,y:.7,w:.2,h:.18,c:'#0c1809'}
    ];
    patches.forEach(p=>{
      ctx.fillStyle = p.c;
      ctx.beginPath();
      ctx.ellipse(p.x*W+(p.w*W/2), p.y*H+(p.h*H/2), p.w*W/2, p.h*H/2, 0, 0, Math.PI*2);
      ctx.fill();
    });
    // Roads (thin light lines)
    ctx.strokeStyle = 'rgba(80,100,80,0.4)'; ctx.lineWidth = 1.5;
    [[.0,.3,.4,.3],[.4,.0,.4,.6],[.1,.6,.9,.6],[.6,.1,.6,.9]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath(); ctx.moveTo(x1*W,y1*H); ctx.lineTo(x2*W,y2*H); ctx.stroke();
    });
    // Site boundary
    ctx.strokeStyle = 'rgba(0,200,100,0.25)'; ctx.lineWidth = 1;
    ctx.setLineDash([6,4]);
    ctx.strokeRect(W*.06, H*.06, W*.88, H*.88);
    ctx.setLineDash([]);
    // Grid overlay
    ctx.strokeStyle = 'rgba(0,100,50,0.1)'; ctx.lineWidth = 0.5;
    for(let x=0;x<W;x+=W/12){ ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke(); }
    for(let y=0;y<H;y+=H/10){ ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke(); }
    return;
  }

  // TERRAIN mode — contour-style topographic
  ctx.fillStyle = '#07100d';
  ctx.fillRect(0,0,W,H);
  // Zone fills — sector regions
  const zones = [
    {pts:[[.05,.05],[.45,.05],[.45,.45],[.05,.45]], c:'rgba(0,40,20,0.4)', lbl:'ZONE A'},
    {pts:[[.55,.05],[.95,.05],[.95,.45],[.55,.45]], c:'rgba(0,30,50,0.35)', lbl:'ZONE B'},
    {pts:[[.05,.55],[.45,.55],[.45,.95],[.05,.95]], c:'rgba(20,40,10,0.3)', lbl:'ZONE C'},
    {pts:[[.55,.55],[.95,.55],[.95,.95],[.55,.95]], c:'rgba(0,20,40,0.3)', lbl:'ZONE D'},
  ];
  zones.forEach(z=>{
    ctx.fillStyle = z.c;
    ctx.beginPath();
    z.pts.forEach(([x,y],i)=> i===0 ? ctx.moveTo(x*W,y*H) : ctx.lineTo(x*W,y*H));
    ctx.closePath(); ctx.fill();
    // Zone label
    const cx = z.pts.reduce((s,p)=>s+p[0],0)/4*W;
    const cy = z.pts.reduce((s,p)=>s+p[1],0)/4*H;
    ctx.fillStyle = 'rgba(0,180,100,0.2)';
    ctx.font = 'bold 11px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(z.lbl, cx, cy);
  });
  // Contour lines
  ctx.strokeStyle = 'rgba(0,120,60,0.15)'; ctx.lineWidth = 0.8;
  for(let i=1;i<6;i++){
    const r = i*0.14;
    ctx.beginPath();
    ctx.ellipse(W*0.35, H*0.4, W*r, H*r*0.7, -0.3, 0, Math.PI*2);
    ctx.stroke();
    ctx.beginPath();
    ctx.ellipse(W*0.72, H*0.6, W*r*0.8, H*r*0.6, 0.2, 0, Math.PI*2);
    ctx.stroke();
  }
  // Site boundary
  ctx.strokeStyle = 'rgba(0,200,100,0.3)'; ctx.lineWidth = 1.5;
  ctx.setLineDash([8,5]);
  ctx.strokeRect(W*.04, H*.04, W*.92, H*.92);
  ctx.setLineDash([]);
  // North arrow
  ctx.fillStyle = 'rgba(0,200,100,0.5)';
  ctx.font = 'bold 10px monospace'; ctx.textAlign = 'left';
  ctx.fillText('N ↑', W-30, 20);
  // Scale bar
  ctx.strokeStyle = 'rgba(0,200,100,0.4)'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(14,H-14); ctx.lineTo(64,H-14); ctx.stroke();
  ctx.fillStyle = 'rgba(0,200,100,0.5)'; ctx.font = '8px monospace'; ctx.textAlign='left';
  ctx.fillText('~200m', 14, H-18);
}

function initNet(){
  if(netReady){drawNetBG();drawNet();return;}
  netReady=true;
  const cv=document.getElementById('ncv');
  const wrap=cv.parentElement;
  const W=wrap.clientWidth, H=wrap.clientHeight-38-26;
  cv.width=W; cv.height=H;
  // Size bg canvas to match
  const bg=document.getElementById('ncv-bg');
  if(bg){bg.width=W;bg.height=H;}
  drawNetBG();

  // Mouse events
  cv.addEventListener('mousemove',e=>{
    const r=cv.getBoundingClientRect();
    const mx=(e.clientX-r.left-nox)/netZ;
    const my=(e.clientY-r.top-noy)/netZ;
    const W=cv.width/netZ,H=cv.height/netZ;
    let found=null;
    for(const n of NDATA[curLayer].nodes){
      const nx=n.x*W,ny=n.y*H;
      const hit=n.type==='bldg'?Math.abs(mx-nx)<12&&Math.abs(my-ny)<9:Math.hypot(mx-nx,my-ny)<14;
      if(hit){found=n;break;}
    }
    hovNode=found;
    cv.style.cursor=found?'pointer':'crosshair';
    drawNet();
  });

  cv.addEventListener('click',e=>{
    if(hovNode){selNode=hovNode;showNodeDetail(hovNode);drawNet();}
  });

  cv.addEventListener('mousedown',e=>{nDrag=true;nLX=e.clientX;nLY=e.clientY;});
  window.addEventListener('mouseup',()=>nDrag=false);
  window.addEventListener('mousemove',e=>{
    if(!nDrag)return;
    nox+=e.clientX-nLX;noy+=e.clientY-nLY;nLX=e.clientX;nLY=e.clientY;
    drawNet();
  },{passive:true});
  cv.addEventListener('wheel',e=>{e.preventDefault();netZ=Math.max(.3,Math.min(3,netZ*(e.deltaY<0?1.1:.9)));drawNet();},{passive:false});

  buildTree();
  updateNetStats();
  drawNet();

  // Pulse animation loop
  (function loop(){requestAnimationFrame(loop);if(document.getElementById('s3').classList.contains('on'))drawNet();})();
}

function setLayer(l){
  curLayer=l;
  const togMap={water:'w',power:'p',drain:'d',road:'r',internet:'i'};
  Object.entries(togMap).forEach(([lname,k])=>{
    const el=document.getElementById('tog-'+k); if(!el) return;
    el.className='ntog'+(l===lname?' a'+k:'');
  });
  document.getElementById('nlname').textContent=LNAMES[l];
  selNode=null;hovNode=null;
  document.getElementById('ndetail').innerHTML='<div class="ni-empty" style="color:var(--tx2);font-size:10px;letter-spacing:.04em">Click any node<br>on the network<br>to view its details</div>';
  document.getElementById('ntag').textContent='—';
  // Update legend colour to match layer
  const col=LCOLS[l];
  const leg=document.getElementById('nleg');
  if(leg){
    leg.querySelectorAll('.ll').forEach(el=>{
      if(el.classList.contains('m')) el.style.background=col;
      else el.style.borderColor=col+'66';
    });
  }
  buildTree();updateNetStats();drawNetBG();drawNet();
}

function drawNet(){
  const cv=document.getElementById('ncv');if(!cv||!cv.getContext)return;
  const ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  ctx.clearRect(0,0,W,H);

  // Background grid
  ctx.save();
  ctx.strokeStyle='#0e151c';ctx.lineWidth=1;
  const gs=40*netZ;
  const ox=(nox%gs+gs)%gs,oy=(noy%gs+gs)%gs;
  for(let x=ox;x<W;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=oy;y<H;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.restore();

  ctx.save();
  ctx.translate(nox,noy);
  ctx.scale(netZ,netZ);

  const VW=W/netZ,VH=H/netZ;
  const col=LCOLS[curLayer];
  const nd=NDATA[curLayer];
  const nm={};nd.nodes.forEach(n=>nm[n.id]=n);

  // Edges
  nd.edges.forEach(e=>{
    const a=nm[e.a],b=nm[e.b];if(!a||!b)return;
    const isFault=faultEdges.some(fe=>(fe.a===e.a&&fe.b===e.b)||(fe.a===e.b&&fe.b===e.a));
    const ax=a.x*VW,ay=a.y*VH,bx=b.x*VW,by=b.y*VH;
    ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(bx,by);
    if(isFault){ctx.strokeStyle='#ff3d3d';ctx.lineWidth=e.m?3:2;ctx.setLineDash([]);ctx.shadowColor='rgba(255,61,61,.4)';ctx.shadowBlur=10;}
    else{ctx.strokeStyle=e.m?col:col+'55';ctx.lineWidth=e.m?2.5:1.2;ctx.setLineDash(e.m?[]:[5,5]);ctx.shadowBlur=0;}
    ctx.stroke();ctx.setLineDash([]);ctx.shadowBlur=0;
    // Arrow on main
    if(e.m&&!isFault){
      const mx=(ax+bx)/2,my=(ay+by)/2,ang=Math.atan2(by-ay,bx-ax);
      ctx.save();ctx.translate(mx,my);ctx.rotate(ang);
      ctx.beginPath();ctx.moveTo(-5,-3.5);ctx.lineTo(0,0);ctx.lineTo(-5,3.5);
      ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.setLineDash([]);ctx.stroke();
      ctx.restore();
    }
  });

  // Nodes
  nd.nodes.forEach(n=>{
    const nx=n.x*VW,ny=n.y*VH;
    const isFault=faultNodes.includes(n.id);
    const isHov=hovNode&&hovNode.id===n.id;
    const isSel=selNode&&selNode.id===n.id;
    const st=n.st||'ok';
    const nc=isFault?'#ff3d3d':st==='alert'?'#ff3d3d':st==='warn'?'#ffb300':col;

    ctx.shadowBlur=0;
    if(isHov||isSel||isFault||st==='alert'){ctx.shadowColor=isFault||st==='alert'?'rgba(255,61,61,.5)':isHov||isSel?col+'88':'rgba(255,179,0,.4)';ctx.shadowBlur=18;}

    if(n.type==='bldg'){
      // Rectangle for buildings
      ctx.fillStyle=isFault?'#2a0a0a':st==='alert'?'#1a0808':st==='warn'?'#1a1400':'#0e1820';
      ctx.strokeStyle=nc;ctx.lineWidth=(isHov||isSel)?2.5:isFault?2:1;
      ctx.beginPath();ctx.rect(nx-10,ny-7,20,14);ctx.fill();ctx.stroke();
    } else {
      // Circle for infra
      const r=n.type==='source'?12:n.type==='tank'?9:8;
      ctx.fillStyle=nc+'22';ctx.strokeStyle=nc;ctx.lineWidth=(isHov||isSel)?2.5:1.5;
      // Outer ring
      ctx.beginPath();ctx.arc(nx,ny,r+3,0,Math.PI*2);ctx.strokeStyle=nc+'33';ctx.lineWidth=1;ctx.stroke();
      // Main circle
      ctx.beginPath();ctx.arc(nx,ny,r,0,Math.PI*2);ctx.fillStyle=nc+'22';ctx.fill();ctx.strokeStyle=nc;ctx.lineWidth=(isHov||isSel)?2.5:1.5;ctx.stroke();
      // Centre
      ctx.beginPath();ctx.arc(nx,ny,3,0,Math.PI*2);ctx.fillStyle=nc;ctx.fill();
    }
    ctx.shadowBlur=0;

    // Pulse on alert
    if(st==='alert'||isFault){
      const pulse=(Date.now()%1200)/1200;
      const pr=n.type==='bldg'?16:20;
      ctx.beginPath();ctx.arc(nx,ny,pr+pulse*8,0,Math.PI*2);
      ctx.strokeStyle=`rgba(255,61,61,${.5*(1-pulse)})`;ctx.lineWidth=1.5;ctx.setLineDash([]);ctx.stroke();
    }

    // Label
    if(netZ>0.5){
      ctx.fillStyle=(isHov||isSel)?'#fff':nc+'cc';
      ctx.font=`${Math.max(6,7/netZ)}px JetBrains Mono`;
      ctx.textAlign='center';ctx.shadowBlur=0;
      ctx.fillText(n.id,nx,ny+(n.type==='bldg'?16:20)/netZ);
    }
  });

  ctx.restore();
}

function showNodeDetail(n){
  document.getElementById('ntag').textContent=n.id;
  // Highlight tree
  document.querySelectorAll('.tnd').forEach(el=>el.classList.remove('sel'));
  const tel=document.getElementById('tn-'+n.id);if(tel){tel.classList.add('sel');tel.scrollIntoView({block:'nearest'});}

  const st=n.st||'ok';
  const sc=st==='alert'?'alert':st==='warn'?'warn':'ok';
  const col=LCOLS[curLayer];

  // Build readings
  const readings=[];
  if(n.pressure&&n.pressure.includes('bar'))readings.push({l:'Pressure',v:n.pressure,pct:parseFloat(n.pressure)/4*100,c:sc==='ok'?'#00e676':sc==='warn'?'#ffb300':'#ff3d3d'});
  if(n.flow&&n.flow.includes('L/min'))readings.push({l:'Flow',v:n.flow,pct:parseFloat(n.flow)/250*100,c:col});
  if(n.level&&n.level.includes('m'))readings.push({l:'Level',v:n.level,pct:parseFloat(n.level)/3*100,c:parseFloat(n.level)>1.8?'#ff3d3d':parseFloat(n.level)>1.4?'#ffb300':'#50dc78'});
  if(n.load&&n.load.includes('kW'))readings.push({l:'Load',v:n.load,pct:parseFloat(n.load)/500*100,c:col});
  if(n.voltage&&n.voltage.includes('V'))readings.push({l:'Voltage',v:n.voltage,pct:85,c:col});

  // Connected nodes
  const edges=NDATA[curLayer].edges;
  const conn=edges.filter(e=>e.a===n.id||e.b===n.id).map(e=>e.a===n.id?e.b:e.a).slice(0,5);
  const nm={};NDATA[curLayer].nodes.forEach(x=>nm[x.id]=x);

  let html=`<div class="ni-id" style="color:${col}">${n.id}</div>`;
  html+=`<div class="ni-tl">${(n.lbl||n.type||'ASSET').toUpperCase()} · ${curLayer.toUpperCase()}</div>`;
  html+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">`;
  html+=`<div style="width:6px;height:6px;border-radius:50%;background:${sc==='ok'?'#00e676':sc==='warn'?'#ffb300':'#ff3d3d'}"></div>`;
  html+=`<span style="font-size:9px;color:${sc==='ok'?'#00e676':sc==='warn'?'#ffb300':'#ff3d3d'};font-weight:700;letter-spacing:.1em">${st.toUpperCase()}</span></div>`;

  if(readings.length){
    html+=`<div class="ni-sec">Live Readings</div><div class="ni-rb">`;
    readings.forEach(r=>{html+=`<div class="ni-rb-r"><span class="ni-rb-l">${r.l}</span><div class="ni-rb-b"><div class="ni-rb-f" style="width:${Math.min(100,r.pct)}%;background:${r.c}"></div></div><span class="ni-rb-v">${r.v}</span></div>`;});
    html+=`</div>`;
  }

  html+=`<div class="ni-sec">Properties</div>`;
  const props=[];
  if(n.floors!==undefined){props.push(['Type','Building']);props.push(['Floors',n.floors+'F']);}
  else props.push(['Node Type',n.type]);
  props.push(['Network',curLayer]);
  if(n.pressure)props.push(['Pressure',n.pressure]);
  if(n.flow)props.push(['Flow',n.flow]);
  if(n.voltage)props.push(['Voltage',n.voltage]);
  if(n.load)props.push(['Load',n.load]);
  if(n.level)props.push(['Level',n.level]);
  props.forEach(([k,v])=>html+=`<div class="ni-row"><span class="ni-k">${k}</span><span class="ni-v ${sc}">${v}</span></div>`);

  if(conn.length){
    html+=`<div class="ni-sec">Connected To</div><div class="deplist">`;
    conn.forEach(cid=>{
      const cn=nm[cid];if(!cn)return;
      const cs=cn.st||'ok';const cc=cs==='alert'?'#ff3d3d':cs==='warn'?'#ffb300':'#6a90aa';
      html+=`<div class="depitem" onclick="jumpToNode('${cid}')"><div style="width:5px;height:5px;border-radius:50%;background:${cc};flex-shrink:0"></div><span>${cid}</span><span style="margin-left:auto;font-size:8px;color:${cc}">${cs.toUpperCase()}</span></div>`;
    });
    html+=`</div>`;
  }

  html+=`<div class="ni-sec">Data Sources</div><div class="irow">`;
  if(n.type==='bldg')html+=`<span class="ib ib-bim"><span class="ib-dot"></span>BIM</span>`;
  html+=`<span class="ib ib-gis"><span class="ib-dot"></span>GIS</span><span class="ib ib-sca"><span class="ib-dot"></span>SCADA</span></div>`;

  // ── Sensor controls ──
  const hasSensor = n.type !== 'bldg';
  if(hasSensor){
    const senId = 'SEN-' + n.id;
    const isOn = !faultNodes.includes(n.id);
    html += `<div class="sen-ctrl">
      <div>
        <div class="sen-ctrl-lbl">📡 Sensor ${senId}</div>
        <div style="font-size:8px;color:var(--tx3);margin-top:2px">${isOn?'Transmitting live data':'Offline — no data'}</div>
      </div>
      <label class="sen-toggle">
        <input type="checkbox" ${isOn?'checked':''} onchange="toggleSensor('${n.id}',this.checked)">
        <div class="sen-toggle-track"></div>
        <div class="sen-toggle-thumb"></div>
      </label>
    </div>`;
    // Valve / isolate control for water/drain
    if(curLayer==='water'||curLayer==='drain'){
      html += `<div class="sen-ctrl">
        <div>
          <div class="sen-ctrl-lbl">🔧 Isolation Valve</div>
          <div style="font-size:8px;color:var(--tx3);margin-top:2px">Manual override control</div>
        </div>
        <button class="de-act-btn" style="padding:4px 10px;font-size:8px;width:auto"
          onclick="this.textContent=this.textContent.includes('CLOSE')?'✓ ISOLATED':'CLOSE VALVE'">
          CLOSE VALVE
        </button>
      </div>`;
    }
    if(curLayer==='power'){
      html += `<div class="sen-ctrl">
        <div>
          <div class="sen-ctrl-lbl">⚡ Breaker Control</div>
          <div style="font-size:8px;color:var(--tx3);margin-top:2px">Remote trip / reset</div>
        </div>
        <button class="de-act-btn urgent" style="padding:4px 10px;font-size:8px;width:auto"
          onclick="this.textContent=this.textContent.includes('TRIP')?'✓ TRIPPED':'RESET BREAKER'">
          TRIP BREAKER
        </button>
      </div>`;
    }
  }

  document.getElementById('ndetail').innerHTML=html;
}

function toggleSensor(nodeId, on){
  if(on){
    faultNodes = faultNodes.filter(id=>id!==nodeId);
  } else {
    if(!faultNodes.includes(nodeId)) faultNodes.push(nodeId);
  }
  drawNet();
  // Re-show detail with updated state
  const n = NDATA[curLayer].nodes.find(x=>x.id===nodeId);
  if(n){ n.st = on ? 'ok' : 'alert'; showNodeDetail(n); }
}

function jumpToNode(id){
  const n=NDATA[curLayer].nodes.find(x=>x.id===id);if(!n)return;
  selNode=n;hovNode=n;showNodeDetail(n);
  const cv=document.getElementById('ncv');
  nox=cv.width/2-n.x*cv.width;
  noy=cv.height/2-n.y*cv.height;
  drawNet();
}

function buildTree(){
  const nd=NDATA[curLayer];
  const col=LCOLS[curLayer];
  let html='';
  const infra=nd.nodes.filter(n=>n.type!=='bldg');
  const bldgs=nd.nodes.filter(n=>n.type==='bldg');
  const typeTag={source:'SRC',jct:'JCT',valve:'VLV',tank:'TNK'};
  infra.forEach(n=>{
    const st=n.st||'ok';const dc=st==='alert'?'#ff3d3d':st==='warn'?'#ffb300':col;
    html+=`<div class="tnd" id="tn-${n.id}" onclick="jumpToNode('${n.id}')"><div class="tdot" style="background:${dc}"></div><span>${n.id}</span><span class="ttag">${typeTag[n.type]||'INF'}</span></div>`;
  });
  if(bldgs.length){
    html+=`<div class="tnd" style="cursor:default;background:rgba(0,0,0,.25);color:var(--tx3);font-size:8px"><span style="letter-spacing:.1em">── BUILDINGS (${bldgs.length})</span></div>`;
    bldgs.forEach(n=>{
      const st=BLDGS.find(b=>b.id===n.id)?.status||n.st||'ok';
      const dc=st==='alert'?'#ff3d3d':st==='warn'?'#ffb300':'#2a4060';
      html+=`<div class="tnd ch" id="tn-${n.id}" onclick="jumpToNode('${n.id}')"><div class="tdot" style="background:${dc}"></div><span>${n.id}</span><span class="ttag">${n.floors}F</span></div>`;
    });
  }
  document.getElementById('atree').innerHTML=html;
}

function netJumpToBuilding(id){
  if(!id) return;
  const n=NDATA[curLayer].nodes.find(x=>x.id===id);
  if(n){ jumpToNode(id); }
  else {
    // Building not in this layer — just highlight search
    document.getElementById('asrch').value=id;
    filterTree(id);
  }
}

function filterTree(q){
  q=q.toLowerCase();
  document.querySelectorAll('.tnd').forEach(el=>{el.style.display=(!q||el.textContent.toLowerCase().includes(q))?'':'none';});
}

function updateNetStats(){
  const nd=NDATA[curLayer];
  document.getElementById('nst1').textContent=nd.nodes.length;
  document.getElementById('nst2').textContent=nd.edges.length;
  document.getElementById('nst3').textContent=nd.nodes.filter(n=>n.st==='warn').length;
  document.getElementById('nst4').textContent=nd.nodes.filter(n=>n.st==='alert').length;
}


function nzoom(f){netZ=Math.max(.3,Math.min(3,netZ*f));drawNet();}
function nreset(){netZ=1;nox=0;noy=0;drawNet();}

// ══════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════
renderGrid();
// Seed event log
[{t:'warn',m:'Water pressure dropped to 1.3 bar',a:'AST-B04-F03-302'},
 {t:'ok',m:'SCADA link re-established',a:'SCD-B11-GF'},
 {t:'alert',m:'Drain level 2.1m — threshold exceeded',a:'SEN-DRAIN-045 · B22'},
 {t:'ok',m:'Structural load — within tolerance',a:'AST-B07-F06-601'},
 {t:'warn',m:'Power load 87% of rated capacity',a:'AST-B15-F02'},
].forEach(e=>addEvent(e.t,e.m,e.a));



// ══════════════════════════════════════════════════════════════
// SCREEN 4 — DECISION ENGINE  v3
// Three scenarios: Flood, Power, Fire
// Centre: Three.js 3D site — Right: Failure Detail + Impact
// All data from NDATA, BLDGS (live)
// ══════════════════════════════════════════════════════════════


// ══════════════════════════════════════════════════════════════
// SCREEN 4 — DECISION ENGINE
// Three utility layers: Drain, Power, Water
// Views: BIM (3D) · GIS (2D network map) · SCADA (sensor table)
// ══════════════════════════════════════════════════════════════

let deCurLayer   = null;   // 'drain' | 'power' | 'water'
let deView       = 'bim';  // 'bim' | 'gis' | 'scada'
let de3 = { scene:null, cam:null, rend:null, af:null };
let de3Drag=false, de3LX=0, de3LY=0;
let de3CamT=0.6, de3CamP=0.7, de3CamR=22;
let de3Objects = {};
let de3AnimStep = 0;
let floodMesh=null, netLines=[], fireGlow=null;
const DE_SITE_W=18, DE_SITE_D=14;
let deGisAF = null;

// ── Layer config ─────────────────────────────────────────────
const DE_LAYERS = {
  drain: {
    label:'Drainage & Sewer', icon:'🌧', color:'#50dc78',
    scenario:'flood',   // maps to existing DE_SCENARIOS key for right-panel content
    triggerNode:'MH-05', triggerField:'level', triggerUnit:'m',
  },
  power: {
    label:'Power / Electrical', icon:'⚡', color:'#ffc800',
    scenario:'power',
    triggerNode:'SUB-B', triggerField:'voltage', triggerUnit:'',
  },
  water: {
    label:'Water Supply', icon:'💧', color:'#00b4ff',
    scenario:null,  // water has no fire/flood scenario — shows sensor data only
    triggerNode:'JN-W2', triggerField:'pressure', triggerUnit:'bar',
  }
};

// ── DE Scenario definitions (for right panel content) ─────────
const DE_SCENARIOS = {
  flood: {
    getSensorRows() {
      const nd=NDATA.drain; const nm={};nd.nodes.forEach(n=>nm[n.id]=n);
      return [
        {id:'MH-05',loc:'Zone S — main drain',    val:nm['MH-05']?.level||'—', st:parseFloat(nm['MH-05']?.level)>1.8?'crit':'warn'},
        {id:'MH-02',loc:'Zone S — downstream',    val:nm['MH-02']?.level||'—', st:parseFloat(nm['MH-02']?.level)>1.8?'crit':'ok'},
        {id:'MH-08',loc:'Zone W — outlet',        val:nm['MH-08']?.level||'—', st:'ok'},
        {id:'PUMP-01',loc:'B-22 Basement pump',   val:nm['PUMP-01']?.flow||'—', st:'ok'},
        {id:'RET-01', loc:'Retention tank',       val:nm['RET-01']?.level||'—', st:'ok'},
      ];
    },
    getImpactRows() {
      return [
        {icon:'🔩',name:'MH-05',type:'Drain manhole · Zone S — OVERFLOW',st:'crit'},
        {icon:'🔩',name:'MH-02',type:'Drain manhole · downstream affected',st:'warn'},
        {icon:'🏢',name:'B22',  type:'10F Residential · Basement at risk',st:'crit'},
        {icon:'🏢',name:'B04',  type:'6F Residential · Zone A affected',  st:'warn'},
        {icon:'⚡',name:'Elec Panel B22/B1',type:'MEP · Basement -1 isolation needed',st:'crit'},
      ];
    },
    actions:[
      {label:'Close isolation valve MH-05',     urgent:true },
      {label:'Alert residents — B22 basement',  urgent:true },
      {label:'Dispatch drainage team',          urgent:false},
    ],
    highlight:{bldgs:['B22','B04'],nodes:['MH-05','MH-02'],floodZone:true},
    callout:{id:'MH-05 — Live Reading', val:'2.1m  ⚠ Limit: 1.8m'},
    failSub:'Drain breach · Zone S', impactSub:'2 buildings + 3 assets at risk',
  },
  power: {
    getSensorRows() {
      const nd=NDATA.power; const nm={};nd.nodes.forEach(n=>nm[n.id]=n);
      return [
        {id:'SUB-B',  loc:'Substation B — feeder',   val:nm['SUB-B']?.voltage||'—',  st:(nm['SUB-B']?.voltage==='FAIL'||nm['SUB-B']?.load==='FAULT')?'crit':'ok'},
        {id:'TR-02',  loc:'Transformer 2 — Zone B',  val:nm['TR-02']?.voltage||'—',  st:nm['TR-02']?.voltage==='FAIL'?'crit':'ok'},
        {id:'DB-02',  loc:'Distribution Board 2',    val:nm['DB-02']?.voltage||'—',  st:nm['DB-02']?.voltage==='OFFLINE'?'crit':'warn'},
        {id:'DB-03',  loc:'Distribution Board 3',    val:nm['DB-03']?.load||'—',     st:'ok'},
        {id:'GEN-02', loc:'DG Set 2 — backup',       val:nm['GEN-02']?.load||'—',    st:'warn'},
      ];
    },
    getImpactRows() {
      return [
        {icon:'🔌',name:'SUB-B',  type:'Substation B — FEEDER FAULT',        st:'crit'},
        {icon:'🔌',name:'TR-02',  type:'Transformer 2 — OFFLINE',            st:'crit'},
        {icon:'🏢',name:'B06',    type:'8F Building — no power',             st:'crit'},
        {icon:'🏢',name:'B07',    type:'12F Mixed Use — partial power',      st:'warn'},
        {icon:'🔋',name:'GEN-02', type:'DG Set 2 — STANDBY not activated',  st:'warn'},
      ];
    },
    actions:[
      {label:'Switch GEN-02 to B06 / B07',     urgent:true },
      {label:'Load shed non-critical circuits', urgent:false},
      {label:'Dispatch restoration team',       urgent:false},
    ],
    highlight:{bldgs:['B06','B07'],nodes:['SUB-B','TR-02','DB-02'],floodZone:false},
    callout:{id:'SUB-B — Status', val:'FEEDER FAULT  🔴 TRIPPED'},
    failSub:'Substation B trip · Feeder fault', impactSub:'4 buildings + 3 nodes offline',
  },
};

// Water layer — sensor-only, no scenario
DE_SCENARIOS.water = {
  getSensorRows() {
    const nd=NDATA.water; const nm={};nd.nodes.forEach(n=>nm[n.id]=n);
    return [
      {id:'RES-01', loc:'Water Reservoir',         val:nm['RES-01']?.pressure||'—', st:'ok'},
      {id:'JN-W2',  loc:'Junction W2 — Zone A',    val:nm['JN-W2']?.pressure||'—',  st:parseFloat(nm['JN-W2']?.pressure)<2?'warn':'ok'},
      {id:'VLV-01', loc:'Isolation Valve',         val:nm['VLV-01']?.flow||'—',     st:nm['VLV-01']?.st||'warn'},
      {id:'TNK-01', loc:'Overhead Tank 1',         val:nm['TNK-01']?.pressure||'—', st:'ok'},
      {id:'STP-01', loc:'STP Plant',               val:nm['STP-01']?.pressure||'—', st:'ok'},
    ];
  },
  getImpactRows() {
    return [
      {icon:'🔧',name:'VLV-01',   type:'Isolation valve — PARTIAL OPEN',   st:'warn'},
      {icon:'🔩',name:'JN-W2',   type:'Junction W2 — low pressure 1.3 bar',st:'warn'},
      {icon:'🏢',name:'B04',     type:'6F Residential — low water pressure',st:'warn'},
      {icon:'🏢',name:'B07',     type:'12F Tower — pressure within tolerance',st:'ok'},
    ];
  },
  actions:[
    {label:'Open isolation valve VLV-01 fully',  urgent:false},
    {label:'Check overhead tank TNK-01 level',   urgent:false},
  ],
  highlight:{bldgs:['B04'],nodes:['JN-W2','VLV-01'],floodZone:false},
  callout:{id:'JN-W2 — Pressure', val:'1.3 bar  ⚠ Minimum: 2.0 bar'},
  failSub:'Low pressure · Zone A', impactSub:'1 building + 2 nodes affected',
};

// ── View switch ───────────────────────────────────────────────
function deSetView(v){
  deView = v;
  ['bim','gis','scada'].forEach(k=>{
    document.getElementById('de-vbtn-'+k).classList.toggle('active', k===v);
  });
  // Show/hide panels
  document.getElementById('de3d').style.display         = v==='bim'?'block':'none';
  document.getElementById('de-gis-cv').style.display    = v==='gis'?'block':'none';
  document.getElementById('de-scada-panel').style.display = v==='scada'?'block':'none';
  document.getElementById('de-callout').style.display   = (v==='bim'&&deCurLayer)?'block':'none';
  // Update hint
  const hint = document.getElementById('de-view-hint');
  if(hint) hint.textContent = v==='bim'?'Drag to rotate · Scroll to zoom':v==='gis'?'2D Network View':'Live Sensor Data';
  // Render appropriate view
  if(v==='bim')  { if(!de3.rend) initDE3D(); else if(deCurLayer) applyDE3DLayer(deCurLayer); }
  if(v==='gis')  drawDEGis();
  if(v==='scada'&&deCurLayer) renderDEScada(deCurLayer);
}

// ── Layer select ──────────────────────────────────────────────
function deSelectLayer(layerKey){
  deCurLayer = layerKey;
  const layer = DE_LAYERS[layerKey];

  // Update button highlights
  ['drain','power','water'].forEach(k=>{
    const btn = document.getElementById('de-btn-'+k);
    if(btn) btn.className = 'de-uc-btn'+(k===layerKey?' '+k+'-sel':'');
  });

  // Update view title
  document.getElementById('de-view-title').textContent =
    `${layer.icon}  ${layer.label}  ·  Sector 4-B`;

  // Render right panels from scenario (or water fallback)
  const sc = DE_SCENARIOS[layerKey] || DE_SCENARIOS[layer.scenario];
  if(sc){
    renderFailDetail(sc, layer);
    renderImpact(sc);
  }

  // Render active view
  if(deView==='bim'){
    if(!de3.rend) initDE3D();
    else applyDE3DLayer(layerKey);
  } else if(deView==='gis'){
    drawDEGis();
  } else {
    renderDEScada(layerKey);
  }

  // Callout
  if(sc && deView==='bim'){
    const co=document.getElementById('de-callout');
    if(co){
      co.style.display='block';
      document.getElementById('de-callout-id').textContent=sc.callout.id;
      document.getElementById('de-callout-val').textContent=sc.callout.val;
      co.style.borderColor=layer.color;
      document.getElementById('de-callout-val').style.color=layer.color;
    }
  }
}

// ── SCADA view ────────────────────────────────────────────────
function renderDEScada(layerKey){
  const panel = document.getElementById('de-scada-panel'); if(!panel) return;
  const layer = DE_LAYERS[layerKey];
  const nd = NDATA[layerKey];
  const col = layer.color;

  // Group nodes by type
  const sources = nd.nodes.filter(n=>n.type==='source'||n.type==='tank');
  const infra   = nd.nodes.filter(n=>n.type==='jct'||n.type==='valve');
  const bldgs   = nd.nodes.filter(n=>n.type==='bldg');

  function makeRows(nodes, title){
    if(!nodes.length) return '';
    let h = `<div class="de-scada-sec">${title}</div>`;
    nodes.forEach(n=>{
      const st = n.st==='alert'?'crit':n.st==='warn'?'warn':'ok';
      const stCol = st==='crit'?'#ff3d3d':st==='warn'?'#ffb300':col;
      // Pick the most meaningful reading
      const reading = n.pressure||n.level||n.flow||n.voltage||n.load||'—';
      const numVal = parseFloat(reading);
      const pct = !isNaN(numVal) ? Math.min(100, numVal/(
        n.pressure?4:n.level?3:n.flow?250:n.voltage?500:n.load?500:100
      )*100) : 0;
      h += `<div class="de-scada-row" style="border-left:2px solid ${stCol}">
        <div class="de-scada-id">${n.id}</div>
        <div class="de-scada-loc">${n.lbl||n.id}</div>
        <div class="de-scada-bar"><div class="de-scada-bar-f" style="width:${pct}%;background:${stCol}"></div></div>
        <div class="de-scada-val" style="color:${stCol}">${reading}</div>
        <div class="de-scada-st" style="color:${stCol}">${st.toUpperCase()}</div>
      </div>`;
    });
    return h;
  }

  panel.innerHTML =
    `<div style="font-size:9px;color:var(--tx2);margin-bottom:12px;letter-spacing:.06em">
      ${layer.icon} <b style="color:${col}">${layer.label}</b> &nbsp;·&nbsp; Live SCADA Readings
    </div>` +
    makeRows(sources, 'Sources & Storage') +
    makeRows(infra,   'Network Nodes') +
    makeRows(bldgs,   'Connected Buildings');
}

// ── GIS 2D view ───────────────────────────────────────────────
function drawDEGis(){
  const cv = document.getElementById('de-gis-cv'); if(!cv) return;
  const wrap = cv.parentElement;
  const W = wrap.clientWidth, H = wrap.clientHeight - 38;
  cv.width=W; cv.height=H;
  const ctx = cv.getContext('2d');
  const t = Date.now()/1000;

  // Background — terrain style
  ctx.fillStyle='#07100d'; ctx.fillRect(0,0,W,H);
  // Zone fills
  const zones=[['#002818','Zone A',.05,.05,.45,.45],['#001e30','Zone B',.55,.05,.9,.45],
                ['#001e14','Zone C',.05,.55,.45,.9], ['#00141e','Zone D',.55,.55,.9,.9]];
  zones.forEach(([c,lbl,x1,y1,x2,y2])=>{
    ctx.fillStyle=c; ctx.fillRect(x1*W,y1*H,(x2-x1)*W,(y2-y1)*H);
    ctx.fillStyle='rgba(0,180,100,.12)'; ctx.font='bold 11px monospace'; ctx.textAlign='center';
    ctx.fillText(lbl, ((x1+x2)/2)*W, ((y1+y2)/2)*H);
  });
  // Grid
  ctx.strokeStyle='rgba(0,100,40,.1)'; ctx.lineWidth=.5;
  for(let x=0;x<W;x+=W/12){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=H/9){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Site boundary
  ctx.strokeStyle='rgba(0,200,80,.25)'; ctx.lineWidth=1.5; ctx.setLineDash([6,4]);
  ctx.strokeRect(W*.03,H*.03,W*.94,H*.94); ctx.setLineDash([]);

  if(!deCurLayer){ // no layer — show prompt
    ctx.fillStyle='rgba(0,200,80,.3)'; ctx.font='11px monospace'; ctx.textAlign='center';
    ctx.fillText('Select a utility layer to view network',W/2,H/2);
    return;
  }

  const layerCfg = DE_LAYERS[deCurLayer];
  const nd = NDATA[deCurLayer];
  const col = layerCfg.color;
  const nm = {}; nd.nodes.forEach(n=>nm[n.id]=n);

  // Draw edges
  nd.edges.forEach(e=>{
    const a=nm[e.a], b=nm[e.b]; if(!a||!b) return;
    const ax=a.x*W, ay=a.y*H, bx=b.x*W, by=b.y*H;
    const isFault = (a.st==='alert'||b.st==='alert');
    ctx.strokeStyle = isFault ? '#ff3d3d' : e.m ? col : col+'44';
    ctx.lineWidth = e.m ? 2 : 1;
    ctx.setLineDash(e.m?[]:[4,4]);
    ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke();
    ctx.setLineDash([]);
    // Flow arrow on main lines
    if(e.m){
      const mx=(ax+bx)/2, my=(ay+by)/2, ang=Math.atan2(by-ay,bx-ax);
      ctx.save(); ctx.translate(mx,my); ctx.rotate(ang);
      ctx.strokeStyle=col; ctx.lineWidth=1.2;
      ctx.beginPath(); ctx.moveTo(-4,-2.5); ctx.lineTo(0,0); ctx.lineTo(-4,2.5); ctx.stroke();
      ctx.restore();
    }
  });

  // Draw nodes
  nd.nodes.forEach(n=>{
    const nx=n.x*W, ny=n.y*H;
    const st=n.st||'ok';
    const nc = st==='alert'?'#ff3d3d':st==='warn'?'#ffb300':col;
    const pulse = (Date.now()%1200)/1200;
    // Alert pulse ring
    if(st==='alert'||st==='warn'){
      ctx.beginPath(); ctx.arc(nx,ny,10+pulse*8,0,Math.PI*2);
      ctx.strokeStyle=`rgba(${st==='alert'?'255,61,61':'255,179,0'},${.5*(1-pulse)})`;
      ctx.lineWidth=1.5; ctx.stroke();
    }
    if(n.type==='bldg'){
      ctx.fillStyle=nc+'22'; ctx.strokeStyle=nc; ctx.lineWidth=1.2;
      ctx.fillRect(nx-9,ny-6,18,12); ctx.strokeRect(nx-9,ny-6,18,12);
    } else {
      const r=n.type==='source'?10:7;
      ctx.fillStyle=nc+'22'; ctx.strokeStyle=nc; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.arc(nx,ny,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.fillStyle=nc; ctx.beginPath(); ctx.arc(nx,ny,2.5,0,Math.PI*2); ctx.fill();
    }
    // Label
    ctx.fillStyle=nc; ctx.font='6.5px monospace'; ctx.textAlign='center';
    ctx.fillText(n.id, nx, ny+(n.type==='bldg'?16:18));
  });

  // North + scale
  ctx.fillStyle='rgba(0,200,80,.5)'; ctx.font='bold 9px monospace'; ctx.textAlign='right';
  ctx.fillText('N ↑',W-8,18);
  ctx.strokeStyle='rgba(0,200,80,.4)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(12,H-12); ctx.lineTo(62,H-12); ctx.stroke();
  ctx.fillStyle='rgba(0,200,80,.5)'; ctx.font='8px monospace'; ctx.textAlign='left';
  ctx.fillText('~200m',12,H-16);

  deGisAF = requestAnimationFrame(()=>{
    if(deView==='gis' && document.getElementById('s4').classList.contains('on')) drawDEGis();
  });
}

// ── Live Sensor Watch sidebar ─────────────────────────────────
function renderDEWatchList(){
  const el=document.getElementById('de-watch-list'); if(!el) return;
  const watches=[
    {id:'MH-05',loc:'Zone S drain',    val:parseFloat(NDATA.drain.nodes.find(n=>n.id==='MH-05')?.level)||0, unit:'m',   thresh:1.8, dir:'above', layer:'drain'},
    {id:'JN-W2', loc:'Water pressure', val:parseFloat(NDATA.water.nodes.find(n=>n.id==='JN-W2')?.pressure)||0, unit:'bar',thresh:2.0, dir:'below', layer:'water'},
    {id:'TR-02', loc:'Power feeder B', val:NDATA.power.nodes.find(n=>n.id==='TR-02')?.voltage||'OK', unit:'',thresh:null,dir:'fault', layer:'power'},
  ];
  el.innerHTML=watches.map(w=>{
    let st='ok';
    if(w.dir==='above'&&w.val>w.thresh)st='crit';
    else if(w.dir==='above'&&w.val>w.thresh*.9)st='warn';
    else if(w.dir==='below'&&w.val<w.thresh)st='warn';
    else if(w.dir==='fault'&&(w.val==='FAIL'||w.val==='OFFLINE'))st='crit';
    const display=typeof w.val==='number'?w.val.toFixed(2)+' '+w.unit:w.val;
    const thrTxt=w.thresh?`Limit: ${w.thresh}${w.unit}`:'Monitor';
    const col=st==='crit'?'#ff3d3d':st==='warn'?'#ffb300':DE_LAYERS[w.layer].color;
    return `<div class="de-watch-row ${st}" onclick="deSelectLayer('${w.layer}');deSetView('scada')">
      <div class="de-wr-left">
        <div class="de-wr-id">${w.id}</div>
        <div class="de-wr-loc">${w.loc}</div>
      </div>
      <div class="de-wr-right">
        <div class="de-wr-val ${st}" style="color:${col}">${display}</div>
        <div class="de-wr-thr">${thrTxt}</div>
      </div>
    </div>`;
  }).join('');

  // Update utility badges
  const drainVal=watches[0].val;
  const pwrVal=watches[2].val;
  const waterVal=watches[1].val;
  const badge=(id,st,txt)=>{
    const b=document.getElementById('de-badge-'+id);
    if(b){b.className='de-uc-badge '+st;b.textContent=txt;}
  };
  badge('drain', drainVal>1.8?'crit':drainVal>1.62?'warn':'ok', drainVal>1.8?'🔴 BREACH':drainVal>1.62?`⚠ ${drainVal.toFixed(1)}m`:'OK');
  badge('power', (pwrVal==='FAIL'||pwrVal==='OFFLINE')?'crit':'ok', (pwrVal==='FAIL'||pwrVal==='OFFLINE')?'🔴 FAULT':'OK');
  badge('water', waterVal<2.0?'warn':'ok', waterVal<2.0?`⚠ ${waterVal.toFixed(1)} bar`:'OK');
}

// ── Failure Detail (right panel top) ─────────────────────────
function renderFailDetail(sc, layer){
  const body=document.getElementById('de-fail-body');
  const sub=document.getElementById('de-fail-sub');
  if(!body) return;
  sub.textContent=sc.failSub;
  const rows=sc.getSensorRows();
  body.innerHTML=rows.map((r,i)=>{
    const col=r.st==='crit'?'#ff3d3d':r.st==='warn'?'#ffb300':layer.color;
    return `<div class="de-fail-row ${r.st}" style="animation-delay:${i*.08}s">
      <div class="de-fr-dot" style="background:${col}"></div>
      <div class="de-fr-main">
        <div class="de-fr-id">${r.id}</div>
        <div class="de-fr-loc">${r.loc}</div>
      </div>
      <div class="de-fr-val">
        <div class="de-fr-reading ${r.st}" style="color:${col}">${r.val}</div>
        <div class="de-fr-status">${r.st==='crit'?'BREACH':r.st==='warn'?'HIGH':'OK'}</div>
      </div>
    </div>`;
  }).join('');
}

// ── Impact Assessment (right panel bottom) ────────────────────
function renderImpact(sc){
  const body=document.getElementById('de-impact-body');
  const sub=document.getElementById('de-impact-sub');
  const actions=document.getElementById('de-actions');
  if(!body) return;
  sub.textContent=sc.impactSub;
  body.innerHTML=sc.getImpactRows().map((r,i)=>
    `<div class="de-impact-row ${r.st}" style="animation-delay:${i*.07}s">
      <div class="de-ir-icon">${r.icon}</div>
      <div class="de-ir-main">
        <div class="de-ir-name">${r.name}</div>
        <div class="de-ir-type">${r.type}</div>
      </div>
      <div class="de-ir-badge ${r.st}">${r.st==='crit'?'CRITICAL':r.st==='warn'?'WARNING':'NOMINAL'}</div>
    </div>`
  ).join('');
  actions.style.display='flex';
  actions.innerHTML=sc.actions.map((a,i)=>
    `<button class="de-act-btn${a.urgent?' urgent':''}" style="animation-delay:${i*.1}s"
      onclick="this.className='de-act-btn done';this.innerHTML='✓ &nbsp;'+this.textContent">
      ${a.urgent?'🔴':'▶'} &nbsp;${a.label}
    </button>`
  ).join('');
}

// ── 3D Engine ─────────────────────────────────────────────────
function getDE3DBldgs(){
  const cols=10;
  return BLDGS.slice(0,40).map((b,i)=>({
    id:b.id, x:(i%cols)*1.9-(DE_SITE_W/2)+.95,
    z:Math.floor(i/cols)*2.2-(DE_SITE_D/2)+1.1,
    h:Math.max(.6,b.floors*.28), status:b.status
  }));
}

function initDE3D(){
  const cv=document.getElementById('de3d'); if(!cv||de3.rend) return;
  const W=cv.parentElement.clientWidth;
  const H=cv.parentElement.clientHeight-38;
  cv.width=W; cv.height=H;
  de3.scene=new THREE.Scene();
  de3.scene.fog=new THREE.FogExp2(0x06090d,.04);
  de3.cam=new THREE.PerspectiveCamera(42,W/H,.1,200);
  de3.rend=new THREE.WebGLRenderer({canvas:cv,antialias:true,alpha:true});
  de3.rend.setSize(W,H); de3.rend.setPixelRatio(Math.min(devicePixelRatio,2));
  de3.rend.setClearColor(0x06090d,1); de3.rend.shadowMap.enabled=true;
  de3.scene.add(new THREE.AmbientLight(0x556677, 1.8));
  const sun=new THREE.DirectionalLight(0xbbddff, 2.4); sun.position.set(8,14,6); de3.scene.add(sun);
  const fill=new THREE.DirectionalLight(0x224466, 1.0); fill.position.set(-6,8,-10); de3.scene.add(fill);
  de3.scene.add(new THREE.GridHelper(DE_SITE_W*1.4,28,0x0e151c,0x0e151c));
  const gGeo=new THREE.PlaneGeometry(DE_SITE_W*1.6,DE_SITE_D*1.6);
  const ground=new THREE.Mesh(gGeo,new THREE.MeshLambertMaterial({color:0x0a0f14}));
  ground.rotation.x=-Math.PI/2; de3.scene.add(ground);
  de3Objects={};
  getDE3DBldgs().forEach(b=>{
    const geo=new THREE.BoxGeometry(1.4,b.h,1.4);
    const col=b.status==='alert'?0x3d1010:b.status==='warn'?0x2a2000:0x1a3040;
    const emitBase=b.status==='alert'?0x441414:b.status==='warn'?0x332200:0x0d1e2c;
    const mat=new THREE.MeshPhongMaterial({color:col,emissive:emitBase,emissiveIntensity:.3});
    const mesh=new THREE.Mesh(geo,mat); mesh.position.set(b.x,b.h/2,b.z);
    mesh.userData={id:b.id,baseH:b.h,baseCol:col,status:b.status};
    de3.scene.add(mesh); de3Objects[b.id]=mesh;
    const line=new THREE.LineSegments(new THREE.EdgesGeometry(geo),
      new THREE.LineBasicMaterial({color:0x2a4a6a}));
    line.position.copy(mesh.position); de3.scene.add(line);
  });
  updDE3Cam();
  cv.addEventListener('mousedown',e=>{de3Drag=true;de3LX=e.clientX;de3LY=e.clientY;cv.style.cursor='grabbing';});
  window.addEventListener('mouseup',()=>{de3Drag=false;cv.style.cursor='grab';});
  window.addEventListener('mousemove',e=>{
    if(!de3Drag)return;
    de3CamT-=(e.clientX-de3LX)*.008; de3CamP=Math.max(.15,Math.min(1.4,de3CamP-(e.clientY-de3LY)*.007));
    de3LX=e.clientX;de3LY=e.clientY; updDE3Cam();
  });
  cv.addEventListener('wheel',e=>{e.preventDefault();de3CamR=Math.max(8,Math.min(40,de3CamR+e.deltaY*.03));updDE3Cam();},{passive:false});
  (function loop(){de3.af=requestAnimationFrame(loop);
    if(!document.getElementById('s4').classList.contains('on'))return;
    de3AnimStep++;animateDE3D();de3.rend.render(de3.scene,de3.cam);
  })();
  if(deCurLayer) applyDE3DLayer(deCurLayer);
}

function updDE3Cam(){
  if(!de3.cam)return;
  de3.cam.position.set(
    de3CamR*Math.sin(de3CamT)*Math.sin(de3CamP),
    de3CamR*Math.cos(de3CamP),
    de3CamR*Math.cos(de3CamT)*Math.sin(de3CamP));
  de3.cam.lookAt(0,1,0);
}

function clearDE3DFX(){
  Object.values(de3Objects).forEach(m=>{
    const s=m.userData.status;
    const col  = s==='alert'?0x3d1010:s==='warn'?0x2a2000:0x1a3040;
    const emit = s==='alert'?0x441414:s==='warn'?0x332200:0x0d1e2c;
    m.material.color.setHex(col);
    m.material.emissive.setHex(emit);
    m.material.emissiveIntensity = .3;
    m.material.needsUpdate = true;
    m.userData.highlight = false;
    m.userData.hlBright  = null;
    m.userData.hlEmit    = null;
  });
  if(floodMesh){de3.scene.remove(floodMesh);floodMesh=null;}
  netLines.forEach(l=>de3.scene.remove(l));netLines=[];
  if(fireGlow){de3.scene.remove(fireGlow);fireGlow=null;}
}

function applyDE3DLayer(layerKey){
  clearDE3DFX();
  const sc = DE_SCENARIOS[layerKey]; if(!sc) return;
  const hl = sc.highlight;
  const bldgs=getDE3DBldgs(); const bmap={};bldgs.forEach(b=>bmap[b.id]=b);
  // Layer colour theme — bright, saturated, clearly visible
  const layerHue = layerKey==='power'
    ? {col:0x664400, emit:0xffaa00, bright:0xffdd44, light:0xffcc00}
    : layerKey==='drain'
    ? {col:0x003388, emit:0x0088ff, bright:0x44ccff, light:0x00aaff}
    : {col:0x005577, emit:0x00aacc, bright:0x44eeff, light:0x00ccff};

  const hlIds = hl.bldgs || [];
  hlIds.forEach((id,i)=>{
    const m = de3Objects[id];
    if(!m){ return; }  // silently skip — IDs checked below
    m.material.color.setHex(layerHue.col);
    m.material.emissive.setHex(layerHue.emit);
    m.material.emissiveIntensity = 1.8;
    m.material.needsUpdate = true;
    m.userData.highlight = true;
    m.userData.hlPhase = i * .6;
    m.userData.hlBright = layerHue.bright;
    m.userData.hlEmit  = layerHue.emit;
    // Strong point light above building
    const pl = new THREE.PointLight(layerHue.light, 2.0, 12);
    pl.position.set(m.position.x, m.userData.baseH + 3, m.position.z);
    de3.scene.add(pl); netLines.push(pl);
  });

  if(hl.floodZone){
    const fGeo=new THREE.PlaneGeometry(5,4);
    floodMesh=new THREE.Mesh(fGeo,new THREE.MeshBasicMaterial({color:0x0044ff,transparent:true,opacity:.18,side:THREE.DoubleSide}));
    floodMesh.rotation.x=-Math.PI/2;
    const b22=bmap['B22'],b04=bmap['B04'];
    if(b22&&b04)floodMesh.position.set((b22.x+b04.x)/2,.02,(b22.z+b04.z)/2);
    de3.scene.add(floodMesh);
  }

  // Draw network lines on the ground
  const nd=NDATA[layerKey]; const lineCol=layerKey==='power'?0xcc8800:layerKey==='drain'?0x00aaff:0x0088dd;
  const nodePos3D={};
  nd.nodes.forEach(n=>nodePos3D[n.id]=new THREE.Vector3((n.x-.5)*DE_SITE_W,.08,(n.y-.5)*DE_SITE_D));
  nd.edges.forEach(e=>{
    const a=nodePos3D[e.a],b=nodePos3D[e.b]; if(!a||!b)return;
    const isAlert=(nd.nodes.find(x=>x.id===e.a)?.st==='alert')||(nd.nodes.find(x=>x.id===e.b)?.st==='alert');
    const geo=new THREE.BufferGeometry().setFromPoints([a,b]);
    const lineW=isAlert?0xff3300:lineCol;
    const mat=new THREE.LineBasicMaterial({color:lineW});
    const line=new THREE.Line(geo,mat); de3.scene.add(line); netLines.push(line);
  });
  // Node spheres on ground for key infra nodes
  nd.nodes.filter(n=>n.type!=='bldg').forEach(n=>{
    const pos=nodePos3D[n.id]; if(!pos) return;
    const st=n.st||'ok';
    const sc=st==='alert'?0xff3300:st==='warn'?0xffaa00:parseInt(layerKey==='power'?'cc8800':layerKey==='drain'?'00aaff':'0088dd',16);
    const sg=new THREE.SphereGeometry(.25,10,10);
    const sm=new THREE.MeshPhongMaterial({color:sc,emissive:sc,emissiveIntensity:.9});
    const sp=new THREE.Mesh(sg,sm); sp.position.copy(pos); sp.position.y=.3;
    de3.scene.add(sp); netLines.push(sp);
    if(st==='alert'||st==='warn'){
      const pl=new THREE.PointLight(sc,.6,4); pl.position.copy(sp.position); de3.scene.add(pl); netLines.push(pl);
    }
  });
}

function animateDE3D(){
  const t = de3AnimStep * .04;
  Object.values(de3Objects).forEach(m=>{
    if(!m.userData.highlight) return;
    const p = (Math.sin(t + (m.userData.hlPhase||0)) + 1) / 2;
    // Pulse emissive intensity
    m.material.emissiveIntensity = 1.2 + p * 1.4;
    // Alternate between base emit and bright for visible flash effect
    const bright = m.userData.hlBright || 0x44ccff;
    const emit   = m.userData.hlEmit   || 0x0088ff;
    m.material.emissive.setHex(p > 0.5 ? bright : emit);
  });
  if(floodMesh) floodMesh.material.opacity = .15 + Math.sin(t) * .1;
}

// ── Init ──────────────────────────────────────────────────────
function onDETabOpen(){
  renderDEWatchList();
  if(!de3.rend){
    initDE3D();
    // Auto-select drain layer on first open
    if(!deCurLayer) setTimeout(()=>deSelectLayer('drain'), 300);
  } else {
    // Scene exists — just re-apply current layer highlight
    if(deCurLayer) setTimeout(()=>applyDE3DLayer(deCurLayer), 50);
    else setTimeout(()=>deSelectLayer('drain'), 50);
  }
}

// ══════════════════════════════════════════════════
// SCREEN 5 — CAMERA FEEDS
// ══════════════════════════════════════════════════
const CAMERAS = [
  {id:'CAM-01', loc:'B-04 · Lobby Entrance',     zone:'A', type:'CCTV',    st:'live',   mx:.12, my:.32},
  {id:'CAM-02', loc:'B-07 · Basement',            zone:'A', type:'CCTV',    st:'alert',  mx:.22, my:.55},
  {id:'CAM-03', loc:'North Perimeter Gate',        zone:'A', type:'PTZ',     st:'live',   mx:.38, my:.07},
  {id:'CAM-04', loc:'B-11 · Floor 3 Corridor',    zone:'B', type:'CCTV',    st:'alert',  mx:.58, my:.32},
  {id:'CAM-05', loc:'Construction Zone C',         zone:'B', type:'PTZ',     st:'live',   mx:.72, my:.18},
  {id:'CAM-06', loc:'B-15 · Rooftop',              zone:'B', type:'Thermal', st:'live',   mx:.82, my:.10},
  {id:'CAM-07', loc:'Drain MH-05 Area',            zone:'C', type:'CCTV',    st:'warn',   mx:.18, my:.72},
  {id:'CAM-08', loc:'B-22 · Basement Sump',        zone:'C', type:'CCTV',    st:'warn',   mx:.38, my:.82},
  {id:'CAM-09', loc:'South Perimeter Gate',        zone:'C', type:'PTZ',     st:'live',   mx:.50, my:.92},
  {id:'CAM-10', loc:'Material Storage',            zone:'D', type:'CCTV',    st:'offline',mx:.74, my:.68},
  {id:'CAM-11', loc:'B-22 · Ground Floor',         zone:'D', type:'Thermal', st:'live',   mx:.64, my:.80},
  {id:'CAM-12', loc:'Control Room',                zone:'D', type:'CCTV',    st:'live',   mx:.88, my:.88},
];

const CAM_EVENTS = [
  {id:'CAM-02', st:'al', msg:'Unauthorised access attempt detected',   time:'14:32'},
  {id:'CAM-04', st:'al', msg:'Smoke detector triggered — Floor 3',     time:'14:28'},
  {id:'CAM-07', st:'wn', msg:'Drain level elevated at MH-05',          time:'14:21'},
  {id:'CAM-08', st:'wn', msg:'Water rising — basement sump B-22',      time:'14:15'},
  {id:'CAM-03', st:'wn', msg:'Vehicle obstruction at North Gate',      time:'14:09'},
  {id:'CAM-01', st:'ok', msg:'Shift handover recorded',                time:'14:00'},
  {id:'CAM-12', st:'ok', msg:'Routine inspection complete',            time:'13:45'},
];

let camSel     = null;   // selected camera id
let camMotion  = true;
let camThermal = false;
let camAF      = null;
let camMapAF   = null;
let camSec     = 0, camMin = 32, camHr = 14;

function initCamScreen(){
  renderCamList();
  drawCamMap();
  renderCamIncidents();
  setInterval(()=>{
    camSec++;
    if(camSec>=60){camSec=0;camMin++;}
    if(camMin>=60){camMin=0;camHr=(camHr+1)%24;}
    const ts=`${String(camHr).padStart(2,'0')}:${String(camMin).padStart(2,'0')}:${String(camSec).padStart(2,'0')}`;
    const el=document.getElementById('cam-ol-bl');
    if(el) el.textContent='● REC  '+ts;
  }, 1000);
}

// ── Camera list ───────────────────────────────────
function renderCamList(){
  const COL = {live:'#00e676', alert:'#ff3d3d', warn:'#ffb300', offline:'#444'};
  let html = '';
  CAMERAS.forEach(c=>{
    const col = COL[c.st] || '#444';
    const cls = c.st==='alert'?'al':c.st==='warn'?'wn':'';
    html += `<div class="cam-item ${cls} ${camSel===c.id?'sel':''}" onclick="camSelect('${c.id}')">
      <div class="cam-item-dot" style="background:${col}"></div>
      <div class="cam-item-info">
        <div class="cam-item-id">${c.id}</div>
        <div class="cam-item-loc">${c.loc}</div>
      </div>
      <div class="cam-item-badge">${c.type}</div>
    </div>`;
  });
  document.getElementById('cam-list').innerHTML = html;
}

// ── Site map ─────────────────────────────────────
function drawCamMap(){
  const cv = document.getElementById('cam-map'); if(!cv) return;
  const W = 266, H = 170;
  cv.width = W; cv.height = H;
  const ctx = cv.getContext('2d');
  const t = Date.now()/1000;

  // Background
  ctx.fillStyle='#07100d'; ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#0e1a12'; ctx.lineWidth=.5;
  for(let x=0;x<W;x+=W/10){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=H/8) {ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // Site boundary
  ctx.strokeStyle='rgba(0,180,80,.25)'; ctx.lineWidth=1; ctx.setLineDash([5,4]);
  ctx.strokeRect(6,6,W-12,H-12); ctx.setLineDash([]);
  // Buildings (simple rectangles)
  ctx.fillStyle='rgba(14,24,32,.9)'; ctx.strokeStyle='#1a2a38'; ctx.lineWidth=.8;
  for(let r=0;r<5;r++) for(let c2=0;c2<7;c2++){
    const bx=14+c2*(W-28)/7, by=14+r*(H-28)/5;
    ctx.fillRect(bx,by,(W-28)/7-3,(H-28)/5-3);
    ctx.strokeRect(bx,by,(W-28)/7-3,(H-28)/5-3);
  }
  // North arrow
  ctx.fillStyle='rgba(0,200,80,.5)'; ctx.font='bold 8px monospace'; ctx.textAlign='right';
  ctx.fillText('N↑',W-4,14);

  // Camera markers
  const COL={live:'#00e676',alert:'#ff3d3d',warn:'#ffb300',offline:'#444'};
  CAMERAS.forEach(c=>{
    const cx=c.mx*W, cy=c.my*H;
    const col=COL[c.st]||'#444';
    const isSel=camSel===c.id;
    const pulse=(Math.sin(t*3+cx)>.5)&&c.st!=='offline';
    // Selection ring
    if(isSel){
      ctx.strokeStyle='rgba(0,200,255,.7)'; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.arc(cx,cy,10,0,Math.PI*2); ctx.stroke();
    }
    // Pulse ring for alerts
    if(c.st==='alert'||c.st==='warn'){
      const pr=(((Date.now()/800)%1));
      ctx.strokeStyle=col.replace(')',`,${0.6*(1-pr)})`).replace('rgb','rgba');
      ctx.strokeStyle=col+'66';
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(cx,cy,6+pr*8,0,Math.PI*2); ctx.stroke();
    }
    // Camera dot
    ctx.fillStyle = isSel ? 'rgba(0,200,255,.25)' : col+'22';
    ctx.strokeStyle = isSel ? '#00c8ff' : col;
    ctx.lineWidth = isSel ? 1.5 : 1;
    ctx.beginPath(); ctx.arc(cx,cy,isSel?7:5,0,Math.PI*2);
    ctx.fill(); ctx.stroke();
    // Camera icon dot
    ctx.fillStyle=col;
    ctx.beginPath(); ctx.arc(cx,cy,2.5,0,Math.PI*2); ctx.fill();
    // Label
    ctx.fillStyle=isSel?'#00c8ff':col;
    ctx.font=`${isSel?'bold ':''
}6px monospace`; ctx.textAlign='center';
    ctx.fillText(c.id.replace('CAM-','C'),cx,cy-(isSel?11:9));
  });

  // Map click handler (set once)
  if(!cv._clickBound){
    cv._clickBound=true;
    cv.style.cursor='pointer';
    cv.addEventListener('click', e=>{
      const r=cv.getBoundingClientRect();
      const scaleX=W/r.width, scaleY=H/r.height;
      const mx=(e.clientX-r.left)*scaleX;
      const my=(e.clientY-r.top)*scaleY;
      // Find nearest camera within 14px
      let best=null, bestD=14;
      CAMERAS.forEach(c=>{
        const d=Math.hypot(c.mx*W-mx, c.my*H-my);
        if(d<bestD){bestD=d;best=c;}
      });
      if(best) camSelect(best.id);
    });
  }

  camMapAF=requestAnimationFrame(()=>{
    if(document.getElementById('s5').classList.contains('on')) drawCamMap();
  });
}

// ── Select camera ─────────────────────────────────
function camSelect(id){
  camSel = id;
  const cam = CAMERAS.find(c=>c.id===id); if(!cam) return;
  // Update list highlight
  renderCamList();
  // Update header
  const COL={live:'#00e676',alert:'#ff3d3d',warn:'#ffb300',offline:'#444'};
  const col=COL[cam.st]||'#444';
  const dot=document.getElementById('cam-status-dot');
  if(dot){ dot.style.background=col; dot.style.animation=cam.st==='live'?'bk 2s infinite':'none'; }
  document.getElementById('cam-feed-title').textContent=`${cam.id}  ·  ${cam.loc}  ·  Zone ${cam.zone}`;
  document.getElementById('cam-tag').textContent=cam.id;
  // Overlays
  const tl=document.getElementById('cam-ol-tl');
  const tr=document.getElementById('cam-ol-tr');
  if(tl) tl.textContent=`${cam.id}  ·  ${cam.type}`;
  if(tr){ tr.textContent=cam.st.toUpperCase(); tr.style.color=col; }
  // Hide "no feed" overlay
  const nf=document.getElementById('cam-no-feed');
  if(nf) nf.style.display='none';
  // Start drawing feed
  if(camAF){ cancelAnimationFrame(camAF); camAF=null; }
  drawFeed(cam);
}

// ── Feed renderer ─────────────────────────────────
function drawFeed(cam){
  const wrap=document.getElementById('cam-canvas-wrap'); if(!wrap) return;
  const cv=document.getElementById('cam-cv'); if(!cv) return;
  const W=wrap.clientWidth||800;
  const H=wrap.clientHeight||480;
  if(cv.width!==W||cv.height!==H){ cv.width=W; cv.height=H; }
  const ctx=cv.getContext('2d');
  const t=Date.now()/1000;

  if(cam.st==='offline'){
    // NO SIGNAL screen
    ctx.fillStyle='#020806'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='rgba(0,200,100,.12)';
    for(let y=0;y<H;y+=4) ctx.fillRect(0,y,W,1);
    ctx.fillStyle='rgba(0,200,100,.3)';
    ctx.font=`bold ${W/10}px monospace`; ctx.textAlign='center';
    ctx.fillText('NO SIGNAL',W/2,H/2-10);
    ctx.font=`${W/30}px monospace`;
    ctx.fillText(cam.id+' · OFFLINE',W/2,H/2+30);
  } else {
    drawFeedScene(ctx, W, H, cam, t);
    // Scanlines
    ctx.fillStyle='rgba(0,0,0,.05)';
    for(let y=0;y<H;y+=3) ctx.fillRect(0,y,W,1);
    // Occasional noise line
    if(Math.random()<.03){
      ctx.fillStyle=`rgba(255,255,255,${Math.random()*.04})`;
      ctx.fillRect(0,Math.random()*H,W,Math.random()*2+1);
    }
    // Motion detection boxes
    if(camMotion) drawMotion(ctx,W,H,cam,t);
    // Thermal overlay
    if(camThermal) drawThermal(ctx,W,H,t);
    // Alert border flash
    if(cam.st==='alert'){
      ctx.strokeStyle=Math.sin(t*4)>.0?'rgba(255,61,61,.7)':'transparent';
      ctx.lineWidth=4; ctx.strokeRect(2,2,W-4,H-4);
    }
  }
  camAF=requestAnimationFrame(()=>{
    if(camSel===cam.id && document.getElementById('s5').classList.contains('on'))
      drawFeed(cam);
  });
}

function drawFeedScene(ctx, W, H, cam, t){
  const outdoor = cam.type==='PTZ'||cam.loc.includes('Gate')||cam.loc.includes('Rooftop')||cam.loc.includes('Zone');
  if(outdoor){
    // Sky
    const sky=ctx.createLinearGradient(0,0,0,H*.5);
    sky.addColorStop(0,'#080e05'); sky.addColorStop(1,'#0c1a08');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H*.5);
    // Ground
    ctx.fillStyle='#060c05'; ctx.fillRect(0,H*.5,W,H*.5);
    // Horizon line
    ctx.strokeStyle='rgba(0,100,40,.2)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,H*.5); ctx.lineTo(W,H*.5); ctx.stroke();
    // Building silhouettes
    const bldgs=[[.04,.25,.16,.55],[.22,.2,.14,.5],[.42,.1,.22,.65],[.68,.22,.18,.5],[.88,.3,.1,.45]];
    bldgs.forEach(([x,y,w,h])=>{
      ctx.fillStyle='#04090400';
      ctx.fillStyle='rgba(4,9,6,.95)';
      ctx.fillRect(x*W,y*H,w*W,h*H);
      // Lit windows
      for(let wr=0;wr<Math.floor(h*H/16);wr++){
        for(let wc=0;wc<Math.floor(w*W/12);wc++){
          if((wr+wc)%3===0) continue;
          const a=.1+Math.sin(t*.3+wr*wc*.5)*.06;
          ctx.fillStyle=`rgba(255,210,80,${a})`;
          ctx.fillRect((x+.02+wc*.065)*W,(y+.08+wr*.1)*H,W*.04,H*.06);
        }
      }
    });
    // Crane (construction zones)
    if(cam.loc.includes('Zone')||cam.loc.includes('Construction')){
      ctx.strokeStyle='rgba(100,160,80,.35)'; ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(W*.62,H*.68);ctx.lineTo(W*.62,H*.08);ctx.stroke();
      ctx.beginPath();ctx.moveTo(W*.62,H*.1);ctx.lineTo(W*.88,H*.1);ctx.stroke();
      ctx.beginPath();ctx.moveTo(W*.62,H*.15);ctx.lineTo(W*.42,H*.6);ctx.stroke();
    }
    // Fence (perimeter)
    if(cam.loc.includes('Gate')||cam.loc.includes('Perimeter')){
      ctx.strokeStyle='rgba(80,160,60,.2)'; ctx.lineWidth=1;
      for(let fx=0;fx<W;fx+=32){
        ctx.beginPath();ctx.moveTo(fx,H*.62);ctx.lineTo(fx,H*.72);ctx.stroke();
      }
      ctx.beginPath();ctx.moveTo(0,H*.62);ctx.lineTo(W,H*.62);ctx.stroke();
    }
  } else {
    // Interior
    const bg=ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0,'#060d08'); bg.addColorStop(1,'#040a06');
    ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
    // Floor perspective
    ctx.strokeStyle='rgba(30,60,30,.3)'; ctx.lineWidth=.8;
    for(let i=-4;i<=4;i++){
      ctx.beginPath();ctx.moveTo(W/2,H*.42);ctx.lineTo(W/2+i*W*.6,H);ctx.stroke();
    }
    ctx.beginPath();ctx.moveTo(0,H*.42);ctx.lineTo(W,H*.42);ctx.stroke();
    // Walls
    ctx.fillStyle='rgba(10,20,12,.85)';
    ctx.fillRect(0,0,W*.12,H); ctx.fillRect(W*.88,0,W*.12,H);
    // Ceiling lights
    [.25,.5,.75].forEach(lx=>{
      const a=.06+Math.sin(t*.4+lx*4)*.02;
      const gr=ctx.createRadialGradient(lx*W,0,0,lx*W,0,H*.45);
      gr.addColorStop(0,`rgba(160,255,160,${a})`);
      gr.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=gr; ctx.fillRect(0,0,W,H*.45);
    });
    // Occasional figure
    if(Math.sin(t*.25)>.4){
      const px=W*(.28+Math.sin(t*.12)*.12);
      const ph=H*.14;
      ctx.fillStyle='rgba(60,100,60,.5)';
      ctx.fillRect(px-W*.02,H*.42-ph,W*.04,ph);
      ctx.beginPath();ctx.arc(px,H*.42-ph-H*.03,H*.03,0,Math.PI*2);ctx.fill();
    }
  }
  // Timestamp
  ctx.fillStyle='rgba(0,200,80,.7)';
  ctx.font=`${Math.max(10,W/70)}px monospace`; ctx.textAlign='left';
  const ts=`${String(camHr).padStart(2,'0')}:${String(camMin).padStart(2,'0')}:${String(camSec).padStart(2,'0')}`;
  ctx.fillText(`● REC  ${ts}  ${cam.id}`,10,H-10);
}

function drawMotion(ctx,W,H,cam,t){
  const boxes=cam.st==='alert'
    ?[{x:.28,y:.3,w:.18,h:.28,l:'MOTION'},{x:.55,y:.35,w:.14,h:.22,l:'PERSON'}]
    :Math.sin(t*.35)>.55?[{x:.38,y:.3,w:.16,h:.26,l:'MOTION'}]:[];
  boxes.forEach(b=>{
    const a=.5+Math.sin(t*3)*.2;
    ctx.strokeStyle=`rgba(0,255,80,${a})`; ctx.lineWidth=1.5;
    ctx.strokeRect(b.x*W,b.y*H,b.w*W,b.h*H);
    // Corner ticks
    const cs=10;
    [[b.x*W,b.y*H,1,1],[( b.x+b.w)*W,b.y*H,-1,1],[b.x*W,(b.y+b.h)*H,1,-1],[(b.x+b.w)*W,(b.y+b.h)*H,-1,-1]].forEach(([cx,cy,sx,sy])=>{
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+sx*cs,cy);
      ctx.moveTo(cx,cy);ctx.lineTo(cx,cy+sy*cs);ctx.stroke();
    });
    ctx.fillStyle=`rgba(0,255,80,${a})`;
    ctx.font=`${W/65}px monospace`; ctx.textAlign='left';
    ctx.fillText(b.l,b.x*W+2,b.y*H-4);
  });
}

function drawThermal(ctx,W,H,t){
  [{x:.42,y:.42,r:.1,hot:true},{x:.68,y:.5,r:.07,hot:false},{x:.22,y:.6,r:.05,hot:false}].forEach(b=>{
    const gr=ctx.createRadialGradient(b.x*W,b.y*H,0,b.x*W,b.y*H,b.r*W);
    gr.addColorStop(0, b.hot?'rgba(255,50,0,.5)':'rgba(0,80,255,.35)');
    gr.addColorStop(.5, b.hot?'rgba(220,120,0,.2)':'rgba(0,40,200,.15)');
    gr.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=gr; ctx.beginPath();ctx.arc(b.x*W,b.y*H,b.r*W,0,Math.PI*2);ctx.fill();
  });
  ctx.fillStyle='rgba(255,100,0,.7)'; ctx.font='8px monospace'; ctx.textAlign='right';
  ctx.fillText('IR THERMAL',W-8,16);
}

// ── Incidents ────────────────────────────────────
function renderCamIncidents(){
  const COLS={al:'#ff3d3d',wn:'#ffb300',ok:'#00e676'};
  let html='';
  CAM_EVENTS.forEach(e=>{
    const col=COLS[e.st]||'#00e676';
    html+=`<div class="cam-chip ${e.st}" onclick="camSelect('${e.id}')">
      <div class="cam-chip-top">
        <div class="cam-chip-dot" style="background:${col}"></div>
        <span class="cam-chip-id">${e.id}</span>
        <span class="cam-chip-time">${e.time}</span>
      </div>
      <div class="cam-chip-msg">${e.msg}</div>
    </div>`;
  });
  document.getElementById('cam-incidents').innerHTML=html;
}

function camToggleMotion(){
  camMotion=!camMotion;
  document.getElementById('cam-motion-btn').classList.toggle('active',camMotion);
}
function camToggleThermal(){
  camThermal=!camThermal;
  document.getElementById('cam-thermal-btn').classList.toggle('active',camThermal);
}


// ── Responsive drawer system ─────────────────────────────────
function toggleDrawer(cls){
  const el = document.querySelector('.'+cls);
  const overlay = document.getElementById('mob-overlay');
  if(!el) return;
  const isOpen = el.classList.contains('open');
  closeAllDrawers();
  if(!isOpen){
    el.classList.add('open');
    if(overlay) overlay.classList.add('on');
  }
}
function closeAllDrawers(){
  document.querySelectorAll('.dnav,.nleft,.de-left').forEach(el=>el.classList.remove('open'));
  const overlay = document.getElementById('mob-overlay');
  if(overlay) overlay.classList.remove('on');
}
// Close drawer when switching tabs
</script>
</body>
</html>
